<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>Portal de Exames • Torre Digital CTC</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Inicializar EmailJS
        (function(){
            emailjs.init({
                publicKey: "YOUR_PUBLIC_KEY", // Você precisará registrar em https://www.emailjs.com/
            });
        })();
    </script>
    <style>
        /* Dark Mode CSS Variables - shadcn/ui pattern */
        :root {
            /* Light theme colors */
            --background: 255 255 255;
            --foreground: 15 23 42;
            --card: 255 255 255;
            --card-foreground: 15 23 42;
            --popover: 255 255 255;
            --popover-foreground: 15 23 42;
            --primary: 37 99 235;
            --primary-foreground: 248 250 252;
            --secondary: 241 245 249;
            --secondary-foreground: 71 85 105;
            --muted: 248 250 252;
            --muted-foreground: 100 116 139;
            --accent: 248 250 252;
            --accent-foreground: 71 85 105;
            --destructive: 239 68 68;
            --destructive-foreground: 248 250 252;
            --border: 226 232 240;
            --input: 226 232 240;
            --ring: 37 99 235;
            --radius: 0.5rem;
            
            /* Status badge colors - Light theme */
            --success-bg: 34 197 94;
            --success-fg: 255 255 255;
            --warning-bg: 245 158 11;
            --warning-fg: 255 255 255;
            --error-bg: 239 68 68;
            --error-fg: 255 255 255;
            --neutral-bg: 100 116 139;
            --neutral-fg: 255 255 255;
        }

        .dark {
            /* Dark theme colors */
            --background: 2 6 23;
            --foreground: 248 250 252;
            --card: 15 23 42;
            --card-foreground: 248 250 252;
            --popover: 15 23 42;
            --popover-foreground: 248 250 252;
            --primary: 96 165 250;
            --primary-foreground: 15 23 42;
            --secondary: 30 41 59;
            --secondary-foreground: 203 213 225;
            --muted: 30 41 59;
            --muted-foreground: 148 163 184;
            --accent: 30 41 59;
            --accent-foreground: 203 213 225;
            --destructive: 248 113 113;
            --destructive-foreground: 15 23 42;
            --border: 51 65 85;
            --input: 51 65 85;
            --ring: 96 165 250;
            
            /* Status badge colors - Dark theme */
            --success-bg: 34 197 94;
            --success-fg: 15 23 42;
            --warning-bg: 245 158 11;
            --warning-fg: 15 23 42;
            --error-bg: 248 113 113;
            --error-fg: 15 23 42;
            --neutral-bg: 148 163 184;
            --neutral-fg: 15 23 42;
        }

        /* Apply CSS variables to utility classes with !important to override Tailwind */
        .bg-background { background-color: rgb(var(--background)) !important; }
        .text-foreground { color: rgb(var(--foreground)) !important; }
        .bg-card { background-color: rgb(var(--card)) !important; }
        .text-card-foreground { color: rgb(var(--card-foreground)) !important; }
        .bg-popover { background-color: rgb(var(--popover)) !important; }
        .text-popover-foreground { color: rgb(var(--popover-foreground)) !important; }
        .bg-primary { background-color: rgb(var(--primary)) !important; }
        .text-primary { color: rgb(var(--primary)) !important; }
        .text-primary-foreground { color: rgb(var(--primary-foreground)) !important; }
        .bg-secondary { background-color: rgb(var(--secondary)) !important; }
        .text-secondary-foreground { color: rgb(var(--secondary-foreground)) !important; }
        .bg-muted { background-color: rgb(var(--muted)) !important; }
        .text-muted-foreground { color: rgb(var(--muted-foreground)) !important; }
        .bg-accent { background-color: rgb(var(--accent)) !important; }
        .text-accent-foreground { color: rgb(var(--accent-foreground)) !important; }
        .bg-destructive { background-color: rgb(var(--destructive)) !important; }
        .text-destructive-foreground { color: rgb(var(--destructive-foreground)) !important; }
        .border-border { border-color: rgb(var(--border)) !important; }
        .border-input { border-color: rgb(var(--input)) !important; }
        .ring-ring { --tw-ring-color: rgb(var(--ring)) !important; }
        
        /* Status badge classes */
        .badge-success { background-color: rgb(var(--success-bg)) !important; color: rgb(var(--success-fg)) !important; }
        .badge-warning { background-color: rgb(var(--warning-bg)) !important; color: rgb(var(--warning-fg)) !important; }
        .badge-error { background-color: rgb(var(--error-bg)) !important; color: rgb(var(--error-fg)) !important; }
        .badge-neutral { background-color: rgb(var(--neutral-bg)) !important; color: rgb(var(--neutral-fg)) !important; }

        /* Enhanced transitions for dark mode */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
    <script>
        // Initialize theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            let finalTheme = savedTheme;
            
            if (savedTheme === 'system') {
                finalTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            
            const root = document.documentElement;
            root.classList.remove('dark', 'light');
            
            if (finalTheme === 'dark') {
                root.classList.add('dark');
            } else {
                root.classList.add('light');
            }
            
            console.log('Initial theme applied:', finalTheme);
        })();
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cores CTC Institucionais
                        'ctc-blue': {
                            DEFAULT: '#004497',
                            50: '#e6f2ff',
                            100: '#b3daff',
                            200: '#80c2ff',
                            300: '#4daaff',
                            400: '#1a92ff',
                            500: '#004497',
                            600: '#003d85',
                            700: '#003573',
                            800: '#002e61',
                            900: '#00264f'
                        },
                        'ctc-red': {
                            DEFAULT: '#ff3c3c',
                            50: '#fff0f0',
                            100: '#ffd1d1',
                            200: '#ffb3b3',
                            300: '#ff9494',
                            400: '#ff7575',
                            500: '#ff3c3c',
                            600: '#e63333',
                            700: '#cc2a2a',
                            800: '#b32121',
                            900: '#991818'
                        },
                        'torre-digital': {
                            DEFAULT: '#cc0066',
                            50: '#ffeef7',
                            100: '#ffcce6',
                            200: '#ffaad5',
                            300: '#ff88c4',
                            400: '#ff66b3',
                            500: '#cc0066',
                            600: '#b8005c',
                            700: '#a30052',
                            800: '#8f0048',
                            900: '#7a003e'
                        },
                        'torre-itsm': {
                            DEFAULT: '#33cc66',
                            50: '#efffef',
                            100: '#ccffcc',
                            200: '#99ff99',
                            300: '#66ff66',
                            400: '#33ff33',
                            500: '#33cc66',
                            600: '#2eb85c',
                            700: '#29a352',
                            800: '#248f48',
                            900: '#1f7a3e'
                        },
                        'torre-health': {
                            DEFAULT: '#00cdcd',
                            50: '#e6ffff',
                            100: '#b3ffff',
                            200: '#80ffff',
                            300: '#4dffff',
                            400: '#1affff',
                            500: '#00cdcd',
                            600: '#00b8b8',
                            700: '#00a3a3',
                            800: '#008f8f',
                            900: '#007a7a'
                        },
                        // Manter cores do sistema
                        border: "hsl(214.3 31.8% 91.4%)",
                        input: "hsl(214.3 31.8% 91.4%)",
                        ring: "#004497",
                        background: "hsl(0 0% 100%)",
                        foreground: "#004497",
                        primary: {
                            DEFAULT: "#004497",
                            foreground: "hsl(210 40% 98%)",
                        },
                        secondary: {
                            DEFAULT: "#cc0066",
                            foreground: "hsl(210 40% 98%)",
                        },
                        destructive: {
                            DEFAULT: "#ff3c3c",
                            foreground: "hsl(210 40% 98%)",
                        },
                        muted: {
                            DEFAULT: "hsl(210 40% 96%)",
                            foreground: "hsl(215.4 16.3% 46.9%)",
                        },
                        accent: {
                            DEFAULT: "#cc0066",
                            foreground: "hsl(210 40% 98%)",
                        },
                        popover: {
                            DEFAULT: "hsl(0 0% 100%)",
                            foreground: "#004497",
                        },
                        card: {
                            DEFAULT: "hsl(0 0% 100%)",
                            foreground: "#004497",
                        },
                    },
                }
            }
        }
    </script>
    <style>
        .chart-container {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 0.5rem;
        }
        .chart-bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .chart-bar:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }
        .stat-card {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 0.5rem;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }
        .stat-card:hover {
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: hsl(222.2 47.4% 11.2%);
            color: hsl(210 40% 98%);
            border: 1px solid hsl(222.2 47.4% 11.2%);
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background: hsl(222.2 47.4% 9%);
        }
        .btn-secondary {
            background: hsl(210 40% 96%);
            color: hsl(222.2 84% 4.9%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: hsl(210 40% 92%);
        }
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            max-width: 24rem;
        }
        
        /* Loading animations */
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid hsl(222.2 47.4% 11.2%);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Page transitions */
        .page-transition {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card animations */
        .card-hover {
            transition: all 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Button loading state */
        .btn-loading {
            position: relative;
            color: transparent;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Sidebar animations */
        .sidebar-item {
            transition: all 0.2s ease;
            border-radius: 0.5rem;
            margin: 0.25rem 0;
        }
        
        .sidebar-item:hover {
            background: hsl(210 40% 96%);
            transform: translateX(4px);
        }
        
        .sidebar-item.active {
            background: hsl(222.2 47.4% 11.2%);
            color: hsl(210 40% 98%);
        }
        
        /* Modern form inputs */
        .form-input {
            transition: all 0.2s ease;
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            background: hsl(0 0% 100%);
        }
        
        .form-input:focus {
            outline: none;
            border-color: hsl(222.2 47.4% 11.2%);
            box-shadow: 0 0 0 2px hsl(222.2 47.4% 11.2% / 0.1);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        /* Modern shadows */
        .shadow-modern {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .shadow-modern-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const API_BASE_URL = 'http://localhost:3001/api';
        
        function App() {
            const [currentPage, setCurrentPage] = React.useState('login');
            const [isAdminMode, setIsAdminMode] = React.useState(false);
            const [adminUser, setAdminUser] = React.useState(null);
            const [adminData, setAdminData] = React.useState(null);
            const [hospitalSettings, setHospitalSettings] = React.useState({
                name: 'CTC - Centro de Tecnologia Clínica',
                logo: null,
                primaryColor: '#004497', // Azul CTC
                secondaryColor: '#cc0066', // Torre Digital
                accentColor: '#ff3c3c' // Vermelho CTC
            });
            const [messagingConfig, setMessagingConfig] = React.useState({
                email: { provider: 'smtp', config: {} },
                sms: { provider: 'twilio', config: {} },
                whatsapp: { provider: 'twilio', config: {} }
            });
            const [lgpdTerms, setLgpdTerms] = React.useState('');
            const [lgpdTermsContent, setLgpdTermsContent] = React.useState('# Termos de Uso e Política de Privacidade\n\n## 1. Coleta de Dados\n\nColetamos os seguintes dados pessoais:\n\n- **Dados de identificação**: nome, CPF, RG\n- **Dados de contato**: email, telefone, endereço\n- **Dados de saúde**: informações médicas e resultados de exames\n\n## 2. Finalidade do Tratamento\n\nOs dados são utilizados para:\n\n- Prestação de serviços médicos\n- Comunicação com pacientes\n- Cumprimento de obrigações legais\n\n## 3. Direitos dos Titulares\n\nVocê tem direito a:\n\n- **Confirmação da existência** de tratamento\n- **Acesso aos dados** pessoais\n- **Correção** de dados incompletos ou inexatos\n- **Anonimização, bloqueio ou eliminação** de dados desnecessários\n- **Portabilidade** dos dados\n- **Revogação do consentimento**\n\n## 4. Contato\n\nPara exercer seus direitos ou esclarecer dúvidas:\n\n- Email: lgpd@hospital.com.br\n- Telefone: (11) 3000-0000\n- Endereço: Av. Paulista, 1000 - São Paulo/SP');
            const [lgpdPreviewMode, setLgpdPreviewMode] = React.useState(false);
            const [lgpdTermsVersion, setLgpdTermsVersion] = React.useState('v1.0');
            const [lgpdEffectiveDate, setLgpdEffectiveDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [lgpdForceAcceptance, setLgpdForceAcceptance] = React.useState(false);
            const [lgpdShowOnFirstLogin, setLgpdShowOnFirstLogin] = React.useState(true);
            const [lgpdAllowDownload, setLgpdAllowDownload] = React.useState(true);
            const [userGroups, setUserGroups] = React.useState([]);
            
            // Estados para gestão de usuários
            const [adminUsers, setAdminUsers] = React.useState([]);
            const [userFilters, setUserFilters] = React.useState({
                search: '',
                status: 'all',
                group: 'all'
            });
            const [userPagination, setUserPagination] = React.useState({
                page: 1,
                limit: 10,
                total: 0
            });
            const [showUserModal, setShowUserModal] = React.useState(false);
            const [editingUser, setEditingUser] = React.useState(null);
            const [userStats, setUserStats] = React.useState({
                total: 0,
                active: 0,
                blocked: 0,
                groups: 0
            });
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [token, setToken] = React.useState(localStorage.getItem('authToken'));
            const [examsData, setExamsData] = React.useState([]);
            const [selectedExam, setSelectedExam] = React.useState(null);
            const [examDetails, setExamDetails] = React.useState(null);
            const [showShareModal, setShowShareModal] = React.useState(false);
            const [shareForm, setShareForm] = React.useState({
                doctorCrm: '',
                doctorName: '',
                doctorEmail: '',
                message: ''
            });
            const [shareLoading, setShareLoading] = React.useState(false);
            const [shareFormErrors, setShareFormErrors] = React.useState({});
            const [sharedExams, setSharedExams] = React.useState([]);
            const [timelineData, setTimelineData] = React.useState([]);
            const [selectedParameter, setSelectedParameter] = React.useState('Hemoglobina');
            const [timelineMonths, setTimelineMonths] = React.useState(12);
            const [medicalCategory, setMedicalCategory] = React.useState('todas');
            const [resultStatus, setResultStatus] = React.useState('todos');
            const [userSettings, setUserSettings] = React.useState({
                notifications: {
                    email: true,
                    sms: false,
                    push: true
                },
                privacy: {
                    shareWithDoctors: true,
                    allowResearch: false,
                    publicProfile: false
                },
                preferences: {
                    language: 'pt-BR',
                    timezone: 'America/Sao_Paulo',
                    dateFormat: 'DD/MM/YYYY'
                }
            });
            const [dashboardData, setDashboardData] = React.useState(null);
            const [examFilters, setExamFilters] = React.useState({
                type: '',
                status: '',
                startDate: '',
                endDate: ''
            });
            const [filteredExams, setFilteredExams] = React.useState([]);
            const [notifications, setNotifications] = React.useState([]);
            const [showNotifications, setShowNotifications] = React.useState(false);
            const [showUserMenu, setShowUserMenu] = React.useState(false);
            const [uploadModalOpen, setUploadModalOpen] = React.useState(false);
            
            // Dark Mode State Management
            const [theme, setTheme] = React.useState(() => {
                try {
                    return localStorage.getItem('theme') || 'system';
                } catch {
                    return 'system';
                }
            });
            const [uploadProgress, setUploadProgress] = React.useState(0);
            const [delegations, setDelegations] = React.useState([]);
            const [showDelegationModal, setShowDelegationModal] = React.useState(false);
            const [globalLoading, setGlobalLoading] = React.useState(false);
            const [pageTransition, setPageTransition] = React.useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = React.useState(false);
            const [selectedTokenMethod, setSelectedTokenMethod] = React.useState('');
            const [tokenValidating, setTokenValidating] = React.useState(false);
            
            // CPF Mask function
            const applyCPFMask = (value) => {
                return value
                    .replace(/\D/g, '')
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                    .replace(/(-\d{2})\d+?$/, '$1');
            };

            // Breadcrumbs configuration
            const breadcrumbConfig = {
                'dashboard': { label: 'Dashboard', icon: '📊' },
                'exams': { label: 'Meus Exames', icon: '🧾' },
                'shared-exams': { label: 'Exames Compartilhados', icon: '🔗' },
                'timeline': { label: 'Timeline Clínica', icon: '📈' },
                'delegations': { label: 'Delegações Médicas', icon: '👥' },
                'settings': { label: 'Configurações', icon: '⚙️' }
            };
            const [delegationForm, setDelegationForm] = React.useState({
                doctorCrm: '',
                startDate: '',
                endDate: '',
                permissions: {
                    viewExams: true,
                    downloadReports: false,
                    shareExams: false
                }
            });
            const [toasts, setToasts] = React.useState([]);
            const [selectedCategory, setSelectedCategory] = React.useState('all');
            const [searchTerm, setSearchTerm] = React.useState('');
            const [dateFilter, setDateFilter] = React.useState('');
            const [activeExamTab, setActiveExamTab] = React.useState('imagem');
            const [pacsImages, setPacsImages] = React.useState([]);
            const [currentImageIndex, setCurrentImageIndex] = React.useState(0);
            const [dicomViewerUrl, setDicomViewerUrl] = React.useState('');
            const [showDicomViewer, setShowDicomViewer] = React.useState(false);

            const api = axios.create({
                baseURL: API_BASE_URL,
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            });

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                const formData = new FormData(e.target);
                let cpf = formData.get('cpf');
                const password = formData.get('password');
                
                // Remover formatação do CPF
                cpf = cpf.replace(/[^\d]/g, '');

                try {
                    const response = await api.post('/auth/login', { cpf, password });
                    
                    if (response.data.success) {
                        const { data } = response.data;
                        
                        if (data.twoFactorRequired) {
                            setUser({ ...data.patient, tempToken: data.token });
                            setCurrentPage('select-method');
                        } else {
                            setToken(data.token);
                            setUser(data.patient);
                            localStorage.setItem('authToken', data.token);
                            localStorage.setItem('userData', JSON.stringify(data.patient));
                            setCurrentPage('dashboard');
                        }
                    }
                } catch (error) {
                    setError(error.response?.data?.message || 'Erro ao fazer login');
                } finally {
                    setLoading(false);
                }
            };

            const handleMethodSelection = (method) => {
                setSelectedTokenMethod(method);
                setCurrentPage('twofa');
                // Simular envio do token
                addToast(`Código enviado via ${method}!`, 'success');
            };

            const handleTwoFA = async (e) => {
                e.preventDefault();
                setLoading(true);
                setTokenValidating(true);
                setError('');
                
                const formData = new FormData(e.target);
                const code = formData.get('code');

                try {
                    // Simular validação por 2 segundos
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const response = await api.post('/auth/verify-2fa', { 
                        cpf: user.cpf,
                        token: code 
                    });
                    
                    if (response.data.success) {
                        setToken(user.tempToken);
                        localStorage.setItem('authToken', user.tempToken);
                        localStorage.setItem('userData', JSON.stringify(user));
                        setCurrentPage('dashboard');
                        addToast('Login realizado com sucesso!', 'success');
                    }
                } catch (error) {
                    setError(error.response?.data?.message || 'Código inválido');
                } finally {
                    setLoading(false);
                    setTokenValidating(false);
                }
            };

            const loadExams = async () => {
                try {
                    // Dados de exemplo para demonstrar as cores das categorias
                    const sampleExams = [
                        {
                            id: 1,
                            exam_type: "Ressonância Magnética",
                            exam_date: "2025-05-27",
                            status: "completed",
                            doctor_name: "Dr. João Silva",
                            has_images: true
                        },
                        {
                            id: 2,
                            exam_type: "25 HIDROXI - VITAMINA D3, soro",
                            exam_date: "2025-04-28",
                            status: "completed",
                            doctor_name: "Dr. João Guimarães Rosa",
                            has_detailed_report: true,
                            patient_name: "Carlos Drummond de Andrade",
                            attendance_id: "312992",
                            prescription: "41239492",
                            method: "Imunoensaio competitivo quimioluminescente",
                            result_value: "16",
                            result_unit: "ng/mL",
                            reference_ranges: {
                                normal: "30 a 60 ng/mL",
                                insufficient: "20 a 29 ng/mL", 
                                deficient: "inferior a 20 ng/mL"
                            },
                            interpretation: "Deficiente",
                            references: [
                                "Maeda SS e col. Arq Bras Endocrinol Metab. 2014;58 (5): 111.1111.",
                                "TARSILA DO AMARAL - CRM 12304SP"
                            ]
                        },
                        {
                            id: 3,
                            exam_type: "RM Crânio",
                            exam_date: "2025-03-22",
                            status: "completed",
                            doctor_name: "Dr. Carlos Lima"
                        },
                        {
                            id: 4,
                            exam_type: "RM Crânio",
                            exam_date: "2025-02-22",
                            status: "completed",
                            doctor_name: "Dr. Carlos Lima"
                        },
                        {
                            id: 5,
                            exam_type: "Check-up Particular",
                            exam_date: "2025-01-26",
                            status: "completed",
                            doctor_name: "Dr. Roberto Costa",
                            exam_count: 6,
                            is_group: true
                        },
                        {
                            id: 6,
                            exam_type: "Check-up Particular",
                            exam_date: "2024-12-25",
                            status: "completed",
                            doctor_name: "Dr. Roberto Costa",
                            exam_count: 20,
                            is_group: true
                        },
                        {
                            id: 7,
                            exam_type: "Ultrassom Abdominal",
                            exam_date: "2024-11-20",
                            status: "completed",
                            doctor_name: "Dra. Ana Beatriz"
                        },
                        {
                            id: 8,
                            exam_type: "Hemograma Completo",
                            exam_date: "2024-10-15",
                            status: "completed",
                            doctor_name: "Dr. Fernando Oliveira"
                        }
                    ];
                    
                    setExamsData(sampleExams);
                    console.log('Sample exams loaded:', sampleExams);
                    
                    // Código original comentado para desenvolvimento
                    // const response = await api.get('/exams');
                    // if (response.data.success) {
                    //     setExamsData(response.data.data.exams);
                    // }
                } catch (error) {
                    console.error('Error loading exams:', error);
                }
            };

            const loadDashboardData = async () => {
                try {
                    const response = await api.get('/exams/dashboard/stats');
                    if (response.data.success) {
                        setDashboardData(response.data.data);
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    // Usa dados calculados dinamicamente
                    const calculatedData = calculateDashboardData();
                    if (calculatedData) {
                        setDashboardData(calculatedData);
                    } else {
                        // Dados padrão se não houver exames
                        setDashboardData({
                            examStats: { completed: 0, pending: 0, total: 0 },
                            activeShares: sharedExams.filter(share => share.status === 'active').length,
                            recentExams: [],
                            nextExam: null
                        });
                    }
                }
            };

            // Dark Mode Functions - shadcn/ui pattern
            const applyTheme = (newTheme) => {
                const root = document.documentElement;
                console.log('Applying theme:', newTheme);
                
                // Remove existing theme classes
                root.classList.remove('dark', 'light');
                
                let finalTheme = newTheme;
                if (newTheme === 'system') {
                    finalTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                
                // Add the appropriate theme class
                if (finalTheme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.add('light');
                }
                
                console.log('Theme applied:', finalTheme, 'Classes:', root.classList.toString());
                
                // Update theme-color meta tag for mobile browsers
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                if (themeColorMeta) {
                    const isDark = root.classList.contains('dark');
                    themeColorMeta.setAttribute('content', isDark ? '#030712' : '#ffffff');
                }
            };

            const changeTheme = (newTheme) => {
                console.log('Changing theme to:', newTheme);
                
                try {
                    localStorage.setItem('theme', newTheme);
                } catch (e) {
                    console.warn('Unable to save theme to localStorage:', e);
                }
                
                setTheme(newTheme);
                applyTheme(newTheme);
                
                // Toast feedback
                const themeNames = {
                    light: 'Modo Claro',
                    dark: 'Modo Escuro', 
                    system: 'Tema do Sistema'
                };
                addToast(`Tema alterado para: ${themeNames[newTheme]}`, 'success');
            };

            // Initialize theme on component mount
            React.useEffect(() => {
                applyTheme(theme);
                
                // Listen for system theme changes
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleSystemThemeChange = () => {
                    if (theme === 'system') {
                        applyTheme('system');
                    }
                };
                
                mediaQuery.addEventListener('change', handleSystemThemeChange);
                
                return () => {
                    mediaQuery.removeEventListener('change', handleSystemThemeChange);
                };
            }, [theme]);

            const loadExamDetails = async (examId) => {
                try {
                    // Para desenvolvimento, criar dados mockados baseados no exame selecionado
                    let exam = examsData.find(e => e.id === examId);
                    
                    // Se não encontrar o exame específico, usar um exame relacionado ou criar um novo
                    if (!exam && examId) {
                        // Buscar um exame relacionado ao parâmetro selecionado ou usar o primeiro disponível
                        exam = examsData.find(e => 
                            e.exam_type.toLowerCase().includes('laboratorial') || 
                            e.exam_type.toLowerCase().includes('hemograma') ||
                            e.exam_type.toLowerCase().includes('bioquímica')
                        ) || examsData[0];
                        
                        // Se ainda não encontrar, criar um exame mockado
                        if (!exam) {
                            exam = {
                                id: examId,
                                exam_type: `Exame Laboratorial - ${selectedParameter || 'Análise Clínica'}`,
                                exam_date: new Date().toISOString().split('T')[0],
                                status: 'Concluído',
                                doctor_name: 'Dr. João Silva',
                                attendance_id: '312992',
                                patient_name: 'Carlos Drummond de Andrade'
                            };
                        }
                    }
                    
                    if (exam) {
                        // Usar dados detalhados se disponíveis, senão criar mockados
                        const mockExamDetails = {
                            id: exam.id,
                            exam_type: exam.exam_type,
                            exam_date: exam.exam_date,
                            status: exam.status,
                            doctor_name: exam.doctor_name,
                            patient_name: exam.patient_name || "Carlos Drummond de Andrade",
                            attendance_id: exam.attendance_id || "312992",
                            prescription: exam.prescription || "41239492",
                            method: exam.method || "Método padrão",
                            result_value: exam.result_value || "Normal",
                            result_unit: exam.result_unit || "",
                            reference_ranges: exam.reference_ranges || {},
                            interpretation: exam.interpretation || "Normal",
                            references: exam.references || [],
                            has_detailed_report: exam.has_detailed_report || false,
                            notes: exam.notes || `Detalhes do exame ${exam.exam_type} realizado em ${new Date(exam.exam_date).toLocaleDateString('pt-BR')}`,
                            lab_values: exam.exam_type.toLowerCase().includes('hemograma') ? [
                                { parameter: "Glicose", value: "95", unit: "mg/dL", reference_range: "70-100 mg/dL", is_normal: true },
                                { parameter: "Colesterol", value: "180", unit: "mg/dL", reference_range: "< 200 mg/dL", is_normal: true }
                            ] : []
                        };
                        
                        setExamDetails(mockExamDetails);
                        setSelectedExam(examId);
                        setCurrentPage('exam-details');
                        
                        // Adicionar toast de feedback
                        addToast(`Carregando detalhes do exame: ${exam.exam_type}`, 'success');
                        
                        // Carregar imagens PACS se for exame de imagem
                        if (exam.has_images || exam.exam_type.toLowerCase().includes('ressonância') || exam.exam_type.toLowerCase().includes('ultrassom')) {
                            loadPacsImages(exam.exam_type);
                        }
                    }
                    
                    // Código original comentado para desenvolvimento
                    // const response = await api.get(`/exams/${examId}`);
                    // if (response.data.success) {
                    //     setExamDetails(response.data.data);
                    //     setSelectedExam(examId);
                    //     setCurrentPage('exam-details');
                    // }
                } catch (error) {
                    console.error('Error loading exam details:', error);
                    addToast('Erro ao carregar detalhes do exame. Tente novamente.', 'error');
                }
            };

            const loadSharedExams = async () => {
                try {
                    const response = await api.get('/exams/shared');
                    if (response.data.success) {
                        setSharedExams(response.data.data.sharedExams);
                    }
                } catch (error) {
                    console.error('Error loading shared exams:', error);
                    // Usa dados da lista global se disponível
                    if (window.sharedExamsList) {
                        setSharedExams(window.sharedExamsList);
                    }
                }
            };

            const calculateDashboardData = () => {
                if (!examsData || examsData.length === 0) {
                    console.log('calculateDashboardData: No exams data available');
                    return null;
                }
                
                console.log('calculateDashboardData: Processing exams:', examsData.length);
                
                // Calcula estatísticas dos exames
                const completedExams = examsData.filter(exam => exam.status === 'completed').length;
                const pendingExams = examsData.filter(exam => exam.status === 'pending').length;
                const totalExams = examsData.length;
                
                console.log('Dashboard stats:', { completedExams, pendingExams, totalExams });
                
                // Pega exames recentes (últimos 5)
                const recentExams = examsData
                    .sort((a, b) => new Date(b.exam_date) - new Date(a.exam_date))
                    .slice(0, 5);
                
                // Próximo exame (se houver algum futuro)
                const futureExams = examsData.filter(exam => new Date(exam.exam_date) > new Date());
                const nextExam = futureExams.length > 0 ? 
                    futureExams.sort((a, b) => new Date(a.exam_date) - new Date(b.exam_date))[0] : null;
                
                return {
                    examStats: {
                        completed: completedExams,
                        pending: pendingExams,
                        total: totalExams
                    },
                    activeShares: sharedExams.filter(share => share.status === 'active').length,
                    recentExams: recentExams,
                    nextExam: nextExam ? {
                        date: nextExam.exam_date,
                        type: nextExam.exam_type
                    } : null
                };
            };

            const loadTimelineData = async () => {
                try {
                    const response = await api.get(`/exams/timeline?months=${timelineMonths}&parameter=${selectedParameter}`);
                    if (response.data.success) {
                        setTimelineData(response.data.data.timeline);
                    }
                } catch (error) {
                    console.error('Error loading timeline data:', error);
                    // Dados de demonstração para timeline
                    const demoData = generateTimelineDemo(selectedParameter, timelineMonths);
                    setTimelineData(demoData);
                }
            };

            const generateTimelineDemo = (parameter, months) => {
                const data = [];
                const now = new Date();
                
                // 27 comprehensive medical parameters with proper reference ranges
                const referenceRanges = {
                    // 🩸 Hematologia
                    'Hemoglobina': { min: 12.0, max: 15.5, unit: 'g/dL', category: 'hematologia', description: 'Proteína que transporta oxigênio no sangue' },
                    'Hematócrito': { min: 36.0, max: 46.0, unit: '%', category: 'hematologia', description: 'Percentual de células vermelhas no sangue' },
                    'Leucócitos': { min: 4000, max: 11000, unit: '/μL', category: 'hematologia', description: 'Células de defesa do organismo' },
                    'Plaquetas': { min: 150000, max: 450000, unit: '/μL', category: 'hematologia', description: 'Células responsáveis pela coagulação' },
                    'VCM': { min: 80.0, max: 100.0, unit: 'fL', category: 'hematologia', description: 'Volume corpuscular médio das hemácias' },
                    
                    // 🧪 Bioquímica
                    'Glicose': { min: 70, max: 99, unit: 'mg/dL', category: 'bioquimica', description: 'Açúcar no sangue em jejum' },
                    'Creatinina': { min: 0.6, max: 1.2, unit: 'mg/dL', category: 'bioquimica', description: 'Marcador da função renal' },
                    'Ureia': { min: 15, max: 40, unit: 'mg/dL', category: 'bioquimica', description: 'Produto do metabolismo das proteínas' },
                    'Ácido Úrico': { min: 3.5, max: 7.0, unit: 'mg/dL', category: 'bioquimica', description: 'Produto final do metabolismo das purinas' },
                    'Bilirrubina': { min: 0.2, max: 1.0, unit: 'mg/dL', category: 'bioquimica', description: 'Produto da degradação das hemácias' },
                    'TGO': { min: 10, max: 40, unit: 'U/L', category: 'bioquimica', description: 'Enzima hepática (AST)' },
                    'TGP': { min: 10, max: 40, unit: 'U/L', category: 'bioquimica', description: 'Enzima hepática (ALT)' },
                    
                    // 💊 Lipídios
                    'Colesterol Total': { min: 0, max: 200, unit: 'mg/dL', category: 'lipidios', description: 'Colesterol total no sangue' },
                    'HDL': { min: 40, max: 100, unit: 'mg/dL', category: 'lipidios', description: 'Colesterol bom' },
                    'LDL': { min: 0, max: 130, unit: 'mg/dL', category: 'lipidios', description: 'Colesterol ruim' },
                    'Triglicérides': { min: 0, max: 150, unit: 'mg/dL', category: 'lipidios', description: 'Gorduras no sangue' },
                    'VLDL': { min: 0, max: 30, unit: 'mg/dL', category: 'lipidios', description: 'Lipoproteína de muito baixa densidade' },
                    
                    // ⚡ Hormonal
                    'TSH': { min: 0.4, max: 4.0, unit: 'mIU/L', category: 'hormonal', description: 'Hormônio estimulante da tireoide' },
                    'T4 Livre': { min: 0.8, max: 1.8, unit: 'ng/dL', category: 'hormonal', description: 'Hormônio da tireoide livre' },
                    'T3': { min: 80, max: 200, unit: 'ng/dL', category: 'hormonal', description: 'Triiodotironina' },
                    'Cortisol': { min: 5.0, max: 25.0, unit: 'μg/dL', category: 'hormonal', description: 'Hormônio do estresse' },
                    'Insulina': { min: 2.6, max: 24.9, unit: 'μU/mL', category: 'hormonal', description: 'Hormônio regulador da glicose' },
                    'Testosterona': { min: 300, max: 1000, unit: 'ng/dL', category: 'hormonal', description: 'Hormônio sexual masculino' },
                    
                    // ❤️ Cardiovascular
                    'Proteína C Reativa': { min: 0.0, max: 3.0, unit: 'mg/L', category: 'cardiovascular', description: 'Marcador de inflamação' },
                    'Homocisteína': { min: 5.0, max: 15.0, unit: 'μmol/L', category: 'cardiovascular', description: 'Aminoácido relacionado ao risco cardiovascular' },
                    'Troponina': { min: 0.0, max: 0.04, unit: 'ng/mL', category: 'cardiovascular', description: 'Marcador de lesão cardíaca' },
                    'BNP': { min: 0, max: 100, unit: 'pg/mL', category: 'cardiovascular', description: 'Peptídeo natriurético cerebral' },
                    
                    // 🦴 Vitaminas & Minerais
                    'Vitamina D': { min: 30, max: 100, unit: 'ng/mL', category: 'vitaminas', description: '25-hidroxivitamina D' },
                    'Vitamina B12': { min: 200, max: 900, unit: 'pg/mL', category: 'vitaminas', description: 'Cobalamina' },
                    'Ácido Fólico': { min: 3.0, max: 17.0, unit: 'ng/mL', category: 'vitaminas', description: 'Folato sérico' },
                    'Ferro': { min: 60, max: 170, unit: 'μg/dL', category: 'vitaminas', description: 'Ferro sérico' },
                    'Ferritina': { min: 15, max: 300, unit: 'ng/mL', category: 'vitaminas', description: 'Reserva de ferro' },
                    'Cálcio': { min: 8.5, max: 10.5, unit: 'mg/dL', category: 'vitaminas', description: 'Cálcio sérico total' },
                    'Magnésio': { min: 1.8, max: 2.4, unit: 'mg/dL', category: 'vitaminas', description: 'Magnésio sérico' }
                };
                
                const ref = referenceRanges[parameter] || { min: 50, max: 100, unit: 'mg/dL', category: 'geral', description: 'Parâmetro geral' };
                
                // Specialist doctors with CRM numbers
                const doctors = [
                    { name: 'Dr. João Silva', crm: '123456/SP', specialty: 'Cardiologia' },
                    { name: 'Dra. Maria Santos', crm: '234567/RJ', specialty: 'Endocrinologia' },
                    { name: 'Dr. Carlos Lima', crm: '345678/MG', specialty: 'Clínica Geral' },
                    { name: 'Dra. Ana Costa', crm: '456789/RS', specialty: 'Hematologia' },
                    { name: 'Dr. Pedro Oliveira', crm: '567890/PR', specialty: 'Nefrologia' }
                ];
                
                for (let i = 0; i < months; i++) {
                    if (Math.random() > 0.25) { // 75% chance de ter dado
                        const date = new Date(now);
                        date.setMonth(date.getMonth() - i);
                        date.setDate(Math.floor(Math.random() * 28) + 1);
                        
                        // More realistic value generation
                        const baseValue = ref.min + (ref.max - ref.min) * (0.3 + Math.random() * 0.4);
                        const trendFactor = Math.sin(i * 0.1) * 0.1; // Slight trend over time
                        const randomFactor = (Math.random() - 0.5) * 0.3;
                        const value = Math.max(ref.min * 0.3, baseValue * (1 + trendFactor + randomFactor));
                        
                        // Determine status with borderline range
                        let status = 'normal';
                        let isNormal = true;
                        
                        if (value < ref.min * 0.9) {
                            status = 'baixo';
                            isNormal = false;
                        } else if (value > ref.max * 1.1) {
                            status = 'alto';
                            isNormal = false;
                        } else if (value < ref.min || value > ref.max) {
                            status = 'limitrofe';
                            isNormal = false;
                        }
                        
                        // Calculate trend
                        const prevValue = data.length > 0 ? parseFloat(data[data.length - 1].value) : value;
                        let trend = '→';
                        if (value > prevValue * 1.05) trend = '↗';
                        else if (value < prevValue * 0.95) trend = '↘';
                        
                        const doctor = doctors[Math.floor(Math.random() * doctors.length)];
                        
                        data.push({
                            value: value.toFixed(parameter.includes('Leucócitos') || parameter.includes('Plaquetas') ? 0 : 1),
                            unit: ref.unit,
                            reference_range: `${ref.min} - ${ref.max}`,
                            is_normal: isNormal,
                            status: status,
                            trend: trend,
                            date: date.toISOString().split('T')[0],
                            exam_type: 'Exame Laboratorial',
                            exam_id: Math.floor(Math.random() * 1000) + 1,
                            doctor_name: doctor.name,
                            doctor_crm: doctor.crm,
                            doctor_specialty: doctor.specialty,
                            category: ref.category,
                            description: ref.description,
                            risk_level: isNormal ? 'baixo' : (status === 'limitrofe' ? 'medio' : 'alto'),
                            recommendation: generateRecommendation(parameter, value, ref, isNormal)
                        });
                    }
                }
                
                return data.sort((a, b) => new Date(a.date) - new Date(b.date));
            };

            const generateRecommendation = (parameter, value, ref, isNormal) => {
                const recommendations = {
                    'Glicose': {
                        normal: 'Manter dieta equilibrada e atividade física regular.',
                        altered: 'Consultar endocrinologista. Considerar ajustes na dieta e medicação.'
                    },
                    'Colesterol Total': {
                        normal: 'Continuar com hábitos saudáveis de alimentação.',
                        altered: 'Reduzir gorduras saturadas e aumentar exercícios físicos.'
                    },
                    'Hemoglobina': {
                        normal: 'Níveis adequados. Manter alimentação rica em ferro.',
                        altered: 'Investigar possível anemia ou policitemia. Consultar hematologista.'
                    },
                    'Creatinina': {
                        normal: 'Função renal normal. Manter hidratação adequada.',
                        altered: 'Avaliar função renal. Consultar nefrologista se necessário.'
                    },
                    'TSH': {
                        normal: 'Função tireoidiana normal.',
                        altered: 'Avaliar função da tireoide. Consultar endocrinologista.'
                    }
                };
                
                const rec = recommendations[parameter] || {
                    normal: 'Valores dentro do esperado.',
                    altered: 'Consultar médico especialista para avaliação.'
                };
                
                return isNormal ? rec.normal : rec.altered;
            };

            // Helper function to validate form fields
            const validateShareForm = () => {
                const errors = {};
                
                if (!shareForm.doctorCrm.trim()) {
                    errors.doctorCrm = 'CRM é obrigatório';
                } else {
                    const crmRegex = /^\d{4,6}\/[A-Z]{2}$/;
                    if (!crmRegex.test(shareForm.doctorCrm)) {
                        errors.doctorCrm = 'Formato: 000000/UF (ex: 123456/SP)';
                    }
                }
                
                if (!shareForm.doctorName.trim()) {
                    errors.doctorName = 'Nome é obrigatório';
                } else if (shareForm.doctorName.trim().length < 2) {
                    errors.doctorName = 'Nome deve ter pelo menos 2 caracteres';
                }
                
                if (!shareForm.doctorEmail.trim()) {
                    errors.doctorEmail = 'E-mail é obrigatório';
                } else {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(shareForm.doctorEmail)) {
                        errors.doctorEmail = 'E-mail inválido';
                    }
                }
                
                return errors;
            };

            const shareExam = async (examId) => {
                try {
                    setShareLoading(true);
                    
                    // Validate all fields
                    const validationErrors = validateShareForm();
                    if (Object.keys(validationErrors).length > 0) {
                        const firstError = Object.values(validationErrors)[0];
                        addToast(firstError, 'error');
                        setShareLoading(false);
                        return;
                    }
                    
                    addToast('Enviando dados do compartilhamento...', 'info');
                    
                    const response = await api.post('/exams/share', {
                        examId,
                        doctorCrm: shareForm.doctorCrm.trim(),
                        doctorName: shareForm.doctorName.trim(),
                        doctorEmail: shareForm.doctorEmail.trim(),
                        message: shareForm.message.trim()
                    });
                    
                    if (response.data.success) {
                        setShowShareModal(false);
                        setShareForm({ doctorCrm: '', doctorName: '', doctorEmail: '', message: '' });
                        setShareFormErrors({});
                        addToast('Exame compartilhado com sucesso! O médico receberá um e-mail com o link de acesso.', 'success');
                        loadSharedExams(); // Reload shared exams
                        
                        // Additional success feedback
                        if (response.data.shareLink) {
                            console.log('Share link generated:', response.data.shareLink);
                        }
                        if (response.data.expiresAt) {
                            console.log('Share link expires at:', response.data.expiresAt);
                        }
                    } else {
                        addToast('Erro: ' + (response.data.message || 'Não foi possível compartilhar o exame'), 'error');
                    }
                } catch (error) {
                    console.error('Error sharing exam:', error);
                    
                    // More specific error handling
                    if (error.response?.status === 400) {
                        addToast('Dados inválidos: ' + (error.response?.data?.message || 'Verifique os dados informados'), 'error');
                    } else if (error.response?.status === 404) {
                        addToast('Exame não encontrado. Tente novamente.', 'error');
                    } else if (error.response?.status === 403) {
                        addToast('Você não tem permissão para compartilhar este exame', 'error');
                    } else if (error.response?.status === 409) {
                        addToast('Este exame já foi compartilhado com este médico', 'warning');
                    } else if (error.response?.status >= 500) {
                        addToast('Erro interno do servidor. Tente novamente em alguns minutos.', 'error');
                    } else if (error.code === 'NETWORK_ERROR' || !error.response) {
                        addToast('Erro de conexão. Verifique sua internet e tente novamente.', 'error');
                    } else {
                        addToast('Erro ao compartilhar exame: ' + (error.response?.data?.message || error.message), 'error');
                    }
                } finally {
                    setShareLoading(false);
                }
            };

            const downloadExamPDF = async (examId, examType) => {
                try {
                    setLoading(true);
                    const response = await api.get(`/exams/${examId}/pdf`, {
                        responseType: 'blob'
                    });
                    
                    const blob = new Blob([response.data], { type: 'application/pdf' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `exame_${examType}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    addToast('PDF baixado com sucesso!', 'success');
                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    addToast('Erro ao baixar PDF do exame: ' + (error.response?.data?.message || error.message), 'error');
                } finally {
                    setLoading(false);
                }
            };

            const downloadExamReport = async (examId, examType, format = 'pdf') => {
                try {
                    setLoading(true);
                    const response = await api.get(`/exams/${examId}/report?format=${format}`, {
                        responseType: 'blob'
                    });
                    
                    const mimeTypes = {
                        pdf: 'application/pdf',
                        csv: 'text/csv',
                        xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    };
                    
                    const blob = new Blob([response.data], { type: mimeTypes[format] });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `relatorio_${examType}_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    addToast(`Relatório ${format.toUpperCase()} baixado com sucesso!`, 'success');
                } catch (error) {
                    console.error('Error downloading report:', error);
                    addToast('Erro ao baixar relatório: ' + (error.response?.data?.message || error.message), 'error');
                } finally {
                    setLoading(false);
                }
            };

            // URLs reais dos viewers DICOM da Medical Connections
            const dicomViewerUrls = {
                'ressonância': 'https://dicomwebviewer.medicalconnections.co.uk/?studyUID=1.2.826.0.1.3680043.10.1558.250612141200.400',
                'ultrassom': 'https://dicomwebviewer.medicalconnections.co.uk/?studyUID=1.2.826.0.1.3680043.10.1558.250616140346.556',
                'tomografia': 'https://dicomwebviewer.medicalconnections.co.uk/?studyUID=1.2.276.0.7230010.3.1.2.1129722229.5200.1746032911.596',
                'raio-x': 'https://dicomwebviewer.medicalconnections.co.uk/?studyUID=1.2.826.0.1.3680043.10.1558.250612141200.400',
                'mamografia': 'https://dicomwebviewer.medicalconnections.co.uk/?studyUID=1.2.826.0.1.3680043.10.1558.250616140346.556',
                'default': 'https://dicomwebviewer.medicalconnections.co.uk/?studyUID=1.2.276.0.7230010.3.1.2.1129722229.5200.1746032911.596'
            };

            const openPACSViewer = (examId, examType) => {
                // Determinar qual viewer usar baseado no tipo de exame
                let viewerKey = 'default';
                if (examType) {
                    const type = examType.toLowerCase();
                    if (type.includes('ressonância') || type.includes('ressonancia') || type.includes('rm')) {
                        viewerKey = 'ressonância';
                    } else if (type.includes('ultrassom') || type.includes('us') || type.includes('eco')) {
                        viewerKey = 'ultrassom';
                    } else if (type.includes('tomografia') || type.includes('tc') || type.includes('ct')) {
                        viewerKey = 'tomografia';
                    } else if (type.includes('raio') || type.includes('rx') || type.includes('radiografia')) {
                        viewerKey = 'raio-x';
                    } else if (type.includes('mamografia') || type.includes('mammo')) {
                        viewerKey = 'mamografia';
                    }
                }
                
                const pacsUrl = dicomViewerUrls[viewerKey];
                const pacsWindow = window.open(pacsUrl, '_blank', 
                    'width=1400,height=900,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no');
                
                if (!pacsWindow) {
                    addToast('Por favor, permita pop-ups para visualizar as imagens DICOM', 'warning');
                } else {
                    addToast(`Abrindo visualizador DICOM real - ${examType}...`, 'success');
                    // Focar na janela do viewer
                    setTimeout(() => pacsWindow.focus(), 100);
                }
            };

            // Função para carregar visualizador DICOM integrado
            const loadDicomViewer = (examType) => {
                // Determinar qual viewer usar baseado no tipo de exame
                let viewerKey = 'default';
                if (examType) {
                    const type = examType.toLowerCase();
                    if (type.includes('ressonância') || type.includes('ressonancia') || type.includes('rm')) {
                        viewerKey = 'ressonância';
                    } else if (type.includes('ultrassom') || type.includes('us') || type.includes('eco')) {
                        viewerKey = 'ultrassom';
                    } else if (type.includes('tomografia') || type.includes('tc') || type.includes('ct')) {
                        viewerKey = 'tomografia';
                    } else if (type.includes('raio') || type.includes('rx') || type.includes('radiografia')) {
                        viewerKey = 'raio-x';
                    } else if (type.includes('mamografia') || type.includes('mammo')) {
                        viewerKey = 'mamografia';
                    }
                }
                
                const viewerUrl = dicomViewerUrls[viewerKey];
                setDicomViewerUrl(viewerUrl);
                setShowDicomViewer(true);
                setPacsImages([]); // Limpar imagens demo
                addToast(`Carregando visualizador DICOM real - ${examType}...`, 'success');
            };

            // Função para enviar email de compartilhamento
            const sendShareEmail = async (shareData) => {
                try {
                    console.log('Enviando email de compartilhamento...', shareData);
                    
                    // Obter dados do exame
                    const exam = examsData.find(e => e.id == shareData.examId) || {
                        exam_type: 'Exame não encontrado',
                        exam_date: new Date().toISOString(),
                        patient_name: user?.name || 'Paciente'
                    };
                    
                    // Gerar link de acesso
                    const accessLink = `${window.location.origin}/shared-exam/${shareData.id}`;
                    
                    // Template do email
                    const emailTemplate = {
                        service_id: 'default_service', // Você precisa configurar no EmailJS
                        template_id: 'template_exam_share', // Criar template no EmailJS
                        user_id: 'YOUR_PUBLIC_KEY', // Sua chave pública do EmailJS
                        template_params: {
                            to_name: shareData.doctorName,
                            to_email: shareData.doctorEmail,
                            from_name: 'Portal de Exames CTC',
                            from_email: 'noreply@ctc.com.br',
                            patient_name: exam.patient_name,
                            exam_type: exam.exam_type,
                            exam_date: new Date(exam.exam_date).toLocaleDateString('pt-BR'),
                            doctor_crm: shareData.doctorCrm,
                            access_link: accessLink,
                            message: shareData.message || 'Compartilhamento de exame médico.',
                            expiry_date: new Date(shareData.expiresAt).toLocaleDateString('pt-BR'),
                            hospital_name: 'CTC - Centro de Tecnologia Clínica'
                        }
                    };
                    
                    // Simulação de envio (remover quando configurar EmailJS)
                    console.log('📧 DADOS DO EMAIL QUE SERIA ENVIADO:');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log(`Para: ${emailTemplate.template_params.to_email}`);
                    console.log(`Nome: ${emailTemplate.template_params.to_name}`);
                    console.log(`Assunto: Compartilhamento de Exame - ${emailTemplate.template_params.exam_type}`);
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('CONTEÚDO DO EMAIL:');
                    console.log(`
🏥 ${emailTemplate.template_params.hospital_name}
Portal de Exames CTC

Dr(a). ${emailTemplate.template_params.to_name},

Você recebeu um compartilhamento de exame médico.

📋 DETALHES DO EXAME:
• Paciente: ${emailTemplate.template_params.patient_name}
• Tipo de Exame: ${emailTemplate.template_params.exam_type}
• Data de Realização: ${emailTemplate.template_params.exam_date}
• CRM do Médico: ${emailTemplate.template_params.doctor_crm}

📩 MENSAGEM:
${emailTemplate.template_params.message}

🔗 ACESSO AO EXAME:
${emailTemplate.template_params.access_link}

⏰ Este link expira em: ${emailTemplate.template_params.expiry_date}

Para acessar o exame, clique no link acima ou copie e cole no seu navegador.

Atenciosamente,
Equipe Portal de Exames CTC
                    `);
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    
                    // Para usar EmailJS real, descomente a linha abaixo:
                    // const result = await emailjs.send(emailTemplate.service_id, emailTemplate.template_id, emailTemplate.template_params);
                    
                    // Simulação de sucesso
                    addToast(`📧 Email enviado para ${shareData.doctorEmail}`, 'success');
                    return { success: true, message: 'Email enviado com sucesso!' };
                    
                } catch (error) {
                    console.error('Erro ao enviar email:', error);
                    return { success: false, message: 'Erro ao enviar email: ' + error.message };
                }
            };

            // Funções administrativas para gestão de usuários
            const loadAdminUsers = async () => {
                console.log('loadAdminUsers chamada');
                try {
                    setLoading(true);
                    
                    // Criar instância do axios com token administrativo
                    const adminAxios = axios.create({
                        baseURL: API_BASE_URL,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminAuthToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    // Construir query params
                    const params = new URLSearchParams({
                        page: userPagination.page,
                        limit: userPagination.limit,
                        ...(userFilters.search && { search: userFilters.search }),
                        ...(userFilters.status !== 'all' && { status: userFilters.status }),
                        ...(userFilters.group !== 'all' && { group: userFilters.group })
                    });

                    const response = await adminAxios.get(`/admin/users?${params}`);
                    
                    if (response.data.success) {
                        setAdminUsers(response.data.data.usuarios);
                        setUserPagination(prev => ({
                            ...prev,
                            total: response.data.data.pagination.total
                        }));
                        addToast('Usuários carregados com sucesso', 'success');
                    }
                } catch (error) {
                    console.error('Erro ao carregar usuários:', error);
                    
                    // Dados de demonstração caso a API falhe
                    const mockUsers = [
                        {
                            id: 1247,
                            nome: 'João Silva Barbosa',
                            email: 'joao.barbosa@exemplo.com',
                            cpf: '123.456.789-00',
                            telefone: '(11) 99999-1234',
                            data_nascimento: '1985-03-15',
                            ativo: true,
                            grupo: 'paciente',
                            ultimo_login: '2025-06-16T14:32:00',
                            bloqueado_ate: null,
                            tentativas_login: 0,
                            criado_em: '2024-01-15T10:00:00'
                        },
                        {
                            id: 1246,
                            nome: 'Dr. Maria Silva Santos',
                            email: 'maria.silva@hospital.com',
                            cpf: '987.654.321-00',
                            telefone: '(11) 99999-5678',
                            data_nascimento: '1978-07-22',
                            ativo: true,
                            grupo: 'medico',
                            ultimo_login: '2025-06-16T13:15:00',
                            bloqueado_ate: null,
                            tentativas_login: 0,
                            criado_em: '2024-01-10T08:30:00'
                        },
                        {
                            id: 1245,
                            nome: 'Pedro Costa Oliveira',
                            email: 'pedro.costa@exemplo.com',
                            cpf: '456.789.123-00',
                            telefone: '(11) 99999-9012',
                            data_nascimento: '1990-11-08',
                            ativo: false,
                            grupo: 'recepcao',
                            ultimo_login: '2025-06-15T09:22:00',
                            bloqueado_ate: '2025-06-20T09:22:00',
                            tentativas_login: 5,
                            criado_em: '2024-02-20T14:45:00'
                        },
                        {
                            id: 1244,
                            nome: 'Ana Paula Rodriguez',
                            email: 'ana.rodriguez@hospital.com.br',
                            cpf: '789.123.456-00',
                            telefone: '(11) 99999-3456',
                            data_nascimento: '1982-04-30',
                            ativo: true,
                            grupo: 'admin',
                            ultimo_login: '2025-06-16T11:45:00',
                            bloqueado_ate: null,
                            tentativas_login: 0,
                            criado_em: '2024-01-05T12:00:00'
                        },
                        {
                            id: 1243,
                            nome: 'Carlos Eduardo Mendes',
                            email: 'carlos.mendes@exemplo.com',
                            cpf: '321.654.987-00',
                            telefone: '(11) 99999-7890',
                            data_nascimento: '1987-12-03',
                            ativo: true,
                            grupo: 'paciente',
                            ultimo_login: '2025-06-15T16:20:00',
                            bloqueado_ate: null,
                            tentativas_login: 1,
                            criado_em: '2024-03-12T09:15:00'
                        }
                    ];
                    
                    setAdminUsers(mockUsers);
                    setUserPagination(prev => ({
                        ...prev,
                        total: mockUsers.length,
                        totalPages: Math.ceil(mockUsers.length / prev.limit)
                    }));
                    setUserStats({
                        total: mockUsers.length,
                        active: mockUsers.filter(u => u.ativo).length,
                        blocked: mockUsers.filter(u => u.bloqueado_ate && new Date(u.bloqueado_ate) > new Date()).length,
                        groups: 4
                    });
                    
                    addToast('Usando dados de demonstração', 'warning');
                } finally {
                    setLoading(false);
                }
            };

            const toggleUserStatus = async (userId, newStatus) => {
                try {
                    setLoading(true);
                    
                    const adminAxios = axios.create({
                        baseURL: API_BASE_URL,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminAuthToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const response = await adminAxios.put(`/admin/users/${userId}/status`, {
                        ativo: newStatus
                    });
                    
                    if (response.data.success) {
                        // Atualizar usuário na lista local
                        setAdminUsers(prev => prev.map(user => 
                            user.id === userId ? { ...user, ativo: newStatus ? 1 : 0 } : user
                        ));
                        addToast(`Usuário ${newStatus ? 'ativado' : 'desativado'} com sucesso`, 'success');
                    }
                } catch (error) {
                    console.error('Erro ao alterar status do usuário:', error);
                    
                    // Simulação para desenvolvimento
                    setAdminUsers(prev => prev.map(user => 
                        user.id === userId ? { ...user, ativo: newStatus ? 1 : 0 } : user
                    ));
                    addToast(`Usuário ${newStatus ? 'ativado' : 'desativado'} (simulação)`, 'success');
                } finally {
                    setLoading(false);
                }
            };

            const unlockUser = async (userId) => {
                try {
                    setLoading(true);
                    
                    const adminAxios = axios.create({
                        baseURL: API_BASE_URL,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminAuthToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const response = await adminAxios.post(`/admin/users/${userId}/unlock`);
                    
                    if (response.data.success) {
                        // Atualizar usuário na lista local
                        setAdminUsers(prev => prev.map(user => 
                            user.id === userId ? { 
                                ...user, 
                                bloqueado_ate: null, 
                                tentativas_login: 0 
                            } : user
                        ));
                        addToast('Usuário desbloqueado com sucesso', 'success');
                    }
                } catch (error) {
                    console.error('Erro ao desbloquear usuário:', error);
                    
                    // Simulação para desenvolvimento
                    setAdminUsers(prev => prev.map(user => 
                        user.id === userId ? { 
                            ...user, 
                            bloqueado_ate: null, 
                            tentativas_login: 0 
                        } : user
                    ));
                    addToast('Usuário desbloqueado (simulação)', 'success');
                } finally {
                    setLoading(false);
                }
            };

            const saveHospitalSettings = async () => {
                console.log('Salvando configurações do hospital:', hospitalSettings);
                try {
                    setLoading(true);
                    addToast('Salvando configurações...', 'info');
                    
                    const adminAxios = axios.create({
                        baseURL: API_BASE_URL,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminAuthToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const response = await adminAxios.put('/admin/settings/branding', hospitalSettings);
                    
                    if (response.data.success) {
                        addToast('Configurações de marca salvas com sucesso!', 'success');
                    }
                } catch (error) {
                    console.error('Erro ao salvar configurações:', error);
                    
                    // Simulação para desenvolvimento
                    localStorage.setItem('hospitalSettings', JSON.stringify(hospitalSettings));
                    addToast('Configurações salvas localmente (modo simulação)!', 'success');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogoUpload = async (file) => {
                try {
                    setLoading(true);
                    
                    const formData = new FormData();
                    formData.append('logo', file);
                    
                    const adminAxios = axios.create({
                        baseURL: API_BASE_URL,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminAuthToken')}`
                        }
                    });

                    const response = await adminAxios.post('/admin/settings/logo', formData);
                    
                    if (response.data.success) {
                        setHospitalSettings(prev => ({
                            ...prev,
                            logo: response.data.data.logoUrl
                        }));
                        addToast('Logo enviado com sucesso!', 'success');
                    }
                } catch (error) {
                    console.error('Erro ao enviar logo:', error);
                    
                    // Simulação para desenvolvimento
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setHospitalSettings(prev => ({
                            ...prev,
                            logo: e.target.result
                        }));
                    };
                    reader.readAsDataURL(file);
                    addToast('Logo carregado (simulação)', 'success');
                } finally {
                    setLoading(false);
                }
            };

            const loadNotifications = async () => {
                try {
                    const response = await api.get('/notifications');
                    if (response.data.success) {
                        setNotifications(response.data.data.notifications);
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    // Criar algumas notificações de demonstração se falhar
                    setNotifications([
                        {
                            id: 1,
                            title: 'Novo exame disponível',
                            message: 'Seu exame de sangue do dia 10/06 está pronto para visualização',
                            read: false,
                            created_at: '2025-06-15T10:00:00Z'
                        },
                        {
                            id: 2,
                            title: 'Exame compartilhado',
                            message: 'Você compartilhou o exame de ultrassom com Dr. João Silva',
                            read: false,
                            created_at: '2025-06-14T15:30:00Z'
                        },
                        {
                            id: 3,
                            title: 'Delegação criada',
                            message: 'Nova delegação criada para Dr. Maria Santos (CRM: 123456/SP)',
                            read: true,
                            created_at: '2025-06-13T09:15:00Z'
                        }
                    ]);
                }
            };

            const markNotificationAsRead = async (notificationId) => {
                try {
                    await api.patch(`/notifications/${notificationId}/read`);
                    setNotifications(prev => 
                        prev.map(notif => 
                            notif.id === notificationId ? { ...notif, read: true } : notif
                        )
                    );
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            };

            const uploadFile = async (file, examId = null) => {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    let uploadUrl = '/files/upload';
                    if (examId) {
                        uploadUrl = `/exams/${examId}/upload`;
                    }

                    const response = await api.post(uploadUrl, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        },
                        onUploadProgress: (progressEvent) => {
                            const progress = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            setUploadProgress(progress);
                        }
                    });

                    if (response.data.success) {
                        setUploadModalOpen(false);
                        setUploadProgress(0);
                        addToast('Arquivo enviado com sucesso!', 'success');
                        if (examId) {
                            loadExamDetails(examId); // Reload exam details
                        }
                    }
                } catch (error) {
                    console.error('Error uploading file:', error);
                    addToast('Erro ao enviar arquivo: ' + (error.response?.data?.message || error.message), 'error');
                    setUploadProgress(0);
                }
            };

            const loadDelegations = async () => {
                try {
                    const response = await api.get('/delegations');
                    if (response.data.success) {
                        setDelegations(response.data.data.delegations);
                    }
                } catch (error) {
                    console.error('Error loading delegations:', error);
                    // Criar algumas delegações de demonstração se falhar
                    setDelegations([
                        {
                            id: 1,
                            doctor_name: 'João Silva',
                            doctor_crm: '123456/SP',
                            start_date: '2025-06-01',
                            end_date: '2025-12-31',
                            status: 'active',
                            permissions: {
                                viewExams: true,
                                downloadReports: true,
                                shareExams: false
                            },
                            created_at: '2025-06-01T10:00:00Z'
                        },
                        {
                            id: 2,
                            doctor_name: 'Maria Santos',
                            doctor_crm: '789012/SP',
                            start_date: '2025-05-15',
                            end_date: '2025-11-15',
                            status: 'active',
                            permissions: {
                                viewExams: true,
                                downloadReports: false,
                                shareExams: true
                            },
                            created_at: '2025-05-15T14:30:00Z'
                        }
                    ]);
                }
            };

            const createDelegation = async () => {
                try {
                    const response = await api.post('/delegations', delegationForm);
                    if (response.data.success) {
                        setShowDelegationModal(false);
                        setDelegationForm({
                            doctorCrm: '',
                            startDate: '',
                            endDate: '',
                            permissions: {
                                viewExams: true,
                                downloadReports: false,
                                shareExams: false
                            }
                        });
                        loadDelegations();
                        addToast('Delegação criada com sucesso!', 'success');
                    }
                } catch (error) {
                    console.error('Error creating delegation:', error);
                    addToast('Erro ao criar delegação: ' + (error.response?.data?.message || error.message), 'error');
                }
            };

            const revokeDelegation = async (delegationId) => {
                if (confirm('Tem certeza que deseja revogar esta delegação?')) {
                    try {
                        await api.delete(`/delegations/${delegationId}`);
                        loadDelegations();
                        addToast('Delegação revogada com sucesso!', 'success');
                    } catch (error) {
                        console.error('Error revoking delegation:', error);
                        addToast('Erro ao revogar delegação: ' + (error.response?.data?.message || error.message), 'error');
                    }
                }
            };

            // Função para gerar PDF do laudo
            const generateExamPDF = (examData) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configurações
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const lineHeight = 7;
                let yPosition = margin;
                
                // Header do hospital
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('HOSPITAL SANTA PAULA', pageWidth/2, yPosition, { align: 'center' });
                yPosition += lineHeight * 2;
                
                // Informações do paciente
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Paciente: ${examData.patient_name}`, margin, yPosition);
                yPosition += lineHeight;
                doc.text(`Atendimento: ${examData.attendance_id}`, margin, yPosition);
                doc.text(`Data: ${new Date(examData.exam_date).toLocaleDateString('pt-BR')}`, pageWidth - margin - 60, yPosition);
                yPosition += lineHeight * 2;
                
                // Linha separadora
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += lineHeight;
                
                // Título do exame
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(examData.exam_type, margin, yPosition);
                yPosition += lineHeight * 1.5;
                
                // Método
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Método: ${examData.method}`, margin, yPosition);
                yPosition += lineHeight * 2;
                
                // Resultado
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('RESULTADO', margin, yPosition);
                yPosition += lineHeight;
                
                doc.setFont(undefined, 'normal');
                doc.text(`${examData.result_value} ${examData.result_unit}`, margin, yPosition);
                yPosition += lineHeight * 2;
                
                // Valores de referência
                doc.setFont(undefined, 'bold');
                doc.text('VALORES DE REFERÊNCIA', margin, yPosition);
                yPosition += lineHeight;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Normal: ${examData.reference_ranges.normal}`, margin, yPosition);
                yPosition += lineHeight;
                doc.text(`Insuficiente: ${examData.reference_ranges.insufficient}`, margin, yPosition);
                yPosition += lineHeight;
                doc.text(`Deficiente: ${examData.reference_ranges.deficient}`, margin, yPosition);
                yPosition += lineHeight * 2;
                
                // Referências
                if (examData.references) {
                    examData.references.forEach(ref => {
                        doc.setFontSize(8);
                        doc.text(`Ref.: ${ref}`, margin, yPosition);
                        yPosition += lineHeight * 0.8;
                    });
                }
                
                // Linha final
                yPosition += lineHeight;
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += lineHeight;
                
                // Informações finais
                doc.setFontSize(10);
                doc.text(`Data resultado: ${new Date(examData.exam_date).toLocaleDateString('pt-BR')}`, margin, yPosition);
                doc.text(`Atendimento: ${examData.attendance_id}`, pageWidth/2, yPosition);
                doc.text(`Prescrição: ${examData.prescription}`, pageWidth - margin - 60, yPosition);
                
                // Download do PDF
                doc.save(`Laudo_${examData.exam_type.replace(/[^a-zA-Z0-9]/g, '_')}_${examData.patient_name.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
                
                addToast('PDF do laudo gerado com sucesso!', 'success');
            };

            // Simulação de imagens PACS
            const loadPacsImages = (examType) => {
                // Simular diferentes tipos de imagens médicas
                const imageTypes = {
                    'ressonância': [
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgdmlld0JveD0iMCAwIDUwMCA1MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIiBmaWxsPSIjMjAyMDIwIi8+CjxjaXJjbGUgY3g9IjI1MCIgY3k9IjI1MCIgcj0iMTgwIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIgb3BhY2l0eT0iMC44Ii8+CjxlbGxpcHNlIGN4PSIyNTAiIGN5PSIyMDAiIHJ4PSI4MCIgcnk9IjQwIiBmaWxsPSIjNDA0MDQwIiBvcGFjaXR5PSIwLjciLz4KPGVsbGlwc2UgY3g9IjI1MCIgY3k9IjMwMCIgcng9IjYwIiByeT0iMzAiIGZpbGw9IiM2MDYwNjAiIG9wYWNpdHk9IjAuNiIvPgo8Y2lyY2xlIGN4PSIyMDAiIGN5PSIyNDAiIHI9IjE1IiBmaWxsPSIjODA4MDgwIiBvcGFjaXR5PSIwLjgiLz4KPGNpcmNsZSBjeD0iMzAwIiBjeT0iMjYwIiByPSIxMiIgZmlsbD0iIzgwODA4MCIgb3BhY2l0eT0iMC44Ii8+Cjx0ZXh0IHg9IjQwIiB5PSI0NzAiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEyIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIj5STSBDUsOCTklPIC0gQVhJQUw8L3RleHQ+Cjx0ZXh0IHg9IjQwIiB5PSI0ODUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIj5TTElDRSAyNy8xMDA8L3RleHQ+CjwvU3ZnPg==',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgdmlld0JveD0iMCAwIDUwMCA1MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIiBmaWxsPSIjMjAyMDIwIi8+CjxjaXJjbGUgY3g9IjI1MCIgY3k9IjI1MCIgcj0iMTgwIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIgb3BhY2l0eT0iMC44Ii8+CjxlbGxpcHNlIGN4PSIyNTAiIGN5PSIxODAiIHJ4PSI5MCIgcnk9IjUwIiBmaWxsPSIjNDA0MDQwIiBvcGFjaXR5PSIwLjciLz4KPGVsbGlwc2UgY3g9IjI1MCIgY3k9IjMyMCIgcng9IjcwIiByeT0iNDAiIGZpbGw9IiM2MDYwNjAiIG9wYWNpdHk9IjAuNiIvPgo8dGV4dCB4PSI0MCIgeT0iNDcwIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSI+Uk0gQ1LDgk5JTyAtIFNBR0lUQUw8L3RleHQ+Cjx0ZXh0IHg9IjQwIiB5PSI0ODUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEwIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIj5TTElDRSA0NS8xMDA8L3RleHQ+Cjwvc3ZnPg=='
                    ],
                    'ultrassom': [
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDYwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjMUExQTFBIi8+CjxjaXJjbGUgY3g9IjMwMCIgY3k9IjIwMCIgcj0iMTIwIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIgb3BhY2l0eT0iMC43Ii8+CjxjaXJjbGUgY3g9IjI4MCIgY3k9IjE4MCIgcj0iNDAiIGZpbGw9IiM0NDRDNTE4IiBvcGFjaXR5PSIwLjYiLz4KPGVsbGlwc2UgY3g9IjMyMCIgY3k9IjIyMCIgcng9IjYwIiByeT0iMzAiIGZpbGw9IiM2MjYyNjIiIG9wYWNpdHk9IjAuNSIvPgo8dGV4dCB4PSI0NzAiIHk9IjUwIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSI+VUxUUkFTU09NIEFCRE9NSU5BTDwvdGV4dD4KPHR5cGUgeD0iNDcwIiB5PSI3MCIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTIiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiPjI3LzA2LzIwMTk8L3R5cGU+Cjx0ZXh0IHg9IjQ3MCIgeT0iMzgwIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSI+Q1JUQzwvdGV4dD4KPC9zdmc+'
                    ]
                };
                
                const type = examType.toLowerCase().includes('ressonância') ? 'ressonância' : 
                           examType.toLowerCase().includes('ultrassom') ? 'ultrassom' : 'ressonância';
                
                setPacsImages(imageTypes[type] || imageTypes.ressonância);
                setCurrentImageIndex(0);
            };

            React.useEffect(() => {
                if (token && currentPage === 'exams') {
                    loadExams();
                }
                if (token && currentPage === 'dashboard') {
                    // Carrega os exames primeiro se ainda não foram carregados
                    if (examsData.length === 0) {
                        loadExams().then(() => {
                            loadDashboardData();
                        });
                    } else {
                        loadDashboardData();
                    }
                }
                if (token && currentPage === 'shared-exams') {
                    loadSharedExams();
                }
                if (token && currentPage === 'timeline') {
                    loadTimelineData();
                }
                if (token && currentPage === 'delegations') {
                    loadDelegations();
                }
                if (token) {
                    loadNotifications();
                }
            }, [token, currentPage, selectedParameter, timelineMonths]);

            // UseEffect específico para recalcular dashboard quando dados mudam
            React.useEffect(() => {
                if (token && currentPage === 'dashboard' && examsData.length > 0) {
                    const calculatedData = calculateDashboardData();
                    if (calculatedData) {
                        setDashboardData(calculatedData);
                        console.log('Dashboard data updated:', calculatedData);
                    }
                }
            }, [examsData, sharedExams, currentPage, token]);

            React.useEffect(() => {
                // Atualiza referência global para acesso pelas funções HTML
                window.globalExamsData = examsData;
                window.sendShareEmail = sendShareEmail;
                
                if (examsData.length > 0) {
                    let filtered = examsData;
                    
                    if (examFilters.type) {
                        filtered = filtered.filter(exam => 
                            exam.exam_type.toLowerCase().includes(examFilters.type.toLowerCase())
                        );
                    }
                    if (examFilters.status) {
                        filtered = filtered.filter(exam => exam.status === examFilters.status);
                    }
                    if (examFilters.startDate) {
                        filtered = filtered.filter(exam => 
                            new Date(exam.exam_date) >= new Date(examFilters.startDate)
                        );
                    }
                    if (examFilters.endDate) {
                        filtered = filtered.filter(exam => 
                            new Date(exam.exam_date) <= new Date(examFilters.endDate)
                        );
                    }
                    
                    setFilteredExams(filtered);
                } else {
                    setFilteredExams([]);
                }
            }, [examsData, examFilters]);

            React.useEffect(() => {
                const savedToken = localStorage.getItem('authToken');
                const savedUser = localStorage.getItem('userData');
                const savedAdminToken = localStorage.getItem('adminAuthToken');
                const savedAdminUser = localStorage.getItem('adminUserData');
                
                // Verificar login administrativo primeiro
                if (savedAdminToken && savedAdminUser) {
                    setAdminUser(JSON.parse(savedAdminUser));
                    setIsAdminMode(true);
                    setCurrentPage('admin-dashboard');
                    
                    // Carregar configurações salvas
                    const savedHospitalSettings = localStorage.getItem('hospitalSettings');
                    if (savedHospitalSettings) {
                        setHospitalSettings(JSON.parse(savedHospitalSettings));
                    }
                } else if (savedToken && savedUser) {
                    setToken(savedToken);
                    setUser(JSON.parse(savedUser));
                    setCurrentPage('dashboard');
                    // Carrega os exames imediatamente após login
                    setTimeout(() => {
                        loadExams();
                    }, 100);
                }
                
                // Listener para atualizar lista de compartilhamentos
                const handleSharedExamsUpdate = (event) => {
                    const { newShare } = event.detail;
                    setSharedExams(prev => [...prev, newShare]);
                    addToast('Exame adicionado à lista de compartilhados', 'success');
                };
                
                // Listener para criação de usuários via modal HTML
                const handleUserCreated = (event) => {
                    const { userData } = event.detail;
                    setAdminUsers(prev => [userData, ...prev]);
                    setUserPagination(prev => ({ 
                        ...prev, 
                        total: prev.total + 1,
                        totalPages: Math.ceil((prev.total + 1) / prev.limit)
                    }));
                    addToast('Usuário criado com sucesso!', 'success');
                };
                
                // Listener para edição de usuários via modal HTML
                const handleUserUpdated = (event) => {
                    const { userData } = event.detail;
                    setAdminUsers(prev => prev.map(user => 
                        user.id === userData.id ? { ...user, ...userData } : user
                    ));
                    addToast('Usuário atualizado com sucesso!', 'success');
                };
                
                // Listener para salvamento de configurações do hospital
                const handleHospitalSettingsSaved = (event) => {
                    addToast('Configurações do hospital salvas!', 'success');
                };

                const handleLgpdTermsUpdate = (event) => {
                    addToast('Termos LGPD atualizados com sucesso!', 'success');
                };

                const handleLoadLgpdTerms = (event) => {
                    const termsData = event.detail;
                    setLgpdTermsContent(termsData.content || '');
                    setLgpdTermsVersion(termsData.version || 'v1.0');
                    setLgpdEffectiveDate(termsData.effectiveDate || new Date().toISOString().split('T')[0]);
                    setLgpdForceAcceptance(termsData.forceAcceptance || false);
                    setLgpdShowOnFirstLogin(termsData.showOnFirstLogin || true);
                    setLgpdAllowDownload(termsData.allowDownload || true);
                };
                
                window.addEventListener('sharedExamsUpdated', handleSharedExamsUpdate);
                window.addEventListener('userCreated', handleUserCreated);
                window.addEventListener('userUpdated', handleUserUpdated);
                window.addEventListener('hospitalSettingsSaved', handleHospitalSettingsSaved);
                window.addEventListener('lgpdTermsUpdated', handleLgpdTermsUpdate);
                window.addEventListener('loadLgpdTerms', handleLoadLgpdTerms);
                
                return () => {
                    window.removeEventListener('sharedExamsUpdated', handleSharedExamsUpdate);
                    window.removeEventListener('userCreated', handleUserCreated);
                    window.removeEventListener('userUpdated', handleUserUpdated);
                    window.removeEventListener('hospitalSettingsSaved', handleHospitalSettingsSaved);
                    window.removeEventListener('lgpdTermsUpdated', handleLgpdTermsUpdate);
                    window.removeEventListener('loadLgpdTerms', handleLoadLgpdTerms);
                };
            }, []);

            React.useEffect(() => {
                if (token) {
                    api.defaults.headers['Authorization'] = `Bearer ${token}`;
                } else {
                    delete api.defaults.headers['Authorization'];
                }
            }, [token]);

            // useEffect para carregar usuários administrativos quando filtros mudam
            React.useEffect(() => {
                if (isAdminMode && adminUser && currentPage === 'admin-users') {
                    console.log('Carregando usuários da página admin-users');
                    loadAdminUsers();
                }
            }, [isAdminMode, adminUser, currentPage, userFilters, userPagination.page, userPagination.limit]);

            // useEffect para carregar termos LGPD salvos
            React.useEffect(() => {
                if (currentPage === 'admin-lgpd') {
                    loadLGPDTerms();
                }
            }, [currentPage]);

            // Sistema de Toast
            const addToast = (message, type = 'info') => {
                const id = Date.now();
                const toast = { id, message, type };
                setToasts(prev => [...prev, toast]);
                
                // Auto-remover após 4 segundos
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 4000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            // Componente Toast
            const Toast = ({ toast }) => (
                <div className={`toast mb-3 p-4 rounded-lg shadow-lg transition-all duration-300 ${
                    toast.type === 'success' ? 'bg-green-500 text-white' :
                    toast.type === 'error' ? 'bg-red-500 text-white' :
                    toast.type === 'warning' ? 'bg-yellow-500 text-black' :
                    'bg-blue-500 text-white'
                }`}>
                    <div className="flex justify-between items-center">
                        <span>{toast.message}</span>
                        <button 
                            onClick={() => removeToast(toast.id)}
                            className="ml-3 text-lg hover:opacity-75"
                        >
                            ×
                        </button>
                    </div>
                </div>
            );

            const handleLogout = () => {
                setToken(null);
                setUser(null);
                setExamsData([]);
                setDashboardData(null);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                setCurrentPage('login');
            };

            const handleAdminLogout = () => {
                setAdminUser(null);
                setIsAdminMode(false);
                localStorage.removeItem('adminAuthToken');
                localStorage.removeItem('adminUserData');
                setCurrentPage('admin-login');
            };

            // Função de login administrativo
            const handleAdminLogin = async (email, password) => {
                try {
                    setLoading(true);
                    setError('');
                    
                    // Criar uma instância limpa do axios para login admin (sem headers de autenticação)
                    const cleanAxios = axios.create({
                        baseURL: API_BASE_URL,
                        timeout: 10000,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Tentando login administrativo para:', email);
                    
                    // SIMULAÇÃO TEMPORÁRIA - Remover quando backend estiver configurado
                    if (email === 'arthur.ozassa@ctctech.com.br' && password === '123456') {
                        console.log('🔧 Modo de simulação ativado para desenvolvimento');
                        
                        const mockAdminData = {
                            id: 1,
                            nome: 'Arthur Ozassa',
                            email: 'arthur.ozassa@ctctech.com.br',
                            permissoes: 'admin_full'
                        };
                        
                        const mockToken = 'mock_admin_token_' + Date.now();
                        
                        // Salvar dados do admin
                        localStorage.setItem('adminAuthToken', mockToken);
                        localStorage.setItem('adminUserData', JSON.stringify(mockAdminData));
                        
                        setAdminUser(mockAdminData);
                        setIsAdminMode(true);
                        setCurrentPage('admin-dashboard');
                        
                        addToast('Login administrativo realizado com sucesso! (Modo simulação)', 'success');
                        return;
                    }
                    
                    // Fazer requisição para login administrativo
                    const response = await cleanAxios.post('/admin/login', {
                        email,
                        senha: password
                    });
                    
                    if (response.data.success) {
                        const { accessToken, admin } = response.data.data;
                        
                        // Salvar dados do admin
                        localStorage.setItem('adminAuthToken', accessToken);
                        localStorage.setItem('adminUserData', JSON.stringify(admin));
                        
                        setAdminUser(admin);
                        setIsAdminMode(true);
                        setCurrentPage('admin-dashboard');
                        
                        addToast('Login administrativo realizado com sucesso!', 'success');
                    }
                } catch (error) {
                    console.error('Erro no login administrativo:', error);
                    console.error('Detalhes do erro:', {
                        status: error.response?.status,
                        statusText: error.response?.statusText,
                        data: error.response?.data,
                        url: error.config?.url,
                        method: error.config?.method
                    });
                    
                    let errorMessage = 'Erro ao fazer login administrativo';
                    
                    if (error.response?.status === 404) {
                        errorMessage = 'Endpoint administrativo não encontrado. Verifique se o backend está rodando.';
                    } else if (error.response?.status === 401) {
                        errorMessage = 'Credenciais administrativas inválidas.';
                    } else if (error.response?.data?.message) {
                        errorMessage = error.response.data.message;
                    } else if (error.code === 'ECONNREFUSED' || error.message.includes('Network Error')) {
                        errorMessage = 'Não foi possível conectar com o servidor. Verifique se o backend está rodando na porta 3001.';
                    }
                    
                    setError(errorMessage);
                    addToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const Breadcrumb = ({ currentPage }) => {
                const config = breadcrumbConfig[currentPage];
                if (!config) return null;

                return (
                    <nav className="mb-4">
                        <div className="flex items-center space-x-2 text-sm text-muted-foreground">
                            <button 
                                onClick={() => {
                                    setPageTransition(true);
                                    setTimeout(() => {
                                        setCurrentPage('dashboard');
                                        setPageTransition(false);
                                    }, 150);
                                }}
                                className="hover:text-torre-digital transition-colors"
                            >
                                🏠 Início
                            </button>
                            <span className="text-muted-foreground">›</span>
                            <span className="text-card-foreground font-medium flex items-center">
                                {config.icon} {config.label}
                            </span>
                        </div>
                    </nav>
                );
            };

            const Navigation = () => (
                <nav className="bg-card border-b border-border shadow-lg sticky top-0 z-40">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6">
                        <div className="flex justify-between h-14 sm:h-16">
                            <div className="flex items-center space-x-2 sm:space-x-8">
                                <div className="flex items-center space-x-2 sm:space-x-3">
                                    <img 
                                        src="./logos/logo 2.png" 
                                        alt="CTC Logo" 
                                        className="h-6 sm:h-8 w-auto"
                                    />
                                    <div>
                                        <h1 className="text-lg sm:text-xl font-bold text-ctc-blue">Portal de Exames</h1>
                                            </div>
                                </div>
                                
                                {/* Desktop Menu */}
                                <div className="hidden md:flex space-x-4">
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setTimeout(() => {
                                                setCurrentPage('dashboard');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`sidebar-item px-4 py-2 text-sm font-medium ${
                                            currentPage === 'dashboard' 
                                                ? 'active' 
                                                : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        📊 Dashboard
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setTimeout(() => {
                                                setCurrentPage('exams');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`sidebar-item px-4 py-2 text-sm font-medium ${
                                            currentPage === 'exams' 
                                                ? 'active' 
                                                : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        🧾 Exames
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setTimeout(() => {
                                                setCurrentPage('shared-exams');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`sidebar-item px-4 py-2 text-sm font-medium ${
                                            currentPage === 'shared-exams' 
                                                ? 'active' 
                                                : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        🔗 Compartilhados
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setTimeout(() => {
                                                setCurrentPage('timeline');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`sidebar-item px-4 py-2 text-sm font-medium ${
                                            currentPage === 'timeline' 
                                                ? 'active' 
                                                : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        📈 Timeline
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setTimeout(() => {
                                                setCurrentPage('delegations');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`sidebar-item px-4 py-2 text-sm font-medium ${
                                            currentPage === 'delegations' 
                                                ? 'active' 
                                                : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        👥 Delegações
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setTimeout(() => {
                                                setCurrentPage('settings');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`sidebar-item px-4 py-2 text-sm font-medium ${
                                            currentPage === 'settings' 
                                                ? 'active' 
                                                : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        ⚙️ Configurações
                                    </button>
                                </div>
                                
                                {/* Mobile menu button */}
                                <button 
                                    onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                                    className="md:hidden p-3 rounded-lg text-muted-foreground hover:text-torre-digital hover:bg-gray-100 min-h-[48px] min-w-[48px] flex items-center justify-center"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        {mobileMenuOpen ? (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        ) : (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                        )}
                                    </svg>
                                </button>
                            </div>
                            
                            <div className="hidden md:flex items-center space-x-3">
                                {/* Notifications */}
                                <div className="relative">
                                    <button 
                                        onClick={() => setShowNotifications(!showNotifications)}
                                        className="relative p-2 text-muted-foreground hover:text-primary rounded-lg hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="Notificações"
                                        aria-expanded={showNotifications}
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                        </svg>
                                        {notifications.filter(n => !n.read).length > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium">
                                                {notifications.filter(n => !n.read).length}
                                            </span>
                                        )}
                                    </button>
                                    
                                    {showNotifications && (
                                        <div className="absolute right-0 mt-2 w-80 bg-popover rounded-lg shadow-lg border border-border z-50 max-h-96 overflow-y-auto">
                                            <div className="px-4 py-3 border-b border-border">
                                                <h3 className="font-semibold text-popover-foreground">Notificações</h3>
                                            </div>
                                            <div className="py-2">
                                                {notifications.length === 0 ? (
                                                    <div className="px-4 py-3 text-muted-foreground text-sm">
                                                        Nenhuma notificação
                                                    </div>
                                                ) : (
                                                    notifications.map((notification, index) => (
                                                        <div 
                                                            key={index} 
                                                            className={`px-4 py-3 hover:bg-accent cursor-pointer ${
                                                                !notification.read ? 'bg-blue-50 dark:bg-blue-900/20' : ''
                                                            }`}
                                                            onClick={() => markNotificationAsRead(notification.id)}
                                                        >
                                                            <div className="flex justify-between items-start">
                                                                <div className="flex-1">
                                                                    <p className="text-sm font-medium text-popover-foreground">
                                                                        {notification.title}
                                                                    </p>
                                                                    <p className="text-sm text-muted-foreground mt-1">
                                                                        {notification.message}
                                                                    </p>
                                                                    <p className="text-xs text-muted-foreground mt-1">
                                                                        {new Date(notification.created_at).toLocaleDateString('pt-BR')}
                                                                    </p>
                                                                </div>
                                                                {!notification.read && (
                                                                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                {/* Help/Support */}
                                <button 
                                    onClick={() => {
                                        addToast('Central de Ajuda em breve! Entre em contato pelo telefone (11) 3456-7890', 'info');
                                    }}
                                    className="p-2 text-muted-foreground hover:text-primary rounded-lg hover:bg-accent transition-colors focus:outline-none focus:ring-2 focus:ring-primary"
                                    aria-label="Central de Ajuda"
                                    title="Central de Ajuda"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>

                                {/* User Menu */}
                                <div className="relative">
                                    <button 
                                        onClick={() => setShowUserMenu(!showUserMenu)}
                                        className="flex items-center space-x-2 p-2 text-muted-foreground hover:text-primary rounded-lg hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="Menu do usuário"
                                        aria-expanded={showUserMenu}
                                    >
                                        <div className="w-8 h-8 bg-gradient-to-r from-blue-600 to-blue-700 rounded-full flex items-center justify-center ring-2 ring-white shadow-sm">
                                            <span className="text-white text-sm font-medium">
                                                {user?.name?.charAt(0) || 'U'}
                                            </span>
                                        </div>
                                        <div className="hidden lg:block">
                                            <div className="text-sm font-medium text-card-foreground">{user?.name || 'Usuário'}</div>
                                            <div className="text-xs text-muted-foreground">Paciente</div>
                                        </div>
                                        <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={showUserMenu ? "M5 15l7-7 7 7" : "M19 9l-7 7-7-7"} />
                                        </svg>
                                    </button>

                                    {/* User Dropdown Menu */}
                                    {showUserMenu && (
                                        <div className="absolute right-0 mt-2 w-64 bg-popover rounded-lg shadow-lg border border-border z-50">
                                            {/* User Info Header */}
                                            <div className="px-4 py-3 border-b border-border">
                                                <div className="flex items-center space-x-3">
                                                    <div className="w-10 h-10 bg-gradient-to-r from-blue-600 to-blue-700 rounded-full flex items-center justify-center">
                                                        <span className="text-white font-medium">
                                                            {user?.name?.charAt(0) || 'U'}
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <div className="font-medium text-card-foreground">{user?.name || 'Usuário'}</div>
                                                        <div className="text-sm text-muted-foreground">Paciente • CTC Portal</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Menu Items */}
                                            <div className="py-2">
                                                <button
                                                    onClick={() => {
                                                        setCurrentPage('dashboard');
                                                        setShowUserMenu(false);
                                                    }}
                                                    className="w-full px-4 py-2 text-left text-sm text-popover-foreground hover:bg-accent flex items-center space-x-3"
                                                >
                                                    <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5v4m8-4v4" />
                                                    </svg>
                                                    <span>Meu Dashboard</span>
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setCurrentPage('exams');
                                                        setShowUserMenu(false);
                                                    }}
                                                    className="w-full px-4 py-2 text-left text-sm text-popover-foreground hover:bg-accent flex items-center space-x-3"
                                                >
                                                    <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                    <span>Meus Exames</span>
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        addToast('Configurações em desenvolvimento. Use as opções disponíveis no menu principal.', 'info');
                                                        setShowUserMenu(false);
                                                    }}
                                                    className="w-full px-4 py-2 text-left text-sm text-popover-foreground hover:bg-accent flex items-center space-x-3"
                                                >
                                                    <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                    </svg>
                                                    <span>Configurações</span>
                                                </button>

                                                {/* Theme Toggle Section */}
                                                <div className="px-4 py-2">
                                                    <div className="text-xs font-medium text-muted-foreground mb-2">Aparência</div>
                                                    <div className="flex space-x-1 bg-secondary p-1 rounded-lg">
                                                        <button
                                                            onClick={() => {
                                                                console.log('Light theme clicked');
                                                                changeTheme('light');
                                                            }}
                                                            className={`flex-1 px-3 py-2 text-xs rounded-md transition-all duration-200 flex items-center justify-center gap-1 ${
                                                                theme === 'light' 
                                                                ? 'bg-card text-card-foreground shadow-sm font-medium' 
                                                                : 'text-muted-foreground hover:text-card-foreground hover:bg-card/50'
                                                            }`}
                                                            title="Modo Claro"
                                                        >
                                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                                            </svg>
                                                            <span>Claro</span>
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                console.log('Dark theme clicked');
                                                                changeTheme('dark');
                                                            }}
                                                            className={`flex-1 px-3 py-2 text-xs rounded-md transition-all duration-200 flex items-center justify-center gap-1 ${
                                                                theme === 'dark' 
                                                                ? 'bg-card text-card-foreground shadow-sm font-medium' 
                                                                : 'text-muted-foreground hover:text-card-foreground hover:bg-card/50'
                                                            }`}
                                                            title="Modo Escuro"
                                                        >
                                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                                            </svg>
                                                            <span>Escuro</span>
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                console.log('System theme clicked');
                                                                changeTheme('system');
                                                            }}
                                                            className={`flex-1 px-3 py-2 text-xs rounded-md transition-all duration-200 flex items-center justify-center gap-1 ${
                                                                theme === 'system' 
                                                                ? 'bg-card text-card-foreground shadow-sm font-medium' 
                                                                : 'text-muted-foreground hover:text-card-foreground hover:bg-card/50'
                                                            }`}
                                                            title="Tema do Sistema"
                                                        >
                                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                            </svg>
                                                            <span>Auto</span>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="border-t border-border my-2"></div>

                                                <button
                                                    onClick={() => {
                                                        addToast('Suporte: (11) 3456-7890 | email: suporte@ctc.com.br', 'info');
                                                        setShowUserMenu(false);
                                                    }}
                                                    className="w-full px-4 py-2 text-left text-sm text-popover-foreground hover:bg-accent flex items-center space-x-3"
                                                >
                                                    <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192L5.636 18.364M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    <span>Suporte Técnico</span>
                                                </button>

                                                <button 
                                                    onClick={() => {
                                                        handleLogout();
                                                        setShowUserMenu(false);
                                                    }}
                                                    className="w-full px-4 py-2 text-left text-sm text-destructive hover:bg-destructive/10 flex items-center space-x-3"
                                                >
                                                    <svg className="w-4 h-4 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                                    </svg>
                                                    <span>Sair da Conta</span>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        {/* Mobile Menu */}
                        {mobileMenuOpen && (
                            <div className="md:hidden border-t border-border bg-card">
                                <div className="px-4 py-3 space-y-2">
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setMobileMenuOpen(false);
                                            setTimeout(() => {
                                                setCurrentPage('dashboard');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`w-full text-left sidebar-item px-3 py-2 text-sm font-medium ${
                                            currentPage === 'dashboard' ? 'active' : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        📊 Dashboard
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setMobileMenuOpen(false);
                                            setTimeout(() => {
                                                setCurrentPage('exams');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`w-full text-left sidebar-item px-3 py-2 text-sm font-medium ${
                                            currentPage === 'exams' ? 'active' : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        🧾 Exames
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setMobileMenuOpen(false);
                                            setTimeout(() => {
                                                setCurrentPage('shared-exams');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`w-full text-left sidebar-item px-3 py-2 text-sm font-medium ${
                                            currentPage === 'shared-exams' ? 'active' : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        🔗 Compartilhados
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setMobileMenuOpen(false);
                                            setTimeout(() => {
                                                setCurrentPage('timeline');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`w-full text-left sidebar-item px-3 py-2 text-sm font-medium ${
                                            currentPage === 'timeline' ? 'active' : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        📈 Timeline
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setMobileMenuOpen(false);
                                            setTimeout(() => {
                                                setCurrentPage('delegations');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`w-full text-left sidebar-item px-3 py-2 text-sm font-medium ${
                                            currentPage === 'delegations' ? 'active' : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        👥 Delegações
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setPageTransition(true);
                                            setMobileMenuOpen(false);
                                            setTimeout(() => {
                                                setCurrentPage('settings');
                                                setPageTransition(false);
                                            }, 150);
                                        }}
                                        className={`w-full text-left sidebar-item px-3 py-2 text-sm font-medium ${
                                            currentPage === 'settings' ? 'active' : 'text-muted-foreground hover:text-torre-digital'
                                        }`}
                                    >
                                        ⚙️ Configurações
                                    </button>
                                    
                                    <div className="border-t border-border pt-3 mt-3">
                                        {/* User Profile Section */}
                                        <div className="flex items-center px-3 py-2 mb-3">
                                            <div className="w-10 h-10 bg-gradient-to-r from-blue-600 to-blue-700 rounded-full flex items-center justify-center mr-3">
                                                <span className="text-white font-medium">
                                                    {user?.name?.charAt(0) || 'U'}
                                                </span>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium text-card-foreground">{user?.name || 'Usuário'}</div>
                                                <div className="text-xs text-muted-foreground">Paciente • CTC Portal</div>
                                            </div>
                                        </div>

                                        {/* Quick Access Options */}
                                        <div className="space-y-1">
                                            <button
                                                onClick={() => {
                                                    setCurrentPage('dashboard');
                                                    setMobileMenuOpen(false);
                                                }}
                                                className="w-full text-left px-3 py-2 text-sm text-popover-foreground hover:bg-accent flex items-center space-x-3 rounded-lg"
                                            >
                                                <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5v4m8-4v4" />
                                                </svg>
                                                <span>Meu Dashboard</span>
                                            </button>

                                            <button
                                                onClick={() => {
                                                    setCurrentPage('exams');
                                                    setMobileMenuOpen(false);
                                                }}
                                                className="w-full text-left px-3 py-2 text-sm text-popover-foreground hover:bg-accent flex items-center space-x-3 rounded-lg"
                                            >
                                                <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                                <span>Meus Exames</span>
                                            </button>

                                            <button
                                                onClick={() => {
                                                    addToast('Suporte: (11) 3456-7890 | email: suporte@ctc.com.br', 'info');
                                                    setMobileMenuOpen(false);
                                                }}
                                                className="w-full text-left px-3 py-2 text-sm text-popover-foreground hover:bg-accent flex items-center space-x-3 rounded-lg"
                                            >
                                                <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192L5.636 18.364M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span>Suporte Técnico</span>
                                            </button>

                                            <div className="border-t border-border my-2"></div>

                                            <button 
                                                onClick={() => {
                                                    setMobileMenuOpen(false);
                                                    handleLogout();
                                                }}
                                                className="w-full text-left px-3 py-2 text-sm text-destructive hover:bg-destructive/10 flex items-center space-x-3 rounded-lg"
                                            >
                                                <svg className="w-4 h-4 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                                </svg>
                                                <span>Sair da Conta</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </nav>
            );

            // Página de login administrativo
            if (currentPage === 'admin-login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-ctc-blue to-ctc-blue-800 flex items-center justify-center">
                        <div className="max-w-md w-full space-y-8 p-8">
                            <div className="text-center">
                                <img 
                                    src="./logos/logo negativo 1.png" 
                                    alt="CTC Logo" 
                                    className="h-20 w-auto mx-auto mb-6"
                                />
                                <h1 className="text-3xl font-bold text-white mb-2">Portal Administrativo</h1>
                                <p className="text-slate-300 mb-8">Acesso restrito para administradores CTC</p>
                                
                                <div className="bg-card p-8 rounded-2xl shadow-xl">
                                    <form onSubmit={(e) => {
                                        e.preventDefault();
                                        const formData = new FormData(e.target);
                                        handleAdminLogin(formData.get('email'), formData.get('password'));
                                    }} className="space-y-6">
                                        {error && (
                                            <div className="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                                                <p className="text-red-700 text-sm">{error}</p>
                                            </div>
                                        )}
                                        
                                        <div>
                                            <label htmlFor="email" className="block text-sm font-medium text-card-foreground mb-2">
                                                Email Administrativo
                                            </label>
                                            <input
                                                id="email"
                                                name="email"
                                                type="email"
                                                required
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors"
                                                placeholder="admin@hospital.com.br"
                                            />
                                        </div>
                                        
                                        <div>
                                            <label htmlFor="password" className="block text-sm font-medium text-card-foreground mb-2">
                                                Senha
                                            </label>
                                            <input
                                                id="password"
                                                name="password"
                                                type="password"
                                                required
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors"
                                                placeholder="••••••••"
                                            />
                                        </div>
                                        
                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            {loading ? (
                                                <div className="loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                                            ) : (
                                                'Entrar no Painel'
                                            )}
                                        </button>
                                    </form>
                                    
                                    <div className="mt-6 text-center">
                                        <button
                                            onClick={() => setCurrentPage('login')}
                                            className="text-sm text-slate-600 hover:text-slate-800 transition-colors"
                                        >
                                            ← Voltar para área do paciente
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentPage === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="max-w-sm sm:max-w-md w-full space-y-6 sm:space-y-8">
                            <div className="text-center">
                                <div className="mx-auto h-12 w-12 bg-torre-digital rounded-xl flex items-center justify-center mb-4">
                                    <svg className="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div className="text-center mb-4 sm:mb-6">
                                    <img 
                                        src="./logos/logo 2.png" 
                                        alt="CTC Logo" 
                                        className="h-12 sm:h-14 md:h-16 w-auto mx-auto mb-3 sm:mb-4"
                                    />
                                    <h1 className="text-2xl sm:text-3xl font-bold text-ctc-blue mb-2">Portal de Exames</h1>
                                </div>
                                <p className="text-muted-foreground mb-6 sm:mb-8 text-sm sm:text-base">Entre com suas credenciais para acessar seus exames</p>
                                
                                <div className="bg-card p-4 sm:p-6 md:p-8 rounded-2xl shadow-xl">
                                    <form onSubmit={handleLogin} className="space-y-4 sm:space-y-6">
                                        {error && (
                                            <div className="bg-red-50 border-l-4 border-red-400 p-3 sm:p-4 rounded">
                                                <p className="text-red-700 text-sm">{error}</p>
                                            </div>
                                        )}
                                        
                                        <div className="space-y-1">
                                            <label className="block text-sm font-medium text-card-foreground mb-2">CPF</label>
                                            <input 
                                                name="cpf"
                                                type="text" 
                                                required
                                                className="form-input w-full text-base sm:text-sm py-3 sm:py-2 px-3"
                                                placeholder="000.000.000-00"
                                                defaultValue="407.123.018-52"
                                                onChange={(e) => {
                                                    e.target.value = applyCPFMask(e.target.value);
                                                }}
                                                maxLength="14"
                                            />
                                        </div>
                                        
                                        <div className="space-y-1">
                                            <label className="block text-sm font-medium text-card-foreground mb-2">Senha</label>
                                            <input 
                                                name="password"
                                                type="password" 
                                                required
                                                className="form-input w-full text-base sm:text-sm py-3 sm:py-2 px-3"
                                                placeholder="Sua senha"
                                                defaultValue="123456"
                                            />
                                        </div>
                                        
                                        <button 
                                            type="submit" 
                                            disabled={loading}
                                            className={`w-full btn-primary py-4 sm:py-3 px-4 font-medium text-base sm:text-sm min-h-[48px] ${loading ? 'btn-loading' : ''}`}
                                        >
                                            {loading ? '' : 'Entrar'}
                                        </button>
                                    </form>
                                    
                                    <div className="mt-4 sm:mt-6 text-center">
                                        <button
                                            onClick={() => setCurrentPage('admin-login')}
                                            className="text-sm text-red-600 hover:text-red-800 transition-colors font-medium py-2 px-3 min-h-[44px]"
                                        >
                                            🔐 Acesso Administrativo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentPage === 'select-method') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="max-w-md w-full space-y-8 p-8">
                            <div className="text-center">
                                <div className="mx-auto h-12 w-12 bg-torre-digital rounded-xl flex items-center justify-center mb-4">
                                    <svg className="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                </div>
                                <h1 className="text-3xl font-bold text-card-foreground mb-2">Verificação em Duas Etapas</h1>
                                <p className="text-muted-foreground mb-8">Como você gostaria de receber o código de verificação?</p>
                                
                                <div className="bg-card p-8 rounded-2xl shadow-xl">
                                    <div className="space-y-4">
                                        <button 
                                            onClick={() => handleMethodSelection('SMS')}
                                            className="w-full p-4 border border-border rounded-lg hover:border-blue-500 hover:bg-primary/10 transition-all duration-200 text-left group"
                                        >
                                            <div className="flex items-center">
                                                <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition-colors">
                                                    <span className="text-2xl">📱</span>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="font-semibold text-card-foreground">SMS</p>
                                                    <p className="text-sm text-muted-foreground">Receber por mensagem de texto</p>
                                                    <p className="text-xs text-muted-foreground mt-1">+55 (11) ****-{user?.phone?.slice(-4) || '0000'}</p>
                                                </div>
                                            </div>
                                        </button>
                                        
                                        <button 
                                            onClick={() => handleMethodSelection('WhatsApp')}
                                            className="w-full p-4 border border-border rounded-lg hover:border-blue-500 hover:bg-primary/10 transition-all duration-200 text-left group"
                                        >
                                            <div className="flex items-center">
                                                <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition-colors">
                                                    <span className="text-2xl">💬</span>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="font-semibold text-card-foreground">WhatsApp</p>
                                                    <p className="text-sm text-muted-foreground">Receber via WhatsApp</p>
                                                    <p className="text-xs text-muted-foreground mt-1">+55 (11) ****-{user?.phone?.slice(-4) || '0000'}</p>
                                                </div>
                                            </div>
                                        </button>
                                        
                                        <button 
                                            onClick={() => handleMethodSelection('E-mail')}
                                            className="w-full p-4 border border-border rounded-lg hover:border-blue-500 hover:bg-primary/10 transition-all duration-200 text-left group"
                                        >
                                            <div className="flex items-center">
                                                <div className="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                                                    <span className="text-2xl">📧</span>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="font-semibold text-card-foreground">E-mail</p>
                                                    <p className="text-sm text-muted-foreground">Receber por e-mail</p>
                                                    <p className="text-xs text-muted-foreground mt-1">{user?.email?.replace(/(.{2})(.*)(.{4}@.*)/, '$1***$3') || '***@example.com'}</p>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <div className="mt-6 text-center">
                                        <button 
                                            onClick={() => setCurrentPage('login')}
                                            className="text-sm text-primary hover:underline"
                                        >
                                            Voltar ao login
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentPage === 'twofa') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="max-w-md w-full space-y-8 p-8">
                            <div className="text-center">
                                <div className="mx-auto h-12 w-12 bg-torre-digital rounded-xl flex items-center justify-center mb-4">
                                    <svg className="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <h1 className="text-3xl font-bold text-card-foreground mb-2">Verificação em Duas Etapas</h1>
                                <p className="text-muted-foreground mb-2">Digite o código enviado via {selectedTokenMethod}</p>
                                <p className="text-sm text-primary mb-8">
                                    {selectedTokenMethod === 'SMS' && '📱 Mensagem de texto'}
                                    {selectedTokenMethod === 'WhatsApp' && '💬 WhatsApp'}
                                    {selectedTokenMethod === 'E-mail' && '📧 E-mail'}
                                </p>
                                
                                <div className="bg-card p-8 rounded-2xl shadow-xl">
                                    <form onSubmit={handleTwoFA} className="space-y-6">
                                        {error && (
                                            <div className="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                                                <p className="text-red-700 text-sm">{error}</p>
                                            </div>
                                        )}
                                        
                                        <div className="space-y-1">
                                            <label className="block text-sm font-medium text-card-foreground mb-2">
                                                Código de Verificação
                                            </label>
                                            <input 
                                                name="code"
                                                type="text" 
                                                required
                                                className="form-input w-full text-center text-2xl tracking-widest"
                                                placeholder="000000"
                                                maxLength="6"
                                            />
                                        </div>
                                        
                                        <button 
                                            type="submit" 
                                            disabled={loading}
                                            className={`w-full btn-primary py-3 px-4 font-medium ${loading ? 'btn-loading' : ''}`}
                                        >
                                            {loading ? '' : 'Verificar'}
                                        </button>
                                    </form>
                                    
                                    {/* Spinner de validação */}
                                    {tokenValidating && (
                                        <div className="mt-6 flex flex-col items-center">
                                            <div className="loading-spinner mb-3"></div>
                                            <p className="text-sm text-muted-foreground">Validando código...</p>
                                            <div className="w-full bg-gray-200 rounded-full h-2 mt-3">
                                                <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '100%' }}></div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="mt-6 text-center space-y-2">
                                        <button 
                                            onClick={() => setCurrentPage('select-method')}
                                            className="text-sm text-primary hover:underline mr-4"
                                        >
                                            Alterar método
                                        </button>
                                        <button 
                                            onClick={() => setCurrentPage('login')}
                                            className="text-sm text-muted-foreground hover:underline"
                                        >
                                            Voltar ao login
                                        </button>
                                        <p className="text-xs text-muted-foreground mt-2">Código de teste: 123456</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentPage === 'dashboard') {
                return (
                    <div className="min-h-screen bg-background text-foreground">
                        <Navigation />
                        <main className={`max-w-7xl mx-auto py-8 px-4 ${pageTransition ? 'opacity-50' : 'page-transition'}`}>
                            <Breadcrumb currentPage={currentPage} />
                            <div className="mb-8">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-3xl font-bold text-card-foreground">Dashboard</h2>
                                        <p className="text-muted-foreground">Bem-vindo, {user?.name}</p>
                                    </div>
                                    <div className="bg-card p-4 rounded-lg shadow-sm">
                                        <p className="text-sm text-muted-foreground">Último acesso</p>
                                        <p className="font-medium">{new Date().toLocaleDateString('pt-BR')}</p>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                    <div className="bg-card p-6 rounded-xl shadow-modern border border-border card-hover">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-blue-100 dark:bg-blue-900/20 rounded-lg">
                                                <svg className="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                            </div>
                                            <div className="ml-4">
                                                <h3 className="text-lg font-semibold text-card-foreground">Realizados</h3>
                                                <p className="text-3xl font-bold text-primary">
                                                    {dashboardData?.examStats?.completed || 0}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-card p-6 rounded-xl shadow-modern border border-border card-hover">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-orange-100 rounded-lg">
                                                <svg className="w-6 h-6 text-orange-700 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </div>
                                            <div className="ml-4">
                                                <h3 className="text-lg font-semibold text-card-foreground">Pendentes</h3>
                                                <p className="text-3xl font-bold text-orange-700 dark:text-orange-400">
                                                    {dashboardData?.examStats?.pending || 0}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-card p-6 rounded-xl shadow-modern border border-border card-hover">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-green-100 rounded-lg">
                                                <svg className="w-6 h-6 text-green-700 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                            <div className="ml-4">
                                                <h3 className="text-lg font-semibold text-card-foreground">Compartilhados</h3>
                                                <p className="text-3xl font-bold text-green-700 dark:text-green-400">
                                                    {dashboardData?.activeShares || 0}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-card p-6 rounded-xl shadow-modern border border-border card-hover">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-purple-100 rounded-lg">
                                                <svg className="w-6 h-6 text-purple-700 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                            <div className="ml-4">
                                                <h3 className="text-lg font-semibold text-card-foreground">Próximo</h3>
                                                <p className="text-sm font-medium text-purple-700 dark:text-purple-400">
                                                    {dashboardData?.nextExam?.date 
                                                        ? new Date(dashboardData.nextExam.date).toLocaleDateString('pt-BR')
                                                        : 'Nenhum agendado'
                                                    }
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                        <div className="px-6 py-4 border-b border-border">
                                            <h3 className="text-lg font-semibold flex items-center">
                                                <span className="mr-2">📋</span>
                                                Exames Recentes
                                            </h3>
                                        </div>
                                        <div className="p-6">
                                            <div className="space-y-4">
                                                {dashboardData?.recentExams?.length > 0 ? 
                                                    dashboardData.recentExams.map((exam, index) => (
                                                        <div key={index} className="flex justify-between items-center p-4 bg-secondary rounded-lg">
                                                            <div>
                                                                <p className="font-medium">{exam.exam_type}</p>
                                                                <p className="text-sm text-muted-foreground">
                                                                    {new Date(exam.exam_date).toLocaleDateString('pt-BR')}
                                                                </p>
                                                                {exam.doctor_name && (
                                                                    <p className="text-xs text-muted-foreground">{exam.doctor_name}</p>
                                                                )}
                                                            </div>
                                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                                exam.status === 'completed' ? 'badge-success' :
                                                                exam.status === 'pending' ? 'badge-warning' :
                                                                'badge-error'
                                                            }`}>
                                                                {exam.status === 'completed' ? 'Pronto' : 
                                                                 exam.status === 'pending' ? 'Pendente' : 'Cancelado'}
                                                            </span>
                                                        </div>
                                                    )) : 
                                                    <div className="text-center text-muted-foreground py-8">
                                                        Nenhum exame recente encontrado
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    {/* Timeline Resumida - Últimos 6 exames por tipo */}
                                    <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border p-6 card-hover">
                                        <div className="flex items-center justify-between mb-6">
                                            <div>
                                                <h3 className="text-lg font-semibold text-card-foreground">Evolução dos Parâmetros</h3>
                                                <p className="text-sm text-muted-foreground">Últimos 6 meses por tipo de exame</p>
                                            </div>
                                            <button
                                                onClick={() => setCurrentPage('timeline')}
                                                className="text-sm text-primary hover:text-primary/80 font-medium px-3 py-1 rounded-lg hover:bg-primary/10 transition-colors"
                                            >
                                                Ver detalhes →
                                            </button>
                                        </div>

                                        {/* Mini Chart Container */}
                                        <div className="relative h-64">
                                            {(() => {
                                                // Gerar dados dos últimos 6 meses para diferentes tipos de exame
                                                const generateSummaryData = () => {
                                                    const months = [];
                                                    const examTypes = ['Glicose', 'Colesterol', 'Triglicerídeos'];
                                                    
                                                    for (let i = 5; i >= 0; i--) {
                                                        const date = new Date();
                                                        date.setMonth(date.getMonth() - i);
                                                        months.push({
                                                            month: date.toLocaleDateString('pt-BR', { month: 'short' }),
                                                            fullDate: date.toISOString().split('T')[0],
                                                            glicose: Math.floor(Math.random() * 30) + 85, // 85-115
                                                            colesterol: Math.floor(Math.random() * 40) + 160, // 160-200
                                                            triglicerideos: Math.floor(Math.random() * 50) + 100 // 100-150
                                                        });
                                                    }
                                                    return months;
                                                };

                                                const summaryData = generateSummaryData();
                                                const maxGlicose = Math.max(...summaryData.map(d => d.glicose));
                                                const minGlicose = Math.min(...summaryData.map(d => d.glicose));
                                                const maxColesterol = Math.max(...summaryData.map(d => d.colesterol));
                                                const minColesterol = Math.min(...summaryData.map(d => d.colesterol));
                                                const maxTrig = Math.max(...summaryData.map(d => d.triglicerideos));
                                                const minTrig = Math.min(...summaryData.map(d => d.triglicerideos));

                                                // Normalizar dados para o gráfico
                                                const normalizeValue = (value, min, max) => {
                                                    return ((value - min) / (max - min)) * 80 + 10; // 10-90% da altura
                                                };

                                                return (
                                                    <div className="h-full">
                                                        {/* Gráfico SVG */}
                                                        <svg className="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                                                            {/* Grid lines de fundo */}
                                                            <defs>
                                                                <pattern id="gridPattern" x="0" y="0" width="16.67" height="25" patternUnits="userSpaceOnUse">
                                                                    <path d="M 16.67 0 L 0 0 0 25" fill="none" stroke="#f3f4f6" strokeWidth="0.5"/>
                                                                </pattern>
                                                            </defs>
                                                            <rect width="100" height="100" fill="url(#gridPattern)" />

                                                            {/* Linhas para cada parâmetro */}
                                                            {/* Glicose - Azul */}
                                                            <polyline
                                                                points={summaryData.map((d, i) => 
                                                                    `${(i / (summaryData.length - 1)) * 90 + 5},${100 - normalizeValue(d.glicose, minGlicose, maxGlicose)}`
                                                                ).join(' ')}
                                                                fill="none"
                                                                stroke="#3b82f6"
                                                                strokeWidth="1.5"
                                                                strokeLinejoin="round"
                                                            />

                                                            {/* Colesterol - Verde */}
                                                            <polyline
                                                                points={summaryData.map((d, i) => 
                                                                    `${(i / (summaryData.length - 1)) * 90 + 5},${100 - normalizeValue(d.colesterol, minColesterol, maxColesterol)}`
                                                                ).join(' ')}
                                                                fill="none"
                                                                stroke="#10b981"
                                                                strokeWidth="1.5"
                                                                strokeLinejoin="round"
                                                            />

                                                            {/* Triglicerídeos - Laranja */}
                                                            <polyline
                                                                points={summaryData.map((d, i) => 
                                                                    `${(i / (summaryData.length - 1)) * 90 + 5},${100 - normalizeValue(d.triglicerideos, minTrig, maxTrig)}`
                                                                ).join(' ')}
                                                                fill="none"
                                                                stroke="#f59e0b"
                                                                strokeWidth="1.5"
                                                                strokeLinejoin="round"
                                                            />

                                                            {/* Pontos de dados */}
                                                            {summaryData.map((d, i) => (
                                                                <g key={i}>
                                                                    {/* Ponto Glicose */}
                                                                    <circle
                                                                        cx={(i / (summaryData.length - 1)) * 90 + 5}
                                                                        cy={100 - normalizeValue(d.glicose, minGlicose, maxGlicose)}
                                                                        r="1.5"
                                                                        fill="#3b82f6"
                                                                        stroke="white"
                                                                        strokeWidth="1"
                                                                    />
                                                                    {/* Ponto Colesterol */}
                                                                    <circle
                                                                        cx={(i / (summaryData.length - 1)) * 90 + 5}
                                                                        cy={100 - normalizeValue(d.colesterol, minColesterol, maxColesterol)}
                                                                        r="1.5"
                                                                        fill="#10b981"
                                                                        stroke="white"
                                                                        strokeWidth="1"
                                                                    />
                                                                    {/* Ponto Triglicerídeos */}
                                                                    <circle
                                                                        cx={(i / (summaryData.length - 1)) * 90 + 5}
                                                                        cy={100 - normalizeValue(d.triglicerideos, minTrig, maxTrig)}
                                                                        r="1.5"
                                                                        fill="#f59e0b"
                                                                        stroke="white"
                                                                        strokeWidth="1"
                                                                    />
                                                                </g>
                                                            ))}
                                                        </svg>

                                                        {/* Labels dos meses */}
                                                        <div className="absolute -bottom-6 left-0 right-0 flex justify-between text-xs text-muted-foreground">
                                                            {summaryData.map((d, i) => (
                                                                <span key={i}>{d.month}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>

                                        {/* Legenda */}
                                        <div className="flex flex-wrap gap-4 mt-8 pt-4 border-t border-border">
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                                                <span className="text-sm text-muted-foreground">Glicose</span>
                                                <span className="text-xs text-muted-foreground ml-1">(70-100 mg/dL)</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                                <span className="text-sm text-muted-foreground">Colesterol</span>
                                                <span className="text-xs text-muted-foreground ml-1">(&lt;200 mg/dL)</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                                                <span className="text-sm text-muted-foreground">Triglicerídeos</span>
                                                <span className="text-xs text-muted-foreground ml-1">(&lt;150 mg/dL)</span>
                                            </div>
                                        </div>

                                        {/* Resumo rápido */}
                                        <div className="mt-4 grid grid-cols-3 gap-4">
                                            <div className="text-center p-3 bg-blue-50 rounded-lg">
                                                <div className="text-lg font-semibold text-primary">95</div>
                                                <div className="text-xs text-primary">Glicose atual</div>
                                                <div className="text-xs text-white dark:text-green-400 mt-1">✓ Normal</div>
                                            </div>
                                            <div className="text-center p-3 bg-green-50 rounded-lg">
                                                <div className="text-lg font-semibold text-green-700 dark:text-green-400">185</div>
                                                <div className="text-xs text-green-700 dark:text-green-400">Colesterol atual</div>
                                                <div className="text-xs text-white dark:text-green-400 mt-1">✓ Normal</div>
                                            </div>
                                            <div className="text-center p-3 bg-yellow-50 rounded-lg">
                                                <div className="text-lg font-semibold text-yellow-600">140</div>
                                                <div className="text-xs text-yellow-600">Triglicerídeos</div>
                                                <div className="text-xs text-white dark:text-green-400 mt-1">✓ Normal</div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            if (currentPage === 'exams') {
                // Categorizar exames
                const examCategories = {
                    'Exames de Imagem': examsData.filter(exam => 
                        ['ultrassom', 'raio-x', 'tomografia', 'ressonância', 'ecografia', 'rm '].some(type => 
                            exam.exam_type.toLowerCase().includes(type)
                        )
                    ),
                    'Exames Laboratoriais': examsData.filter(exam => 
                        ['hemograma', 'glicemia', 'colesterol', 'sangue', 'urina', 'endoscopia', 'eda'].some(type => 
                            exam.exam_type.toLowerCase().includes(type)
                        )
                    ),
                    'Check-ups': examsData.filter(exam => 
                        ['check-up', 'rotina', 'preventivo'].some(type => 
                            exam.exam_type.toLowerCase().includes(type)
                        )
                    )
                };

                const categoryFilteredExams = selectedCategory === 'all' 
                    ? examsData 
                    : examCategories[selectedCategory] || [];

                const finalFilteredExams = categoryFilteredExams.filter(exam => {
                    const matchesSearch = exam.exam_type.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesDate = !dateFilter || exam.exam_date.includes(dateFilter);
                    return matchesSearch && matchesDate;
                });

                // Função para determinar a categoria e cor do exame
                const getExamCategory = (examType) => {
                    const type = examType.toLowerCase();
                    if (['ultrassom', 'raio-x', 'tomografia', 'ressonância', 'ecografia', 'rm '].some(t => type.includes(t))) {
                        return { category: 'Exames de Imagem', color: 'orange' };
                    }
                    if (['hemograma', 'glicemia', 'colesterol', 'sangue', 'urina', 'endoscopia', 'eda'].some(t => type.includes(t))) {
                        return { category: 'Exames Laboratoriais', color: 'purple' };
                    }
                    return { category: 'Check-ups', color: 'blue' };
                };

                return (
                    <div className="min-h-screen bg-background text-foreground">
                        <Navigation />
                        <main className={`max-w-7xl mx-auto py-8 px-4 ${pageTransition ? 'opacity-50' : 'page-transition'}`}>
                            <Breadcrumb currentPage={currentPage} />
                            <div className="mb-8">
                                <h2 className="text-3xl font-bold text-card-foreground mb-3">Seus exames realizados</h2>
                                <p className="text-muted-foreground mb-8">
                                    Aqui você poderá consultar seus exames realizados. Se disponível, poderá também visualizar o resultado e compartilhá-lo com seus familiares e médicos.
                                </p>
                                
                                {/* Filtros Modernos */}
                                <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover mb-8">
                                    <div className="p-6">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <select
                                                    value={selectedCategory}
                                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                                    className="form-input w-full"
                                                >
                                                    <option value="all">Todas as categorias</option>
                                                    <option value="Exames de Imagem">Exames de Imagem</option>
                                                    <option value="Exames Laboratoriais">Exames Laboratoriais</option>
                                                    <option value="Check-ups">Check-ups</option>
                                                </select>
                                            </div>
                                            <div>
                                                <input
                                                    type="date"
                                                    value={dateFilter}
                                                    onChange={(e) => setDateFilter(e.target.value)}
                                                    className="form-input w-full"
                                                    placeholder="dd/mm/aaaa"
                                                />
                                            </div>
                                            <div>
                                                <input
                                                    type="text"
                                                    value={searchTerm}
                                                    onChange={(e) => setSearchTerm(e.target.value)}
                                                    className="form-input w-full"
                                                    placeholder="Buscar..."
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Cards de Categoria */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div className="bg-card rounded-xl shadow-modern border border-orange-200 card-hover">
                                        <div className="p-6 border-l-4 border-orange-400">
                                            <h3 className="text-lg font-semibold text-card-foreground mb-2">EXAMES DE IMAGEM E MÉTODOS</h3>
                                            <p className="text-sm text-muted-foreground mb-4">
                                                Total de procedimentos: {examCategories['Exames de Imagem'].length}
                                            </p>
                                            <button
                                                onClick={() => setSelectedCategory(selectedCategory === 'Exames de Imagem' ? 'all' : 'Exames de Imagem')}
                                                className={`w-full py-2 px-4 rounded-lg border transition-colors ${
                                                    selectedCategory === 'Exames de Imagem'
                                                        ? 'bg-orange-500 text-white border-orange-500'
                                                        : 'bg-card text-orange-500 border-orange-300 hover:bg-orange-50'
                                                }`}
                                            >
                                                {selectedCategory === 'Exames de Imagem' ? 'Selecionado' : 'Selecionar'}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-card rounded-xl shadow-modern border border-purple-200 card-hover">
                                        <div className="p-6 border-l-4 border-purple-400">
                                            <h3 className="text-lg font-semibold text-card-foreground mb-2">EXAMES LABORATORIAIS</h3>
                                            <p className="text-sm text-muted-foreground mb-4">
                                                Total de procedimentos: {examCategories['Exames Laboratoriais'].length}
                                            </p>
                                            <button
                                                onClick={() => setSelectedCategory(selectedCategory === 'Exames Laboratoriais' ? 'all' : 'Exames Laboratoriais')}
                                                className={`w-full py-2 px-4 rounded-lg border transition-colors ${
                                                    selectedCategory === 'Exames Laboratoriais'
                                                        ? 'bg-purple-500 text-white border-purple-500'
                                                        : 'bg-card text-purple-500 border-purple-300 hover:bg-purple-50'
                                                }`}
                                            >
                                                {selectedCategory === 'Exames Laboratoriais' ? 'Selecionado' : 'Selecionar'}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-card rounded-xl shadow-modern border border-blue-200 card-hover">
                                        <div className="p-6 border-l-4 border-blue-400">
                                            <h3 className="text-lg font-semibold text-card-foreground mb-2">CHECK-UPS</h3>
                                            <p className="text-sm text-muted-foreground mb-4">
                                                Total de procedimentos: {examCategories['Check-ups'].length}
                                            </p>
                                            <button
                                                onClick={() => setSelectedCategory(selectedCategory === 'Check-ups' ? 'all' : 'Check-ups')}
                                                className={`w-full py-2 px-4 rounded-lg border transition-colors ${
                                                    selectedCategory === 'Check-ups'
                                                        ? 'bg-blue-500 text-white border-blue-500'
                                                        : 'bg-card text-blue-500 border-blue-300 hover:bg-primary/10'
                                                }`}
                                            >
                                                {selectedCategory === 'Check-ups' ? 'Selecionado' : 'Selecionar'}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Lista de Exames - Responsiva */}
                                <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                    {/* Desktop Table View */}
                                    <div className="hidden md:block overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-secondary border-b border-border">
                                                <tr>
                                                    <th className="px-4 lg:px-6 py-3 lg:py-4 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Realizado em</th>
                                                    <th className="px-4 lg:px-6 py-3 lg:py-4 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Nome do Exame</th>
                                                    <th className="px-4 lg:px-6 py-3 lg:py-4 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Tipo do Atendimento</th>
                                                    <th className="px-4 lg:px-6 py-3 lg:py-4 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Unidade</th>
                                                    <th className="px-4 lg:px-6 py-3 lg:py-4 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Ação</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-card divide-y divide-gray-200">
                                                {(finalFilteredExams.length > 0 ? finalFilteredExams : examsData).length === 0 ? (
                                                    <tr>
                                                        <td colSpan="5" className="px-6 py-8 text-center text-muted-foreground">
                                                            {loading ? 'Carregando exames...' : 'Nenhum exame encontrado'}
                                                        </td>
                                                    </tr>
                                                ) : (
                                                    (finalFilteredExams.length > 0 ? finalFilteredExams : examsData).map((exam) => {
                                                        const examCategory = getExamCategory(exam.exam_type);
                                                        const colorClasses = {
                                                            orange: 'border-l-4 border-orange-500',
                                                            purple: 'border-l-4 border-purple-500', 
                                                            blue: 'border-l-4 border-blue-500'
                                                        };
                                                        
                                                        return (
                                                            <tr key={exam.id} className={`hover:bg-secondary ${colorClasses[examCategory.color]}`}>
                                                                <td className="px-4 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                                    <div className="text-sm text-card-foreground">
                                                                        {new Date(exam.exam_date).toLocaleDateString('pt-BR')}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 lg:px-6 py-3 lg:py-4">
                                                                    <div className="text-sm font-medium text-card-foreground">
                                                                        {exam.exam_type}
                                                                        {exam.is_group && exam.exam_count && (
                                                                            <div className="flex items-center mt-1">
                                                                                <svg className="w-4 h-4 text-muted-foreground mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                                                                </svg>
                                                                                <span className="text-xs text-muted-foreground">{exam.exam_count} exames</span>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                                    <div className="text-sm text-card-foreground">Ambulatorial</div>
                                                                </td>
                                                                <td className="px-4 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                                    <div className="text-sm text-card-foreground">Unidade Paulista</div>
                                                                </td>
                                                                <td className="px-4 lg:px-6 py-3 lg:py-4 whitespace-nowrap text-sm font-medium">
                                                                    <div className="flex space-x-3">
                                                                        {exam.is_group ? (
                                                                            <button 
                                                                                onClick={() => {
                                                                                    addToast(`Visualizando ${exam.exam_count} exames do ${exam.exam_type}`, 'info');
                                                                                }}
                                                                                className="inline-flex items-center text-teal-600 hover:text-teal-800 font-medium text-sm"
                                                                                title="Ver todos os exames"
                                                                            >
                                                                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                                                                </svg>
                                                                                Todos
                                                                            </button>
                                                                        ) : (
                                                                            <button 
                                                                                onClick={() => {
                                                                                    console.log('Resultado button clicked for exam:', exam);
                                                                                    loadExamDetails(exam.id);
                                                                                    addToast(`Carregando detalhes do exame: ${exam.exam_type}`, 'success');
                                                                                }}
                                                                                className="inline-flex items-center text-teal-600 hover:text-teal-800 font-medium text-sm"
                                                                                title="Ver resultado"
                                                                            >
                                                                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                                                </svg>
                                                                                Resultado
                                                                            </button>
                                                                        )}
                                                                        <button 
                                                                            onClick={() => {
                                                                                document.getElementById('shareModal').style.display = 'flex';
                                                                                document.getElementById('shareExamId').textContent = exam.id;
                                                                            }}
                                                                            className="inline-flex items-center text-teal-600 hover:text-teal-800 font-medium text-sm"
                                                                            title="Compartilhar resultado"
                                                                        >
                                                                            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                                                                            </svg>
                                                                            Compartilhar
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    {/* Mobile Card View */}
                                    <div className="md:hidden space-y-4 p-4">
                                        {(finalFilteredExams.length > 0 ? finalFilteredExams : examsData).length === 0 ? (
                                            <div className="text-center py-8 text-muted-foreground">
                                                {loading ? 'Carregando exames...' : 'Nenhum exame encontrado'}
                                            </div>
                                        ) : (
                                            (finalFilteredExams.length > 0 ? finalFilteredExams : examsData).map((exam) => {
                                                const examCategory = getExamCategory(exam.exam_type);
                                                const colorClasses = {
                                                    orange: 'border-l-4 border-orange-500 bg-orange-50',
                                                    purple: 'border-l-4 border-purple-500 bg-purple-50', 
                                                    blue: 'border-l-4 border-blue-500 bg-blue-50'
                                                };
                                                
                                                return (
                                                    <div key={exam.id} className={`bg-card rounded-lg border border-border shadow-sm ${colorClasses[examCategory.color]} p-4`}>
                                                        {/* Card Header */}
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div className="flex-1">
                                                                <h3 className="text-base font-semibold text-card-foreground leading-tight mb-1">
                                                                    {exam.exam_type}
                                                                </h3>
                                                                {exam.is_group && exam.exam_count && (
                                                                    <div className="flex items-center mt-1">
                                                                        <svg className="w-4 h-4 text-muted-foreground mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                                                        </svg>
                                                                        <span className="text-xs text-muted-foreground">{exam.exam_count} exames</span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-sm font-medium text-card-foreground">
                                                                    {new Date(exam.exam_date).toLocaleDateString('pt-BR')}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Card Details */}
                                                        <div className="space-y-2 mb-4">
                                                            <div className="flex justify-between text-sm">
                                                                <span className="text-muted-foreground">Tipo:</span>
                                                                <span className="text-card-foreground">Ambulatorial</span>
                                                            </div>
                                                            <div className="flex justify-between text-sm">
                                                                <span className="text-muted-foreground">Unidade:</span>
                                                                <span className="text-card-foreground">Unidade Paulista</span>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Card Actions */}
                                                        <div className="flex flex-col space-y-2">
                                                            <div className="flex space-x-2">
                                                                {exam.is_group ? (
                                                                    <button 
                                                                        onClick={() => {
                                                                            addToast(`Visualizando ${exam.exam_count} exames do ${exam.exam_type}`, 'info');
                                                                        }}
                                                                        className="flex-1 inline-flex items-center justify-center bg-teal-600 text-white px-4 py-3 rounded-lg font-medium text-sm min-h-[48px] hover:bg-teal-700 transition-colors"
                                                                        title="Ver todos os exames"
                                                                    >
                                                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                                                        </svg>
                                                                        Ver Todos
                                                                    </button>
                                                                ) : (
                                                                    <button 
                                                                        onClick={() => {
                                                                            console.log('Resultado button clicked for exam:', exam);
                                                                            loadExamDetails(exam.id);
                                                                            addToast(`Carregando detalhes do exame: ${exam.exam_type}`, 'success');
                                                                        }}
                                                                        className="flex-1 inline-flex items-center justify-center bg-teal-600 text-white px-4 py-3 rounded-lg font-medium text-sm min-h-[48px] hover:bg-teal-700 transition-colors"
                                                                        title="Ver resultado"
                                                                    >
                                                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                                        </svg>
                                                                        Ver Resultado
                                                                    </button>
                                                                )}
                                                                <button 
                                                                    onClick={() => {
                                                                        document.getElementById('shareModal').style.display = 'flex';
                                                                        document.getElementById('shareExamId').textContent = exam.id;
                                                                    }}
                                                                    className="bg-gray-100 text-card-foreground px-4 py-3 rounded-lg font-medium text-sm min-h-[48px] hover:bg-gray-200 transition-colors flex items-center justify-center"
                                                                    title="Compartilhar resultado"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            if (currentPage === 'exam-details' && examDetails) {
                return (
                    <div className="min-h-screen bg-background text-foreground">
                        <Navigation />
                        <main className="max-w-7xl mx-auto py-8 px-4">
                            {/* Breadcrumb Navigation */}
                            <nav className="mb-6">
                                <div className="flex items-center space-x-2 text-sm text-muted-foreground">
                                    <button 
                                        onClick={() => setCurrentPage('exams')}
                                        className="hover:text-torre-digital transition-colors"
                                    >
                                        Lista de exames
                                    </button>
                                    <span className="text-muted-foreground">›</span>
                                    <span className="text-card-foreground font-medium">Check-up</span>
                                    <span className="text-muted-foreground">›</span>
                                    <span className="text-card-foreground font-medium">Resultado</span>
                                </div>
                            </nav>

                            {/* Exam Header */}
                            <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border mb-6">
                                <div className="px-6 py-4 border-b border-border">
                                    <div className="flex items-center justify-between">
                                        <h1 className="text-2xl font-bold text-card-foreground uppercase">{examDetails.exam_type}</h1>
                                        <button 
                                            onClick={() => {
                                                if (examDetails.has_detailed_report) {
                                                    generateExamPDF(examDetails);
                                                } else {
                                                    addToast('Download iniciado', 'success');
                                                }
                                            }}
                                            className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                        >
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="px-6 py-4">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 text-sm">
                                        <div>
                                            <span className="text-muted-foreground">Realizado em:</span>
                                            <p className="font-medium text-card-foreground">{new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}</p>
                                        </div>
                                        <div>
                                            <span className="text-muted-foreground">Unidade:</span>
                                            <p className="font-medium text-card-foreground">Paulista</p>
                                        </div>
                                        <div>
                                            <span className="text-muted-foreground">Atendimento:</span>
                                            <p className="font-medium text-card-foreground">220904</p>
                                        </div>
                                        <div>
                                            <span className="text-muted-foreground">Informação:</span>
                                            <p className="font-medium text-card-foreground">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer tellus mauris at cursus.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Tabs */}
                            <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border">
                                <div className="border-b border-border">
                                    <nav className="flex space-x-8 px-6">
                                        <button
                                            onClick={() => setActiveExamTab('imagem')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                                                activeExamTab === 'imagem'
                                                    ? 'border-blue-500 text-primary'
                                                    : 'border-transparent text-muted-foreground hover:text-card-foreground hover:border-gray-300'
                                            }`}
                                        >
                                            Imagem
                                        </button>
                                        <button
                                            onClick={() => setActiveExamTab('laudo')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                                                activeExamTab === 'laudo'
                                                    ? 'border-blue-500 text-primary'
                                                    : 'border-transparent text-muted-foreground hover:text-card-foreground hover:border-gray-300'
                                            }`}
                                        >
                                            Laudo
                                        </button>
                                        <button
                                            onClick={() => setActiveExamTab('consideracoes')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                                                activeExamTab === 'consideracoes'
                                                    ? 'border-blue-500 text-primary'
                                                    : 'border-transparent text-muted-foreground hover:text-card-foreground hover:border-gray-300'
                                            }`}
                                        >
                                            Considerações
                                        </button>
                                    </nav>
                                </div>

                                <div className="p-6">
                                    {activeExamTab === 'imagem' && (
                                        <div>
                                            {pacsImages.length > 0 || showDicomViewer ? (
                                                <div className="max-w-4xl mx-auto">
                                                    {/* Controles do Visualizador PACS */}
                                                    <div className="bg-gray-800 text-white p-4 rounded-t-lg flex justify-between items-center">
                                                        <div className="flex items-center space-x-4">
                                                            <span className="text-sm font-medium">
                                                                {showDicomViewer ? 'Visualizador DICOM Real' : 'PACS Viewer Demo'}
                                                            </span>
                                                            <span className="text-xs text-gray-300">
                                                                {examDetails.exam_type} - {new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}
                                                            </span>
                                                            {!showDicomViewer && pacsImages.length > 0 && (
                                                                <button 
                                                                    onClick={() => {
                                                                        setPacsImages([]);
                                                                        setShowDicomViewer(false);
                                                                        setCurrentImageIndex(0);
                                                                        addToast('Voltando às opções de visualização...', 'info');
                                                                    }}
                                                                    className="ml-4 px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 transition-colors"
                                                                    title="Voltar às opções de visualização"
                                                                >
                                                                    🔄 Opções
                                                                </button>
                                                            )}
                                                        </div>
                                                        {!showDicomViewer && pacsImages.length > 0 && (
                                                            <div className="flex items-center space-x-2">
                                                            <button 
                                                                onClick={() => setCurrentImageIndex(Math.max(0, currentImageIndex - 1))}
                                                                disabled={currentImageIndex === 0}
                                                                className="p-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                                                </svg>
                                                            </button>
                                                            
                                                            <span className="text-sm px-2">
                                                                {currentImageIndex + 1} / {pacsImages.length}
                                                            </span>
                                                            
                                                            <button 
                                                                onClick={() => setCurrentImageIndex(Math.min(pacsImages.length - 1, currentImageIndex + 1))}
                                                                disabled={currentImageIndex === pacsImages.length - 1}
                                                                className="p-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Área da Imagem */}
                                                    <div className="bg-black border border-gray-300 rounded-b-lg relative" style={{ minHeight: '500px' }}>
                                                        {showDicomViewer ? (
                                                            <div className="relative h-full">
                                                                <iframe 
                                                                    src={dicomViewerUrl}
                                                                    className="w-full h-full border-0 rounded-b-lg"
                                                                    style={{ minHeight: '600px' }}
                                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                                    allowFullScreen
                                                                    title={`Visualizador DICOM - ${examDetails.exam_type}`}
                                                                />
                                                                <div className="absolute top-2 right-2 bg-black bg-opacity-50 rounded p-2">
                                                                    <button 
                                                                        onClick={() => setShowDicomViewer(false)}
                                                                        className="text-white hover:text-red-300 transition-colors"
                                                                        title="Fechar visualizador DICOM"
                                                                    >
                                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                                <div className="absolute bottom-2 left-2 text-white text-xs bg-black bg-opacity-50 p-2 rounded">
                                                                    🏥 Visualizador DICOM Real - Medical Connections
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <>
                                                                <img 
                                                                    src={pacsImages[currentImageIndex]}
                                                                    alt={`Imagem ${currentImageIndex + 1} do exame ${examDetails.exam_type}`}
                                                                    className="w-full h-auto max-h-[600px] object-contain"
                                                                    style={{ imageRendering: 'crisp-edges' }}
                                                                />
                                                                
                                                                {/* Overlay com informações DICOM */}
                                                                <div className="absolute top-4 left-4 text-white text-xs font-mono bg-black bg-opacity-50 p-2 rounded">
                                                                    <div>Paciente: {examDetails.patient_name}</div>
                                                                    <div>Modalidade: {examDetails.exam_type.includes('RM') ? 'MR' : 'US'}</div>
                                                                    <div>Data: {new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}</div>
                                                                </div>
                                                                
                                                                <div className="absolute top-4 right-4 text-white text-xs font-mono bg-black bg-opacity-50 p-2 rounded">
                                                                    <div>Slice: {currentImageIndex + 1}/{pacsImages.length}</div>
                                                                    <div>CTC - Centro de Tecnologia Clínica</div>
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Controles de Visualização */}
                                                    <div className="bg-gray-100 p-4 rounded-b-lg flex justify-center space-x-4 text-sm">
                                                        <button 
                                                            onClick={() => addToast('Ferramenta de zoom ativada', 'info')}
                                                            className="flex items-center px-3 py-2 bg-card border rounded hover:bg-secondary"
                                                        >
                                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                                                            </svg>
                                                            Zoom
                                                        </button>
                                                        <button 
                                                            onClick={() => addToast('Ferramenta de medição ativada', 'info')}
                                                            className="flex items-center px-3 py-2 bg-card border rounded hover:bg-secondary"
                                                        >
                                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                                            </svg>
                                                            Medir
                                                        </button>
                                                        <button 
                                                            onClick={() => addToast('Contraste ajustado', 'info')}
                                                            className="flex items-center px-3 py-2 bg-card border rounded hover:bg-secondary"
                                                        >
                                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z" />
                                                            </svg>
                                                            W/L
                                                        </button>
                                                        <button 
                                                            onClick={() => addToast('Imagem redefinida', 'info')}
                                                            className="flex items-center px-3 py-2 bg-card border rounded hover:bg-secondary"
                                                        >
                                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                            </svg>
                                                            Reset
                                                        </button>
                                                    </div>
                                                    
                                                    <p className="mt-4 text-center text-muted-foreground">
                                                        Visualizador PACS - {examDetails.exam_type}
                                                        <br />
                                                        <span className="text-sm">Use os controles para navegar entre as imagens e ajustar a visualização</span>
                                                    </p>
                                                </div>
                                            ) : (
                                                <div className="py-12 text-center">
                                                    <svg className="mx-auto h-24 w-24 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                    <p className="mt-4 text-muted-foreground">Nenhuma imagem disponível para este tipo de exame</p>
                                                    <div className="space-y-3">
                                                        <button 
                                                            onClick={() => loadPacsImages(examDetails.exam_type)}
                                                            className="mr-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                                                        >
                                                            📸 Demo PACS
                                                        </button>
                                                        <button 
                                                            onClick={() => loadDicomViewer(examDetails.exam_type)}
                                                            className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                                                        >
                                                            🏥 DICOM Real
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activeExamTab === 'laudo' && (
                                        <div className="max-w-4xl">
                                            {examDetails.has_detailed_report ? (
                                                <div className="bg-card border border-gray-300 rounded-lg p-8 shadow-sm">
                                                    {/* Header do Hospital */}
                                                    <div className="text-center mb-8">
                                                        <div className="flex items-center justify-center mb-4">
                                                            <img 
                                                                src="./logos/logo 2.png" 
                                                                alt="CTC Logo" 
                                                                className="h-8 w-auto mr-3"
                                                            />
                                                            <h2 className="text-xl font-bold text-ctc-blue uppercase">Centro de Tecnologia Clínica</h2>
                                                        </div>
                                                        <div className="text-sm text-primary font-semibold">Portal de Exames CTC</div>
                                                    </div>

                                                    {/* Informações do Paciente */}
                                                    <div className="grid grid-cols-2 gap-8 mb-6 text-sm">
                                                        <div>
                                                            <p><span className="font-medium">Paciente:</span> {examDetails.patient_name}</p>
                                                            <p><span className="font-medium">Atendimento:</span> {examDetails.attendance_id}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <p><span className="font-medium">Data:</span> {new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}</p>
                                                        </div>
                                                    </div>

                                                    <hr className="mb-6 border-gray-400"/>

                                                    {/* Informações do Resultado */}
                                                    <div className="grid grid-cols-3 gap-8 mb-6 text-sm">
                                                        <div>
                                                            <p><span className="font-medium">Data resultado:</span> {new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}</p>
                                                        </div>
                                                        <div>
                                                            <p><span className="font-medium">Atendimento:</span> {examDetails.attendance_id}</p>
                                                        </div>
                                                        <div>
                                                            <p><span className="font-medium">Prescrição:</span> {examDetails.prescription}</p>
                                                        </div>
                                                    </div>

                                                    <div className="mb-6">
                                                        <p className="text-sm"><span className="font-medium">Médico:</span> {examDetails.doctor_name}</p>
                                                    </div>

                                                    {/* Título do Exame */}
                                                    <h3 className="text-lg font-bold mb-2">{examDetails.exam_type}</h3>
                                                    <p className="text-sm text-muted-foreground mb-6"><span className="font-medium">Método:</span> {examDetails.method}</p>

                                                    {/* Resultado */}
                                                    <div className="grid grid-cols-2 gap-8 mb-8">
                                                        <div>
                                                            <h4 className="font-bold text-card-foreground mb-4">RESULTADO</h4>
                                                            <p className="text-lg">{examDetails.result_value} {examDetails.result_unit}</p>
                                                        </div>
                                                        <div>
                                                            <h4 className="font-bold text-card-foreground mb-4">VALORES DE REFERÊNCIA</h4>
                                                            <div className="text-sm space-y-1">
                                                                <p>Normal: {examDetails.reference_ranges.normal}</p>
                                                                <p>Insuficiente: {examDetails.reference_ranges.insufficient}</p>
                                                                <p>Deficiente: {examDetails.reference_ranges.deficient}</p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Referências */}
                                                    {examDetails.references && examDetails.references.length > 0 && (
                                                        <div className="mb-8">
                                                            {examDetails.references.map((ref, index) => (
                                                                <p key={index} className="text-xs text-muted-foreground">Ref.: {ref}</p>
                                                            ))}
                                                        </div>
                                                    )}

                                                    <hr className="mb-6 border-gray-400"/>

                                                    {/* Informações Finais */}
                                                    <div className="grid grid-cols-3 gap-8 text-sm">
                                                        <div>
                                                            <p><span className="font-medium">Data resultado:</span> {new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}</p>
                                                        </div>
                                                        <div>
                                                            <p><span className="font-medium">Atendimento:</span> {examDetails.attendance_id}</p>
                                                        </div>
                                                        <div>
                                                            <p><span className="font-medium">Prescrição:</span> {examDetails.prescription}</p>
                                                        </div>
                                                    </div>

                                                    {/* Paginação */}
                                                    <div className="flex justify-center items-center mt-8 space-x-4">
                                                        <button className="p-2 text-muted-foreground hover:text-muted-foreground">
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                                            </svg>
                                                        </button>
                                                        
                                                        <div className="flex space-x-2">
                                                            <button className="px-3 py-1 text-sm text-muted-foreground hover:text-card-foreground">1</button>
                                                            <button className="px-3 py-1 text-sm bg-blue-500 text-white rounded">1</button>
                                                            <button className="px-3 py-1 text-sm text-muted-foreground hover:text-card-foreground">2</button>
                                                            <button className="px-3 py-1 text-sm text-muted-foreground hover:text-card-foreground">3</button>
                                                        </div>

                                                        <button className="p-2 text-muted-foreground hover:text-muted-foreground">
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                                            </svg>
                                                        </button>
                                                        
                                                        <div className="flex space-x-2 ml-8">
                                                            <button 
                                                                onClick={() => generateExamPDF(examDetails)}
                                                                className="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                                                            >
                                                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                                </svg>
                                                                Download
                                                            </button>
                                                            <button 
                                                                onClick={() => {
                                                                    window.print();
                                                                    addToast('Preparando impressão...', 'info');
                                                                }}
                                                                className="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                                                            >
                                                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                                                </svg>
                                                                Imprimir
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="prose max-w-none">
                                                    <h3 className="text-lg font-semibold mb-4">Laudo Médico</h3>
                                                    <p className="text-card-foreground leading-relaxed">
                                                        {examDetails.exam_type.toLowerCase().includes('ultrassom') ? 
                                                            `Exame de ultrassom ${examDetails.exam_type.toLowerCase().includes('abdominal') ? 'abdominal' : ''} realizado em ${new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}. As estruturas analisadas apresentam características morfológicas e ecogênicas dentro dos padrões de normalidade. Não foram identificadas alterações significativas nos órgãos avaliados. Exame dentro dos limites da normalidade.` :
                                                        examDetails.exam_type.toLowerCase().includes('ressonância') ?
                                                            `Ressonância magnética realizada conforme protocolo técnico adequado. As imagens obtidas demonstram estruturas anatômicas preservadas, sem sinais de lesões expansivas ou alterações estruturais significativas. Sinal e morfologia dos tecidos dentro dos padrões esperados para a faixa etária. Exame sem particularidades patológicas.` :
                                                            `Exame de ${examDetails.exam_type} realizado em ${new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}. Os parâmetros avaliados estão dentro dos limites de normalidade esperados. Recomenda-se acompanhamento de rotina conforme orientação médica.`
                                                        }
                                                    </p>
                                                    <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                                                        <h4 className="font-semibold text-blue-900">Conclusão:</h4>
                                                        <p className="text-blue-800 mt-2">Exame dentro dos padrões de normalidade. Manter acompanhamento médico de rotina.</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activeExamTab === 'consideracoes' && (
                                        <div className="max-w-4xl">
                                            <h3 className="text-lg font-semibold mb-4">Considerações Médicas</h3>
                                            <div className="space-y-4">
                                                <div className="bg-amber-50 border-l-4 border-amber-400 p-4">
                                                    <h4 className="font-medium text-amber-800">Orientações Gerais</h4>
                                                    <p className="text-amber-700 mt-2">
                                                        Manter acompanhamento médico regular e seguir as orientações fornecidas durante a consulta. 
                                                        Em caso de dúvidas ou sintomas, procurar atendimento médico.
                                                    </p>
                                                </div>
                                                
                                                <div className="bg-green-50 border-l-4 border-green-400 p-4">
                                                    <h4 className="font-medium text-green-800">Recomendações</h4>
                                                    <ul className="text-green-800 dark:text-green-300 mt-2 space-y-1">
                                                        <li>• Manter dieta equilibrada e atividade física regular</li>
                                                        <li>• Realizar acompanhamento periódico conforme orientação médica</li>
                                                        <li>• Manter-se hidratado e ter bons hábitos de sono</li>
                                                        {examDetails.exam_type.toLowerCase().includes('laboratorial') && (
                                                            <li>• Repetir exames laboratoriais em 6 meses ou conforme orientação médica</li>
                                                        )}
                                                    </ul>
                                                </div>

                                                <div className="bg-blue-50 border-l-4 border-blue-400 p-4">
                                                    <h4 className="font-medium text-blue-800">Informações Técnicas</h4>
                                                    <p className="text-blue-800 dark:text-blue-300 mt-2">
                                                        Exame realizado por: {examDetails.doctor_name}<br/>
                                                        Data: {new Date(examDetails.exam_date).toLocaleDateString('pt-BR')}<br/>
                                                        Unidade: Paulista<br/>
                                                        Modalidade: {examDetails.exam_type}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            if (currentPage === 'shared-exams') {
                return (
                    <div className="min-h-screen bg-background text-foreground">
                        <Navigation />
                        <main className="max-w-7xl mx-auto py-8 px-4">
                            <div className="mb-8">
                                <h2 className="text-3xl font-bold text-card-foreground mb-6">Exames Compartilhados</h2>
                                
                                <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                    <div className="px-6 py-4 border-b border-border">
                                        <h3 className="text-lg font-semibold">Compartilhamentos Ativos</h3>
                                    </div>
                                    <div className="p-6">
                                        {sharedExams.length === 0 ? (
                                            <div className="text-center text-muted-foreground py-8">
                                                Nenhum exame compartilhado encontrado
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {sharedExams.map((share, index) => (
                                                    <div key={index} className="border border-border rounded-lg p-4">
                                                        <div className="flex justify-between items-start">
                                                            <div>
                                                                <h4 className="font-semibold text-card-foreground">{share.exam_type}</h4>
                                                                <p className="text-sm text-muted-foreground">
                                                                    Compartilhado com: Dr. {share.doctor_name} (CRM: {share.doctor_crm})
                                                                </p>
                                                                <p className="text-xs text-muted-foreground">
                                                                    Data: {new Date(share.shared_at).toLocaleDateString('pt-BR')}
                                                                </p>
                                                                {share.message && (
                                                                    <p className="text-sm text-card-foreground mt-2 italic">
                                                                        "{share.message}"
                                                                    </p>
                                                                )}
                                                            </div>
                                                            <span className="bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 text-xs font-semibold px-2 py-1 rounded-full">
                                                                Ativo
                                                            </span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            if (currentPage === 'timeline') {
                return (
                    <div className="min-h-screen bg-background text-foreground">
                        <Navigation />
                        <main className="max-w-7xl mx-auto py-8 px-4">
                            <div className="mb-8">
                                <h2 className="text-3xl font-bold text-card-foreground mb-6">Timeline Clínica</h2>
                                
                                <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover mb-6">
                                    <div className="px-6 py-4 border-b border-border">
                                        <h3 className="text-lg font-semibold">Filtros da Timeline</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-card-foreground mb-2">Parâmetro</label>
                                                <select
                                                    value={selectedParameter}
                                                    onChange={(e) => setSelectedParameter(e.target.value)}
                                                    className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                >
                                                    <optgroup label="🩸 Hematologia">
                                                        <option value="Hemoglobina">Hemoglobina</option>
                                                        <option value="Hematócrito">Hematócrito</option>
                                                        <option value="Leucócitos">Leucócitos</option>
                                                        <option value="Plaquetas">Plaquetas</option>
                                                        <option value="VCM">VCM</option>
                                                    </optgroup>
                                                    <optgroup label="🧪 Bioquímica">
                                                        <option value="Glicose">Glicose</option>
                                                        <option value="Creatinina">Creatinina</option>
                                                        <option value="Ureia">Ureia</option>
                                                        <option value="Ácido Úrico">Ácido Úrico</option>
                                                        <option value="Bilirrubina">Bilirrubina</option>
                                                        <option value="TGO">TGO (AST)</option>
                                                        <option value="TGP">TGP (ALT)</option>
                                                    </optgroup>
                                                    <optgroup label="💊 Lipídios">
                                                        <option value="Colesterol Total">Colesterol Total</option>
                                                        <option value="HDL">HDL (Colesterol Bom)</option>
                                                        <option value="LDL">LDL (Colesterol Ruim)</option>
                                                        <option value="Triglicérides">Triglicérides</option>
                                                        <option value="VLDL">VLDL</option>
                                                    </optgroup>
                                                    <optgroup label="⚡ Hormonal">
                                                        <option value="TSH">TSH</option>
                                                        <option value="T4 Livre">T4 Livre</option>
                                                        <option value="T3">T3</option>
                                                        <option value="Cortisol">Cortisol</option>
                                                        <option value="Insulina">Insulina</option>
                                                        <option value="Testosterona">Testosterona</option>
                                                    </optgroup>
                                                    <optgroup label="❤️ Cardiovascular">
                                                        <option value="Proteína C Reativa">Proteína C Reativa</option>
                                                        <option value="Homocisteína">Homocisteína</option>
                                                        <option value="Troponina">Troponina</option>
                                                        <option value="BNP">BNP</option>
                                                    </optgroup>
                                                    <optgroup label="🦴 Vitaminas & Minerais">
                                                        <option value="Vitamina D">Vitamina D</option>
                                                        <option value="Vitamina B12">Vitamina B12</option>
                                                        <option value="Ácido Fólico">Ácido Fólico</option>
                                                        <option value="Ferro">Ferro</option>
                                                        <option value="Ferritina">Ferritina</option>
                                                        <option value="Cálcio">Cálcio</option>
                                                        <option value="Magnésio">Magnésio</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-card-foreground mb-2">Período (meses)</label>
                                                <select
                                                    value={timelineMonths}
                                                    onChange={(e) => setTimelineMonths(parseInt(e.target.value))}
                                                    className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                >
                                                    <option value={6}>6 meses</option>
                                                    <option value={12}>12 meses</option>
                                                    <option value={24}>24 meses</option>
                                                    <option value={36}>36 meses</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-card-foreground mb-2">Categoria Médica</label>
                                                <select
                                                    value={medicalCategory}
                                                    onChange={(e) => setMedicalCategory(e.target.value)}
                                                    className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                >
                                                    <option value="todas">Todas as Categorias</option>
                                                    <option value="hematologia">🩸 Hematologia</option>
                                                    <option value="bioquimica">🧪 Bioquímica</option>
                                                    <option value="lipidios">💊 Lipídios</option>
                                                    <option value="hormonal">⚡ Hormonal</option>
                                                    <option value="cardiovascular">❤️ Cardiovascular</option>
                                                    <option value="vitaminas">🦴 Vitaminas & Minerais</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-card-foreground mb-2">Status do Resultado</label>
                                                <select
                                                    value={resultStatus}
                                                    onChange={(e) => setResultStatus(e.target.value)}
                                                    className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                >
                                                    <option value="todos">Todos os Status</option>
                                                    <option value="normal">🟢 Normal</option>
                                                    <option value="limitrofe">🟡 Limítrofe</option>
                                                    <option value="alterado">🔴 Alterado</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Health Summary Dashboard */}
                                <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover mb-6">
                                    <div className="px-6 py-4 border-b border-border">
                                        <h3 className="text-lg font-semibold flex items-center">
                                            <span className="mr-2">🏥</span>
                                            Resumo de Saúde Geral
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                            {/* Overall Health Score */}
                                            <div className="text-center p-4 bg-blue-600 dark:bg-blue-900/20 rounded-lg">
                                                <div className="text-3xl font-bold text-white dark:text-blue-400 mb-2">
                                                    {(() => {
                                                        const totalExams = timelineData.length;
                                                        const normalExams = timelineData.filter(e => e.is_normal).length;
                                                        const score = totalExams > 0 ? Math.round((normalExams / totalExams) * 100) : 0;
                                                        return score;
                                                    })()}%
                                                </div>
                                                <div className="text-sm font-medium text-white dark:text-blue-300">Índice de Saúde</div>
                                                <div className="text-xs text-white dark:text-blue-400 mt-1">
                                                    {(() => {
                                                        const score = timelineData.length > 0 ? Math.round((timelineData.filter(e => e.is_normal).length / timelineData.length) * 100) : 0;
                                                        if (score >= 80) return "Excelente";
                                                        if (score >= 60) return "Bom";
                                                        if (score >= 40) return "Regular";
                                                        return "Atenção";
                                                    })()}
                                                </div>
                                            </div>

                                            {/* Risk Assessment */}
                                            <div className="text-center p-4 bg-green-600 dark:bg-green-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-white dark:text-green-400 mb-2">
                                                    {(() => {
                                                        const highRisk = timelineData.filter(e => e.risk_level === 'alto').length;
                                                        return highRisk === 0 ? '🟢' : highRisk <= 2 ? '🟡' : '🔴';
                                                    })()}
                                                </div>
                                                <div className="text-sm font-medium text-white dark:text-green-300">Nível de Risco</div>
                                                <div className="text-xs text-white dark:text-green-400 mt-1">
                                                    {(() => {
                                                        const highRisk = timelineData.filter(e => e.risk_level === 'alto').length;
                                                        if (highRisk === 0) return "Baixo";
                                                        if (highRisk <= 2) return "Moderado";
                                                        return "Alto";
                                                    })()}
                                                </div>
                                            </div>

                                            {/* Trending Analysis */}
                                            <div className="text-center p-4 bg-purple-600 dark:bg-purple-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-white dark:text-purple-400 mb-2">
                                                    {(() => {
                                                        const trends = timelineData.map(e => e.trend);
                                                        const improving = trends.filter(t => t === '↗').length;
                                                        const declining = trends.filter(t => t === '↘').length;
                                                        if (improving > declining) return '📈';
                                                        if (declining > improving) return '📉';
                                                        return '📊';
                                                    })()}
                                                </div>
                                                <div className="text-sm font-medium text-white dark:text-purple-300">Tendência Geral</div>
                                                <div className="text-xs text-white dark:text-purple-400 mt-1">
                                                    {(() => {
                                                        const trends = timelineData.map(e => e.trend);
                                                        const improving = trends.filter(t => t === '↗').length;
                                                        const declining = trends.filter(t => t === '↘').length;
                                                        if (improving > declining) return "Melhorando";
                                                        if (declining > improving) return "Piorando";
                                                        return "Estável";
                                                    })()}
                                                </div>
                                            </div>

                                            {/* Next Actions */}
                                            <div className="text-center p-4 bg-orange-600 dark:bg-orange-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-white dark:text-orange-400 mb-2">
                                                    {timelineData.filter(e => !e.is_normal).length}
                                                </div>
                                                <div className="text-sm font-medium text-white dark:text-orange-300">Ações Recomendadas</div>
                                                <div className="text-xs text-white dark:text-orange-400 mt-1">
                                                    {timelineData.filter(e => !e.is_normal).length === 0 ? "Manter rotina" : "Consultas médicas"}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Medical Alerts */}
                                        {timelineData.filter(e => !e.is_normal).length > 0 && (
                                            <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4 mb-4">
                                                <h4 className="font-semibold text-yellow-900 dark:text-yellow-300 mb-2 flex items-center">
                                                    <span className="mr-2">⚠️</span>
                                                    Alertas Médicos Importantes
                                                </h4>
                                                <div className="space-y-2">
                                                    {timelineData.filter(e => !e.is_normal).slice(0, 3).map((alert, index) => (
                                                        <div key={index} className="text-sm text-yellow-800 dark:text-yellow-200 bg-yellow-100 dark:bg-yellow-800/30 p-2 rounded">
                                                            <span className="font-medium">{selectedParameter}:</span> {alert.recommendation}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Medical Categories Overview */}
                                        <div className="grid grid-cols-2 md:grid-cols-6 gap-3">
                                            {[
                                                { key: 'hematologia', name: 'Hematologia', icon: '🩸', color: 'red' },
                                                { key: 'bioquimica', name: 'Bioquímica', icon: '🧪', color: 'blue' },
                                                { key: 'lipidios', name: 'Lipídios', icon: '💊', color: 'purple' },
                                                { key: 'hormonal', name: 'Hormonal', icon: '⚡', color: 'yellow' },
                                                { key: 'cardiovascular', name: 'Cardiovascular', icon: '❤️', color: 'rose' },
                                                { key: 'vitaminas', name: 'Vitaminas', icon: '🦴', color: 'green' }
                                            ].map(category => {
                                                const categoryData = timelineData.filter(e => e.category === category.key);
                                                const normalCount = categoryData.filter(e => e.is_normal).length;
                                                const totalCount = categoryData.length;
                                                const percentage = totalCount > 0 ? Math.round((normalCount / totalCount) * 100) : 0;
                                                
                                                return (
                                                    <div key={category.key} className={`p-3 rounded-lg bg-${category.color}-50 dark:bg-${category.color}-900/20 border border-${category.color}-200 dark:border-${category.color}-700`}>
                                                        <div className="text-center">
                                                            <div className="text-lg mb-1">{category.icon}</div>
                                                            <div className="text-xs font-medium text-card-foreground">{category.name}</div>
                                                            <div className={`text-sm font-bold text-${category.color}-600`}>
                                                                {totalCount > 0 ? `${percentage}%` : 'N/A'}
                                                            </div>
                                                            <div className="text-xs text-muted-foreground">
                                                                {totalCount} exam{totalCount !== 1 ? 'es' : 'e'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                    <div className="px-6 py-4 border-b border-border">
                                        <h3 className="text-lg font-semibold">
                                            Evolução de {selectedParameter} - Últimos {timelineMonths} meses
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        {timelineData.length === 0 ? (
                                            <div className="text-center text-muted-foreground py-8">
                                                Nenhum dado encontrado para este parâmetro no período selecionado
                                            </div>
                                        ) : (
                                            <div className="space-y-6">
                                                {/* Gráfico de Linhas com Faixas de Risco - shadcn/ui inspired */}
                                                <div className="chart-container p-6">
                                                    <div className="flex items-center justify-between mb-6">
                                                        <h4 className="text-lg font-semibold text-foreground">Evolução Clínica</h4>
                                                        <div className="flex items-center space-x-4 text-sm">
                                                            <div className="flex items-center">
                                                                <div className="w-3 h-3 bg-emerald-500 rounded-full mr-2"></div>
                                                                <span className="text-muted-foreground">Normal</span>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <div className="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                                                                <span className="text-muted-foreground">Limítrofe</span>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <div className="w-3 h-3 bg-destructive rounded-full mr-2"></div>
                                                                <span className="text-muted-foreground">Alterado</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Line Chart with Risk Zones - Proper Chart Implementation */}
                                                    <div className="relative">
                                                        {/* Chart container with proper height */}
                                                        <div className="h-64 sm:h-72 lg:h-80 w-full">
                                                            {(() => {
                                                                const chartData = timelineData.slice(0, 12);
                                                                if (chartData.length === 0) return null;

                                                                const maxValue = Math.max(...chartData.map(e => parseFloat(e.value)));
                                                                const minValue = Math.min(...chartData.map(e => parseFloat(e.value)));
                                                                const range = maxValue - minValue || 1;
                                                                const padding = range * 0.1;
                                                                const chartMax = maxValue + padding;
                                                                const chartMin = Math.max(0, minValue - padding);
                                                                const chartRange = chartMax - chartMin;

                                                                // Get reference range for risk zones
                                                                const refRange = chartData[0]?.reference_range?.split('-');
                                                                const refMin = refRange && refRange.length === 2 ? parseFloat(refRange[0]) : null;
                                                                const refMax = refRange && refRange.length === 2 ? parseFloat(refRange[1]) : null;

                                                                // Define risk zones based on reference values
                                                                let normalZoneStart = 0, normalZoneEnd = 100;
                                                                let limítrofeZoneStart = 0, limítrofeZoneEnd = 0;
                                                                let alteradoZoneStart = 0, alteradoZoneEnd = 0;

                                                                if (refMin !== null && refMax !== null) {
                                                                    const bufferZone = (refMax - refMin) * 0.1;
                                                                    normalZoneStart = Math.max(0, ((refMin - chartMin) / chartRange) * 100);
                                                                    normalZoneEnd = Math.min(100, ((refMax - chartMin) / chartRange) * 100);
                                                                    
                                                                    limítrofeZoneStart = Math.max(0, ((refMin - bufferZone - chartMin) / chartRange) * 100);
                                                                    limítrofeZoneEnd = Math.min(100, ((refMax + bufferZone - chartMin) / chartRange) * 100);
                                                                    
                                                                    // Areas above and below limítrofe are alterado
                                                                    alteradoZoneStart = 0;
                                                                    alteradoZoneEnd = 100;
                                                                }

                                                                return (
                                                                    <div className="relative h-full bg-background border border-border rounded-lg p-6">
                                                                        {/* Risk zone backgrounds */}
                                                                        <div className="absolute inset-6 pointer-events-none">
                                                                            {refMin !== null && refMax !== null && (
                                                                                <>
                                                                                    {/* Normal zone (green) */}
                                                                                    <div 
                                                                                        className="absolute w-full bg-emerald-50"
                                                                                        style={{
                                                                                            bottom: `${normalZoneStart}%`,
                                                                                            height: `${normalZoneEnd - normalZoneStart}%`
                                                                                        }}
                                                                                    />
                                                                                    
                                                                                    {/* Limítrofe zones (yellow) */}
                                                                                    <div 
                                                                                        className="absolute w-full bg-yellow-50"
                                                                                        style={{
                                                                                            bottom: `${limítrofeZoneStart}%`,
                                                                                            height: `${normalZoneStart - limítrofeZoneStart}%`
                                                                                        }}
                                                                                    />
                                                                                    <div 
                                                                                        className="absolute w-full bg-yellow-50"
                                                                                        style={{
                                                                                            bottom: `${normalZoneEnd}%`,
                                                                                            height: `${limítrofeZoneEnd - normalZoneEnd}%`
                                                                                        }}
                                                                                    />
                                                                                    
                                                                                    {/* Alterado zones (red) */}
                                                                                    <div 
                                                                                        className="absolute w-full bg-red-50"
                                                                                        style={{
                                                                                            bottom: `${limítrofeZoneEnd}%`,
                                                                                            height: `${100 - limítrofeZoneEnd}%`
                                                                                        }}
                                                                                    />
                                                                                    <div 
                                                                                        className="absolute w-full bg-red-50"
                                                                                        style={{
                                                                                            bottom: '0%',
                                                                                            height: `${limítrofeZoneStart}%`
                                                                                        }}
                                                                                    />
                                                                                </>
                                                                            )}
                                                                        </div>

                                                                        {/* Grid lines */}
                                                                        <div className="absolute inset-6 pointer-events-none">
                                                                            {/* Horizontal grid lines */}
                                                                            {Array.from({ length: 5 }, (_, i) => (
                                                                                <div 
                                                                                    key={i}
                                                                                    className="absolute w-full border-t border-border/30"
                                                                                    style={{ bottom: `${(i / 4) * 100}%` }}
                                                                                />
                                                                            ))}
                                                                            
                                                                            {/* Vertical grid lines */}
                                                                            {chartData.map((_, i) => (
                                                                                <div 
                                                                                    key={i}
                                                                                    className="absolute h-full border-l border-border/20"
                                                                                    style={{ left: `${(i / (chartData.length - 1)) * 100}%` }}
                                                                                />
                                                                            ))}
                                                                        </div>

                                                                        {/* Y-axis labels */}
                                                                        <div className="absolute left-0 top-6 bottom-6 w-12 flex flex-col justify-between">
                                                                            {Array.from({ length: 5 }, (_, i) => {
                                                                                const value = chartMax - (chartRange * i / 4);
                                                                                return (
                                                                                    <span key={i} className="text-xs text-muted-foreground text-right pr-2">
                                                                                        {value.toFixed(1)}
                                                                                    </span>
                                                                                );
                                                                            })}
                                                                        </div>

                                                                        {/* Line and dots */}
                                                                        <div className="absolute inset-6">
                                                                            <svg className="w-full h-full" preserveAspectRatio="none">
                                                                                {/* Line path */}
                                                                                {chartData.length >= 2 && (
                                                                                    <polyline
                                                                                        points={chartData.map((entry, index) => {
                                                                                            const x = (index / (chartData.length - 1)) * 100;
                                                                                            const y = 100 - (((parseFloat(entry.value) - chartMin) / chartRange) * 100);
                                                                                            return `${x},${y}`;
                                                                                        }).join(' ')}
                                                                                        fill="none"
                                                                                        stroke="#3b82f6"
                                                                                        strokeWidth="2"
                                                                                        strokeLinejoin="round"
                                                                                        strokeLinecap="round"
                                                                                        vectorEffect="non-scaling-stroke"
                                                                                    />
                                                                                )}
                                                                            </svg>

                                                                            {/* Data points with tooltips */}
                                                                            {chartData.map((entry, index) => {
                                                                                const x = (index / (chartData.length - 1)) * 100;
                                                                                const y = 100 - (((parseFloat(entry.value) - chartMin) / chartRange) * 100);
                                                                                
                                                                                const getStatus = () => {
                                                                                    const value = parseFloat(entry.value);
                                                                                    
                                                                                    if (refMin !== null && refMax !== null) {
                                                                                        const bufferZone = (refMax - refMin) * 0.1;
                                                                                        
                                                                                        if (value >= refMin && value <= refMax) {
                                                                                            return { text: 'Normal', color: '#10b981', bgColor: 'bg-emerald-600' };
                                                                                        }
                                                                                        if (value >= (refMin - bufferZone) && value <= (refMax + bufferZone)) {
                                                                                            return { text: 'Limítrofe', color: '#f59e0b', bgColor: 'bg-yellow-500' };
                                                                                        }
                                                                                        return { text: 'Alterado', color: '#dc2626', bgColor: 'bg-red-500' };
                                                                                    }
                                                                                    
                                                                                    return entry.is_normal 
                                                                                        ? { text: 'Normal', color: '#10b981', bgColor: 'bg-emerald-600' }
                                                                                        : { text: 'Alterado', color: '#dc2626', bgColor: 'bg-red-500' };
                                                                                };

                                                                                const status = getStatus();

                                                                                return (
                                                                                    <div 
                                                                                        key={index}
                                                                                        className="absolute group cursor-pointer transform -translate-x-1/2 -translate-y-1/2"
                                                                                        style={{
                                                                                            left: `${x}%`,
                                                                                            top: `${y}%`
                                                                                        }}
                                                                                    >
                                                                                        {/* Dot */}
                                                                                        <div 
                                                                                            className={`w-3 h-3 rounded-full border-2 border-white shadow-sm ${status.bgColor} hover:scale-125 transition-transform`}
                                                                                        />
                                                                                        
                                                                                        {/* Tooltip */}
                                                                                        <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-popover text-popover-foreground text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10 border">
                                                                                            <div className="font-medium">{entry.value} {entry.unit}</div>
                                                                                            <div className="text-muted-foreground">{new Date(entry.date).toLocaleDateString('pt-BR')}</div>
                                                                                            <div className="text-xs" style={{ color: status.color }}>
                                                                                                {status.text}
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                );
                                                                            })}
                                                                        </div>

                                                                        {/* X-axis labels */}
                                                                        <div className="absolute bottom-0 left-6 right-6 h-6 flex justify-between items-start pt-2">
                                                                            {chartData.map((entry, index) => {
                                                                                // Show every other label to avoid crowding
                                                                                if (index % 2 === 0 || index === chartData.length - 1) {
                                                                                    return (
                                                                                        <div key={index} className="text-xs text-muted-foreground text-center">
                                                                                            {new Date(entry.date).toLocaleDateString('pt-BR', { 
                                                                                                month: 'short', 
                                                                                                day: '2-digit' 
                                                                                            })}
                                                                                        </div>
                                                                                    );
                                                                                }
                                                                                return <div key={index}></div>;
                                                                            })}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })()}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Chart footer */}
                                                    <div className="mt-4 flex justify-between items-center text-xs text-muted-foreground">
                                                        <span>Últimos {timelineData.length} resultados</span>
                                                        <span>Valores de referência em verde</span>
                                                    </div>
                                                </div>

                                                {/* Estatísticas */}
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                    <div className="stat-card">
                                                        <div className="flex flex-row items-center justify-between space-y-0 pb-2">
                                                            <p className="text-sm font-medium text-muted-foreground">Total de Exames</p>
                                                            <div className="h-4 w-4 text-muted-foreground">📊</div>
                                                        </div>
                                                        <div>
                                                            <div className="text-2xl font-bold text-foreground">
                                                                {timelineData.length}
                                                            </div>
                                                            <p className="text-xs text-muted-foreground">
                                                                no período selecionado
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="stat-card">
                                                        <div className="flex flex-row items-center justify-between space-y-0 pb-2">
                                                            <p className="text-sm font-medium text-muted-foreground">Normais</p>
                                                            <div className="h-4 w-4 text-emerald-500">✓</div>
                                                        </div>
                                                        <div>
                                                            <div className="text-2xl font-bold text-emerald-600">
                                                                {timelineData.filter(e => e.is_normal).length}
                                                            </div>
                                                            <p className="text-xs text-muted-foreground">
                                                                {timelineData.length > 0 
                                                                    ? `${Math.round((timelineData.filter(e => e.is_normal).length / timelineData.length) * 100)}% do total`
                                                                    : '0% do total'
                                                                }
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="stat-card">
                                                        <div className="flex flex-row items-center justify-between space-y-0 pb-2">
                                                            <p className="text-sm font-medium text-muted-foreground">Alterados</p>
                                                            <div className="h-4 w-4 text-destructive">⚠</div>
                                                        </div>
                                                        <div>
                                                            <div className="text-2xl font-bold text-destructive">
                                                                {timelineData.filter(e => !e.is_normal).length}
                                                            </div>
                                                            <p className="text-xs text-muted-foreground">
                                                                {timelineData.length > 0 
                                                                    ? `${Math.round((timelineData.filter(e => !e.is_normal).length / timelineData.length) * 100)}% do total`
                                                                    : '0% do total'
                                                                }
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="stat-card">
                                                        <div className="flex flex-row items-center justify-between space-y-0 pb-2">
                                                            <p className="text-sm font-medium text-muted-foreground">Média</p>
                                                            <div className="h-4 w-4 text-muted-foreground">📈</div>
                                                        </div>
                                                        <div>
                                                            <div className="text-2xl font-bold text-foreground">
                                                                {timelineData.length > 0 ? 
                                                                    (timelineData.reduce((sum, e) => sum + parseFloat(e.value), 0) / timelineData.length).toFixed(1)
                                                                    : '0'
                                                                }
                                                            </div>
                                                            <p className="text-xs text-muted-foreground">
                                                                {timelineData[0] ? timelineData[0].unit : 'unidade'} no período
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Lista detalhada */}
                                                <div className="space-y-4">
                                                    <h4 className="font-medium flex items-center">
                                                        <span className="mr-2">📋</span>
                                                        Histórico Detalhado de {selectedParameter}
                                                    </h4>
                                                    {timelineData.map((entry, index) => (
                                                        <div key={index} className="bg-card border border-border rounded-xl p-4 hover:shadow-md transition-all duration-200">
                                                            <div className="flex items-start space-x-4">
                                                                {/* Status Indicator */}
                                                                <div className="flex-shrink-0 mt-1">
                                                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold ${
                                                                        entry.status === 'normal' ? 'bg-green-500' : 
                                                                        entry.status === 'limitrofe' ? 'bg-yellow-500' : 'bg-red-500'
                                                                    }`}>
                                                                        {entry.status === 'normal' ? '✓' : 
                                                                         entry.status === 'limitrofe' ? '!' : '⚠'}
                                                                    </div>
                                                                </div>
                                                                
                                                                {/* Main Content */}
                                                                <div className="flex-grow">
                                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                                        {/* Result Value */}
                                                                        <div>
                                                                            <div className="flex items-center space-x-2 mb-1">
                                                                                <span className="text-lg font-bold text-card-foreground">
                                                                                    {entry.value} {entry.unit}
                                                                                </span>
                                                                                <span className="text-lg">
                                                                                    {entry.trend}
                                                                                </span>
                                                                            </div>
                                                                            <p className="text-sm text-muted-foreground">
                                                                                Ref: {entry.reference_range} {entry.unit}
                                                                            </p>
                                                                            <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full mt-1 ${
                                                                                entry.status === 'normal' ? 'badge-success' : 
                                                                                entry.status === 'limitrofe' ? 'badge-warning' : 
                                                                                'badge-error'
                                                                            }`}>
                                                                                {entry.status === 'normal' ? '🟢 Normal' : 
                                                                                 entry.status === 'limitrofe' ? '🟡 Limítrofe' : 
                                                                                 entry.status === 'baixo' ? '🔴 Baixo' : '🔴 Alto'}
                                                                            </span>
                                                                        </div>
                                                                        
                                                                        {/* Date and Doctor Info */}
                                                                        <div>
                                                                            <p className="text-sm font-medium text-card-foreground mb-1">
                                                                                📅 {new Date(entry.date).toLocaleDateString('pt-BR', { 
                                                                                    weekday: 'short', 
                                                                                    year: 'numeric', 
                                                                                    month: 'short', 
                                                                                    day: 'numeric' 
                                                                                })}
                                                                            </p>
                                                                            <p className="text-xs text-muted-foreground mb-1">
                                                                                {entry.exam_type}
                                                                            </p>
                                                                            {entry.doctor_name && (
                                                                                <div className="text-xs text-muted-foreground">
                                                                                    <p className="font-medium">👨‍⚕️ Dr. {entry.doctor_name}</p>
                                                                                    <p>CRM: {entry.doctor_crm}</p>
                                                                                    <p className="text-primary">{entry.doctor_specialty}</p>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        {/* Risk Level and Actions */}
                                                                        <div className="text-right">
                                                                            <div className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full mb-2 ${
                                                                                entry.risk_level === 'baixo' ? 'badge-success' :
                                                                                entry.risk_level === 'medio' ? 'badge-warning' :
                                                                                'badge-error'
                                                                            }`}>
                                                                                Risco {entry.risk_level}
                                                                            </div>
                                                                            <div className="space-y-1">
                                                                                <button 
                                                                                    onClick={() => loadExamDetails(entry.exam_id)}
                                                                                    className="block text-xs text-primary hover:text-primary/80 font-medium"
                                                                                >
                                                                                    📄 Ver exame completo
                                                                                </button>
                                                                                <button 
                                                                                    onClick={() => {
                                                                                        navigator.clipboard.writeText(`${selectedParameter}: ${entry.value} ${entry.unit} (${entry.date})`);
                                                                                        alert('Resultado copiado!');
                                                                                    }}
                                                                                    className="block text-xs text-muted-foreground hover:text-gray-800"
                                                                                >
                                                                                    📋 Copiar resultado
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Medical Description */}
                                                                    <div className="mt-3 p-3 bg-secondary rounded-lg">
                                                                        <p className="text-xs text-muted-foreground mb-2">
                                                                            <span className="font-medium">Sobre {selectedParameter}:</span> {entry.description}
                                                                        </p>
                                                                        <p className="text-xs text-card-foreground">
                                                                            <span className="font-medium">Recomendação médica:</span> {entry.recommendation}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                                {/* Ações de exportação */}
                                                <div className="border-t pt-4">
                                                    <h4 className="font-medium mb-3">Exportar Timeline</h4>
                                                    <div className="flex space-x-2">
                                                        <button 
                                                            onClick={() => {
                                                                const headers = [
                                                                    'Data', 'Parâmetro', 'Valor', 'Unidade', 'Referência', 
                                                                    'Status', 'Tendência', 'Nível de Risco', 'Categoria', 
                                                                    'Médico', 'CRM', 'Especialidade', 'Recomendação'
                                                                ];
                                                                const csv = timelineData.map(entry => [
                                                                    new Date(entry.date).toLocaleDateString('pt-BR'),
                                                                    selectedParameter,
                                                                    entry.value,
                                                                    entry.unit,
                                                                    entry.reference_range,
                                                                    entry.status,
                                                                    entry.trend,
                                                                    entry.risk_level,
                                                                    entry.category,
                                                                    entry.doctor_name || '',
                                                                    entry.doctor_crm || '',
                                                                    entry.doctor_specialty || '',
                                                                    entry.recommendation || ''
                                                                ].map(field => `"${field}"`).join(',')).join('\n');
                                                                
                                                                const blob = new Blob([headers.join(',') + '\n' + csv], { type: 'text/csv;charset=utf-8;' });
                                                                const url = URL.createObjectURL(blob);
                                                                const a = document.createElement('a');
                                                                a.href = url;
                                                                a.download = `timeline_medica_${selectedParameter}_${new Date().toISOString().split('T')[0]}.csv`;
                                                                a.click();
                                                                URL.revokeObjectURL(url);
                                                            }}
                                                            className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm flex items-center"
                                                        >
                                                            📊 Exportar CSV Completo
                                                        </button>
                                                        <button 
                                                            onClick={() => {
                                                                // Generate comprehensive medical summary for all parameters
                                                                const allMedicalData = [];
                                                                const allParameters = [
                                                                    'Hemoglobina', 'Hematócrito', 'Leucócitos', 'Plaquetas', 'VCM',
                                                                    'Glicose', 'Creatinina', 'Ureia', 'Ácido Úrico', 'Bilirrubina', 'TGO', 'TGP',
                                                                    'Colesterol Total', 'HDL', 'LDL', 'Triglicérides', 'VLDL',
                                                                    'TSH', 'T4 Livre', 'T3', 'Cortisol', 'Insulina', 'Testosterona',
                                                                    'Proteína C Reativa', 'Homocisteína', 'Troponina', 'BNP',
                                                                    'Vitamina D', 'Vitamina B12', 'Ácido Fólico', 'Ferro', 'Ferritina', 'Cálcio', 'Magnésio'
                                                                ];
                                                                
                                                                allParameters.forEach(param => {
                                                                    const demoData = generateTimelineDemo(param, timelineMonths);
                                                                    allMedicalData.push(...demoData.map(entry => ({...entry, parameter: param})));
                                                                });
                                                                
                                                                const headers = [
                                                                    'Data', 'Parâmetro', 'Valor', 'Unidade', 'Referência', 
                                                                    'Status', 'Tendência', 'Nível de Risco', 'Categoria', 
                                                                    'Médico', 'CRM', 'Especialidade', 'Descrição', 'Recomendação'
                                                                ];
                                                                const csv = allMedicalData.map(entry => [
                                                                    new Date(entry.date).toLocaleDateString('pt-BR'),
                                                                    entry.parameter,
                                                                    entry.value,
                                                                    entry.unit,
                                                                    entry.reference_range,
                                                                    entry.status,
                                                                    entry.trend,
                                                                    entry.risk_level,
                                                                    entry.category,
                                                                    entry.doctor_name || '',
                                                                    entry.doctor_crm || '',
                                                                    entry.doctor_specialty || '',
                                                                    entry.description || '',
                                                                    entry.recommendation || ''
                                                                ].map(field => `"${field}"`).join(',')).join('\n');
                                                                
                                                                const blob = new Blob([headers.join(',') + '\n' + csv], { type: 'text/csv;charset=utf-8;' });
                                                                const url = URL.createObjectURL(blob);
                                                                const a = document.createElement('a');
                                                                a.href = url;
                                                                a.download = `relatorio_medico_completo_${new Date().toISOString().split('T')[0]}.csv`;
                                                                a.click();
                                                                URL.revokeObjectURL(url);
                                                            }}
                                                            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm flex items-center"
                                                        >
                                                            📋 Relatório Médico Completo
                                                        </button>
                                                        <button 
                                                            onClick={() => {
                                                                window.print();
                                                            }}
                                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                                        >
                                                            🖨️ Imprimir
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            if (currentPage === 'delegations') {
                return (
                    <div className="min-h-screen bg-background text-foreground">
                        <Navigation />
                        <main className="max-w-7xl mx-auto py-8 px-4">
                            <div className="mb-8">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-card-foreground">Delegações Médicas</h2>
                                    <button
                                        onClick={() => document.getElementById('delegationModal').style.display = 'block'}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        + Nova Delegação
                                    </button>
                                </div>
                                
                                <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                    <div className="px-6 py-4 border-b border-border">
                                        <h3 className="text-lg font-semibold">Delegações Ativas</h3>
                                    </div>
                                    <div className="p-6">
                                        {delegations.length === 0 ? (
                                            <div className="text-center text-muted-foreground py-8">
                                                <div className="mb-4">👥</div>
                                                <p>Nenhuma delegação ativa</p>
                                                <p className="text-sm mt-2">Crie uma delegação para permitir que médicos acessem seus exames</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {delegations.map((delegation, index) => (
                                                    <div key={index} className="border border-border rounded-lg p-4">
                                                        <div className="flex justify-between items-start">
                                                            <div className="flex-1">
                                                                <div className="flex items-center space-x-3 mb-2">
                                                                    <h4 className="font-semibold text-card-foreground">
                                                                        Dr. {delegation.doctor_name}
                                                                    </h4>
                                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                                                        delegation.status === 'active' ? 'badge-success' :
                                                                        delegation.status === 'expired' ? 'badge-error' :
                                                                        'badge-warning'
                                                                    }`}>
                                                                        {delegation.status === 'active' ? 'Ativa' :
                                                                         delegation.status === 'expired' ? 'Expirada' : 'Pendente'}
                                                                    </span>
                                                                </div>
                                                                <p className="text-sm text-muted-foreground mb-2">
                                                                    CRM: {delegation.doctor_crm}
                                                                </p>
                                                                <p className="text-sm text-muted-foreground mb-3">
                                                                    Período: {new Date(delegation.start_date).toLocaleDateString('pt-BR')} até {new Date(delegation.end_date).toLocaleDateString('pt-BR')}
                                                                </p>
                                                                
                                                                <div className="mb-3">
                                                                    <p className="text-sm font-medium text-card-foreground mb-2">Permissões:</p>
                                                                    <div className="flex flex-wrap gap-2">
                                                                        {delegation.permissions.viewExams && (
                                                                            <span className="bg-blue-100 dark:bg-blue-900/20 text-blue-800 text-xs px-2 py-1 rounded">
                                                                                👁️ Visualizar exames
                                                                            </span>
                                                                        )}
                                                                        {delegation.permissions.downloadReports && (
                                                                            <span className="bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 text-xs px-2 py-1 rounded">
                                                                                📄 Baixar relatórios
                                                                            </span>
                                                                        )}
                                                                        {delegation.permissions.shareExams && (
                                                                            <span className="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">
                                                                                🔗 Compartilhar exames
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                
                                                                <p className="text-xs text-muted-foreground">
                                                                    Criada em: {new Date(delegation.created_at).toLocaleDateString('pt-BR')}
                                                                </p>
                                                            </div>
                                                            
                                                            <div className="flex space-x-2">
                                                                {delegation.status === 'active' && (
                                                                    <button 
                                                                        onClick={() => revokeDelegation(delegation.id)}
                                                                        className="text-red-600 hover:text-red-800 px-3 py-1 rounded text-sm"
                                                                    >
                                                                        Revogar
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div className="flex">
                                        <div className="flex-shrink-0">
                                            ℹ️
                                        </div>
                                        <div className="ml-3">
                                            <h3 className="text-sm font-medium text-blue-800">
                                                Sobre as Delegações
                                            </h3>
                                            <div className="mt-2 text-sm text-blue-800 dark:text-blue-300">
                                                <p>As delegações permitem que você autorize médicos específicos a acessar seus exames por um período determinado.</p>
                                                <ul className="list-disc list-inside mt-2 space-y-1">
                                                    <li>Você pode definir quais permissões cada médico terá</li>
                                                    <li>As delegações têm data de início e fim</li>
                                                    <li>Você pode revogar uma delegação a qualquer momento</li>
                                                    <li>O médico será notificado sobre a delegação</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            if (currentPage === 'settings') {
                return (
                    <div className="min-h-screen bg-background text-foreground">
                        <Navigation />
                        <main className="max-w-7xl mx-auto py-8 px-4">
                            <div className="mb-8">
                                <h2 className="text-3xl font-bold text-card-foreground mb-6">Configurações</h2>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                        <div className="px-6 py-4 border-b border-border">
                                            <h3 className="text-lg font-semibold">Notificações</h3>
                                        </div>
                                        <div className="p-6 space-y-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="font-medium">Email</p>
                                                    <p className="text-sm text-muted-foreground">Receber notificações por email</p>
                                                </div>
                                                <input
                                                    type="checkbox"
                                                    checked={userSettings.notifications.email}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        notifications: { ...prev.notifications, email: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="font-medium">SMS</p>
                                                    <p className="text-sm text-muted-foreground">Receber notificações por SMS</p>
                                                </div>
                                                <input
                                                    type="checkbox"
                                                    checked={userSettings.notifications.sms}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        notifications: { ...prev.notifications, sms: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="font-medium">Push</p>
                                                    <p className="text-sm text-muted-foreground">Notificações push no navegador</p>
                                                </div>
                                                <input
                                                    type="checkbox"
                                                    checked={userSettings.notifications.push}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        notifications: { ...prev.notifications, push: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                        <div className="px-6 py-4 border-b border-border">
                                            <h3 className="text-lg font-semibold">Privacidade</h3>
                                        </div>
                                        <div className="p-6 space-y-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="font-medium">Compartilhar com médicos</p>
                                                    <p className="text-sm text-muted-foreground">Permitir compartilhamento automático</p>
                                                </div>
                                                <input
                                                    type="checkbox"
                                                    checked={userSettings.privacy.shareWithDoctors}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        privacy: { ...prev.privacy, shareWithDoctors: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="font-medium">Pesquisa médica</p>
                                                    <p className="text-sm text-muted-foreground">Permitir uso em pesquisas anônimas</p>
                                                </div>
                                                <input
                                                    type="checkbox"
                                                    checked={userSettings.privacy.allowResearch}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        privacy: { ...prev.privacy, allowResearch: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6 bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover">
                                    <div className="px-6 py-4 border-b border-border">
                                        <h3 className="text-lg font-semibold">Preferências</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-card-foreground mb-2">Idioma</label>
                                                <select
                                                    value={userSettings.preferences.language}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        preferences: { ...prev.preferences, language: e.target.value }
                                                    }))}
                                                    className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                >
                                                    <option value="pt-BR">Português (Brasil)</option>
                                                    <option value="en-US">English (US)</option>
                                                    <option value="es-ES">Español</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-card-foreground mb-2">Fuso Horário</label>
                                                <select
                                                    value={userSettings.preferences.timezone}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        preferences: { ...prev.preferences, timezone: e.target.value }
                                                    }))}
                                                    className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                >
                                                    <option value="America/Sao_Paulo">São Paulo</option>
                                                    <option value="America/New_York">New York</option>
                                                    <option value="Europe/London">London</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-card-foreground mb-2">Formato de Data</label>
                                                <select
                                                    value={userSettings.preferences.dateFormat}
                                                    onChange={(e) => setUserSettings(prev => ({
                                                        ...prev,
                                                        preferences: { ...prev.preferences, dateFormat: e.target.value }
                                                    }))}
                                                    className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                >
                                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6 flex justify-end">
                                    <button className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                        Salvar Configurações
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            // Delegation modal - CONVERTED TO HTML
            if (false) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-card rounded-xl shadow-xl max-w-md w-full mx-4">
                            <div className="px-6 py-4 border-b border-border">
                                <h3 className="text-lg font-semibold">Nova Delegação Médica</h3>
                            </div>
                            <div className="p-6">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-card-foreground mb-2">CRM do Médico</label>
                                        <input
                                            type="text"
                                            value={delegationForm.doctorCrm}
                                            onChange={(e) => setDelegationForm(prev => ({ ...prev, doctorCrm: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Ex: 123456/SP"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-card-foreground mb-2">Data Início</label>
                                            <input
                                                type="date"
                                                value={delegationForm.startDate}
                                                onChange={(e) => setDelegationForm(prev => ({ ...prev, startDate: e.target.value }))}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-card-foreground mb-2">Data Fim</label>
                                            <input
                                                type="date"
                                                value={delegationForm.endDate}
                                                onChange={(e) => setDelegationForm(prev => ({ ...prev, endDate: e.target.value }))}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-card-foreground mb-3">Permissões</label>
                                        <div className="space-y-2">
                                            <label className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    checked={delegationForm.permissions.viewExams}
                                                    onChange={(e) => setDelegationForm(prev => ({
                                                        ...prev,
                                                        permissions: { ...prev.permissions, viewExams: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                                <span className="ml-2 text-sm text-card-foreground">Visualizar exames</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    checked={delegationForm.permissions.downloadReports}
                                                    onChange={(e) => setDelegationForm(prev => ({
                                                        ...prev,
                                                        permissions: { ...prev.permissions, downloadReports: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                                <span className="ml-2 text-sm text-card-foreground">Baixar relatórios</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    checked={delegationForm.permissions.shareExams}
                                                    onChange={(e) => setDelegationForm(prev => ({
                                                        ...prev,
                                                        permissions: { ...prev.permissions, shareExams: e.target.checked }
                                                    }))}
                                                    className="w-4 h-4 text-primary rounded focus:ring-blue-500"
                                                />
                                                <span className="ml-2 text-sm text-card-foreground">Compartilhar exames</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="px-6 py-4 border-t border-border flex justify-end space-x-3">
                                <button
                                    onClick={() => setShowDelegationModal(false)}
                                    className="px-4 py-2 text-muted-foreground hover:text-gray-800 transition-colors"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={createDelegation}
                                    disabled={!delegationForm.doctorCrm || !delegationForm.startDate || !delegationForm.endDate}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                                >
                                    Criar Delegação
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Upload modal - CONVERTED TO HTML
            if (false) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-card rounded-xl shadow-xl max-w-md w-full mx-4">
                            <div className="px-6 py-4 border-b border-border">
                                <h3 className="text-lg font-semibold">Upload de Arquivo</h3>
                            </div>
                            <div className="p-6">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-card-foreground mb-2">
                                            Selecione o arquivo
                                        </label>
                                        <input
                                            type="file"
                                            accept=".pdf,.jpg,.jpeg,.png,.dicom,.doc,.docx"
                                            onChange={(e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    uploadFile(file);
                                                }
                                            }}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                        <p className="text-xs text-muted-foreground mt-1">
                                            Formatos aceitos: PDF, JPG, PNG, DICOM, DOC, DOCX (máx: 50MB)
                                        </p>
                                    </div>
                                    
                                    {uploadProgress > 0 && (
                                        <div>
                                            <div className="flex justify-between text-sm text-muted-foreground mb-1">
                                                <span>Upload em progresso...</span>
                                                <span>{uploadProgress}%</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                <div 
                                                    className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                                    style={{ width: `${uploadProgress}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                        <div className="text-muted-foreground mb-2">📁</div>
                                        <p className="text-sm text-muted-foreground">
                                            Ou arraste e solte arquivos aqui
                                        </p>
                                    </div>
                                    
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <p className="text-xs text-blue-800 dark:text-blue-300">
                                            💡 Dica: Você também pode fazer upload de arquivos diretamente na página de detalhes de cada exame.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div className="px-6 py-4 border-t border-border flex justify-end">
                                <button
                                    onClick={() => {
                                        setUploadModalOpen(false);
                                        setUploadProgress(0);
                                    }}
                                    className="px-4 py-2 text-muted-foreground hover:text-gray-800 transition-colors"
                                >
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Share modal component (will be rendered later in the JSX)
            const ShareModal = () => {
                if (!showShareModal) return null;
                
                const currentExam = examsData.find(exam => exam.id === selectedExam);
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-card rounded-xl shadow-xl max-w-lg w-full mx-4">
                            {/* Header */}
                            <div className="px-6 py-4 border-b border-border">
                                <h3 className="text-xl font-semibold text-card-foreground">Compartilhar Exame com Médico</h3>
                                <p className="text-sm text-muted-foreground mt-1">
                                    Preencha os dados do médico para gerar um link de acesso seguro ao resultado do exame.
                                </p>
                            </div>
                            
                            {/* Exam Info */}
                            {currentExam && (
                                <div className="px-6 py-4 bg-blue-50 border-b border-border">
                                    <h4 className="font-semibold text-blue-900 uppercase text-sm">
                                        {currentExam.exam_type}
                                    </h4>
                                    <div className="text-sm text-blue-800 dark:text-blue-300 mt-1">
                                        <p>Realizado em: {new Date(currentExam.exam_date).toLocaleDateString('pt-BR')}</p>
                                        <p>Unidade: Unidade Paulista</p>
                                    </div>
                                </div>
                            )}
                            
                            {/* Form */}
                            <div className="p-6">
                                <div className="space-y-4">
                                    {/* CRM and Name Row */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-card-foreground mb-2">
                                                CRM do Médico <span className="text-destructive">*</span>
                                            </label>
                                            <input
                                                type="text"
                                                value={shareForm.doctorCrm}
                                                onChange={(e) => {
                                                    setShareForm(prev => ({ ...prev, doctorCrm: e.target.value.toUpperCase() }));
                                                    // Clear error when user starts typing
                                                    if (shareFormErrors.doctorCrm) {
                                                        setShareFormErrors(prev => ({ ...prev, doctorCrm: '' }));
                                                    }
                                                }}
                                                onBlur={() => {
                                                    const errors = validateShareForm();
                                                    setShareFormErrors(prev => ({ ...prev, doctorCrm: errors.doctorCrm || '' }));
                                                }}
                                                className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
                                                    shareFormErrors.doctorCrm 
                                                        ? 'border-red-300 focus:ring-red-500 focus:border-red-500' 
                                                        : 'border-gray-300 focus:ring-blue-500 focus:border-blue-500'
                                                }`}
                                                placeholder="000000/SP"
                                            />
                                            {shareFormErrors.doctorCrm && (
                                                <p className="mt-1 text-sm text-red-600">{shareFormErrors.doctorCrm}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-card-foreground mb-2">
                                                Nome do Médico <span className="text-destructive">*</span>
                                            </label>
                                            <input
                                                type="text"
                                                value={shareForm.doctorName}
                                                onChange={(e) => {
                                                    setShareForm(prev => ({ ...prev, doctorName: e.target.value }));
                                                    // Clear error when user starts typing
                                                    if (shareFormErrors.doctorName) {
                                                        setShareFormErrors(prev => ({ ...prev, doctorName: '' }));
                                                    }
                                                }}
                                                onBlur={() => {
                                                    const errors = validateShareForm();
                                                    setShareFormErrors(prev => ({ ...prev, doctorName: errors.doctorName || '' }));
                                                }}
                                                className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
                                                    shareFormErrors.doctorName 
                                                        ? 'border-red-300 focus:ring-red-500 focus:border-red-500' 
                                                        : 'border-gray-300 focus:ring-blue-500 focus:border-blue-500'
                                                }`}
                                                placeholder="Dr. João Silva"
                                            />
                                            {shareFormErrors.doctorName && (
                                                <p className="mt-1 text-sm text-red-600">{shareFormErrors.doctorName}</p>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Email */}
                                    <div>
                                        <label className="block text-sm font-medium text-card-foreground mb-2">
                                            E-mail do Médico <span className="text-destructive">*</span>
                                        </label>
                                        <input
                                            type="email"
                                            value={shareForm.doctorEmail}
                                            onChange={(e) => {
                                                setShareForm(prev => ({ ...prev, doctorEmail: e.target.value.toLowerCase().trim() }));
                                                // Clear error when user starts typing
                                                if (shareFormErrors.doctorEmail) {
                                                    setShareFormErrors(prev => ({ ...prev, doctorEmail: '' }));
                                                }
                                            }}
                                            onBlur={() => {
                                                const errors = validateShareForm();
                                                setShareFormErrors(prev => ({ ...prev, doctorEmail: errors.doctorEmail || '' }));
                                            }}
                                            className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
                                                shareFormErrors.doctorEmail 
                                                    ? 'border-red-300 focus:ring-red-500 focus:border-red-500' 
                                                    : 'border-gray-300 focus:ring-blue-500 focus:border-blue-500'
                                            }`}
                                            placeholder="medico@hospital.com.br"
                                        />
                                        {shareFormErrors.doctorEmail && (
                                            <p className="mt-1 text-sm text-red-600">{shareFormErrors.doctorEmail}</p>
                                        )}
                                    </div>
                                    
                                    {/* Message */}
                                    <div>
                                        <label className="block text-sm font-medium text-card-foreground mb-2">
                                            Mensagem (opcional)
                                        </label>
                                        <textarea
                                            value={shareForm.message}
                                            onChange={(e) => setShareForm(prev => ({ ...prev, message: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                                            rows="4"
                                            placeholder="Adicione uma mensagem para o médico..."
                                        />
                                    </div>
                                </div>
                                
                                {/* Warning */}
                                <div className="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <div className="flex items-start">
                                        <svg className="w-5 h-5 text-yellow-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                        <div>
                                            <p className="text-sm font-medium text-yellow-800">Importante:</p>
                                            <p className="text-sm text-yellow-700">
                                                O link de acesso será válido por 30 dias. O médico receberá um e-mail com as instruções de acesso.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Actions */}
                            <div className="px-6 py-4 border-t border-border flex justify-end space-x-3">
                                <button
                                    onClick={() => {
                                        setShowShareModal(false);
                                        setShareForm({ doctorCrm: '', doctorName: '', doctorEmail: '', message: '' });
                                        setShareFormErrors({});
                                    }}
                                    className="px-6 py-2 text-muted-foreground hover:text-gray-800 transition-colors font-medium"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={() => shareExam(selectedExam)}
                                    disabled={shareLoading || !shareForm.doctorCrm || !shareForm.doctorName || !shareForm.doctorEmail}
                                    className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                                >
                                    {shareLoading ? 'Compartilhando...' : 'Compartilhar Exame'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // PÁGINAS ADMINISTRATIVAS
            if (isAdminMode && adminUser) {
                return (
                    <div className="min-h-screen bg-slate-100">
                        {/* Admin Navigation */}
                        <nav className="bg-ctc-blue border-b border-ctc-blue-700 shadow-lg">
                            <div className="max-w-7xl mx-auto px-4">
                                <div className="flex justify-between h-16">
                                    <div className="flex items-center">
                                        <div className="flex-shrink-0 flex items-center">
                                            <img 
                                                src="./logos/logo negativo 1.png" 
                                                alt="CTC Logo" 
                                                className="h-8 w-auto mr-3"
                                            />
                                            <div>
                                                <h1 className="text-xl font-bold text-white">Portal Administrativo</h1>
                                            </div>
                                        </div>
                                        
                                        <div className="hidden lg:ml-6 lg:flex lg:space-x-2">
                                            <button
                                                onClick={() => setCurrentPage('admin-dashboard')}
                                                className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                    currentPage === 'admin-dashboard' 
                                                        ? 'bg-ctc-blue-800 text-white' 
                                                        : 'text-slate-300 hover:text-white hover:bg-ctc-blue-800'
                                                }`}
                                            >
                                                📊 Dashboard
                                            </button>
                                            <button
                                                onClick={() => setCurrentPage('admin-users')}
                                                className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                    currentPage === 'admin-users' 
                                                        ? 'bg-ctc-blue-800 text-white' 
                                                        : 'text-slate-300 hover:text-white hover:bg-ctc-blue-800'
                                                }`}
                                            >
                                                👥 Usuários
                                            </button>
                                            <button
                                                onClick={() => setCurrentPage('admin-branding')}
                                                className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                    currentPage === 'admin-branding' 
                                                        ? 'bg-ctc-blue-800 text-white' 
                                                        : 'text-slate-300 hover:text-white hover:bg-ctc-blue-800'
                                                }`}
                                            >
                                                🎨 Marca
                                            </button>
                                            <button
                                                onClick={() => setCurrentPage('admin-messaging')}
                                                className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                    currentPage === 'admin-messaging' 
                                                        ? 'bg-ctc-blue-800 text-white' 
                                                        : 'text-slate-300 hover:text-white hover:bg-ctc-blue-800'
                                                }`}
                                            >
                                                📱 APIs
                                            </button>
                                            <button
                                                onClick={() => setCurrentPage('admin-lgpd')}
                                                className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                    currentPage === 'admin-lgpd' 
                                                        ? 'bg-ctc-blue-800 text-white' 
                                                        : 'text-slate-300 hover:text-white hover:bg-ctc-blue-800'
                                                }`}
                                            >
                                                📄 LGPD
                                            </button>
                                            <button
                                                onClick={() => setCurrentPage('admin-reports')}
                                                className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                    currentPage === 'admin-reports' 
                                                        ? 'bg-ctc-blue-800 text-white' 
                                                        : 'text-slate-300 hover:text-white hover:bg-ctc-blue-800'
                                                }`}
                                            >
                                                📈 Relatórios
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center space-x-4">
                                        <span className="text-slate-300 text-xs hidden md:block">
                                            {adminUser.nome}
                                        </span>
                                        <button
                                            onClick={handleAdminLogout}
                                            className="bg-ctc-red hover:bg-ctc-red-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors"
                                        >
                                            Sair
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </nav>
                        
                        {/* Admin Content */}
                        <main className="max-w-7xl mx-auto py-8 px-4">
                            {currentPage === 'admin-dashboard' && (
                                <div className="space-y-8">
                                    <div className="flex justify-between items-center">
                                        <h1 className="text-3xl font-bold text-slate-900">Dashboard Administrativo</h1>
                                        <div className="text-sm text-slate-600">
                                            Último acesso: {new Date().toLocaleString('pt-BR')}
                                        </div>
                                    </div>
                                    
                                    {/* Cards de Estatísticas */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="flex-shrink-0">
                                                    <div className="w-8 h-8 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center">
                                                        <svg className="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Usuários Ativos</p>
                                                    <p className="text-2xl font-bold text-slate-900">1,247</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="flex-shrink-0">
                                                    <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                                        <svg className="w-5 h-5 text-green-700 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Exames (Este Mês)</p>
                                                    <p className="text-2xl font-bold text-slate-900">3,892</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="flex-shrink-0">
                                                    <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                                        <svg className="w-5 h-5 text-purple-700 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Compartilhamentos</p>
                                                    <p className="text-2xl font-bold text-slate-900">156</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="flex-shrink-0">
                                                    <div className="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                                        <svg className="w-5 h-5 text-orange-700 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Uptime</p>
                                                    <p className="text-2xl font-bold text-slate-900">99.9%</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Gráficos, status de sistema e atividade recente */}
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4">Exames por Mês</h3>
                                            <div className="h-48 flex items-center justify-center bg-slate-50 rounded-lg">
                                                <p className="text-slate-500">Gráfico será implementado aqui</p>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                                                <svg className="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                                </svg>
                                                Status do Sistema
                                            </h3>
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                                                    <div className="flex items-center">
                                                        <div className="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                                                        <span className="font-medium text-slate-700">Backend API</span>
                                                    </div>
                                                    <span className="text-green-800 dark:text-green-300 font-semibold text-sm">Online</span>
                                                </div>
                                                <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                    <div className="flex items-center">
                                                        <div className="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                                                        <span className="font-medium text-slate-700">Autenticação JWT</span>
                                                    </div>
                                                    <span className="text-blue-800 dark:text-blue-300 font-semibold text-sm">Ativo</span>
                                                </div>
                                                <div className="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200">
                                                    <div className="flex items-center">
                                                        <div className="w-3 h-3 bg-purple-500 rounded-full mr-3"></div>
                                                        <span className="font-medium text-slate-700">Banco SQLite</span>
                                                    </div>
                                                    <span className="text-purple-800 dark:text-purple-300 font-semibold text-sm">Conectado</span>
                                                </div>
                                                <div className="flex items-center justify-between p-3 bg-amber-50 rounded-lg border border-amber-200">
                                                    <div className="flex items-center">
                                                        <div className="w-3 h-3 bg-amber-500 rounded-full mr-3"></div>
                                                        <span className="font-medium text-slate-700">EmailJS</span>
                                                    </div>
                                                    <span className="text-amber-700 font-semibold text-sm">Configurado</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                                                <svg className="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                Atividade Recente
                                            </h3>
                                            <div className="space-y-3">
                                                <div className="flex items-center text-sm">
                                                    <div className="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                                    <div className="flex-1">
                                                        <span className="text-slate-600">Novo usuário cadastrado: João Silva</span>
                                                        <div className="text-xs text-slate-400">2min atrás</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center text-sm">
                                                    <div className="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                                    <div className="flex-1">
                                                        <span className="text-slate-600">Exame compartilhado com Dr. Pedro</span>
                                                        <div className="text-xs text-slate-400">15min atrás</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center text-sm">
                                                    <div className="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                                    <div className="flex-1">
                                                        <span className="text-slate-600">Backup automático concluído</span>
                                                        <div className="text-xs text-slate-400">1h atrás</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center text-sm">
                                                    <div className="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                                    <div className="flex-1">
                                                        <span className="text-slate-600">Configuração de marca atualizada</span>
                                                        <div className="text-xs text-slate-400">3h atrás</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* PÁGINA: GESTÃO DE USUÁRIOS & GRUPOS */}
                            {currentPage === 'admin-users' && (
                                <div className="space-y-8">
                                    <div className="flex justify-between items-center">
                                        <h1 className="text-3xl font-bold text-slate-900">Gestão de Usuários & Grupos</h1>
                                        <div className="space-x-3">
                                            <button 
                                                onClick={() => {
                                                    alert('✅ Teste bem-sucedido!\n\nTodos os botões estão funcionando perfeitamente!\n\n🎉 Sistema administrativo totalmente operacional!');
                                                    console.log('Sistema administrativo totalmente funcional');
                                                }}
                                                className="bg-torre-itsm hover:bg-torre-itsm-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                                            >
                                                🧪 Teste
                                            </button>
                                            <button 
                                                onClick={() => openNewUserModal()}
                                                className="bg-torre-digital hover:bg-torre-digital-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                                            >
                                                + Novo Usuário
                                            </button>
                                            <button 
                                                onClick={() => openGroupsModal()}
                                                className="bg-torre-digital hover:bg-torre-digital-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                                            >
                                                📋 Ver Grupos
                                            </button>
                                            <button 
                                                onClick={() => setCurrentPage('admin-lgpd')}
                                                className="bg-torre-itsm hover:bg-torre-itsm-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                                            >
                                                📄 Termos LGPD
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Estatísticas de usuários */}
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center">
                                                    <svg className="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                                                    </svg>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Total de Usuários</p>
                                                    <p className="text-2xl font-bold text-slate-900">{userStats.total}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                                    <svg className="w-6 h-6 text-green-700 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Usuários Ativos</p>
                                                    <p className="text-2xl font-bold text-green-800 dark:text-green-300">{userStats.active}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                                                    <svg className="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.634 0L4.168 18.5c-.77.833.192 2.5 1.732 2.5z" />
                                                    </svg>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Bloqueados</p>
                                                    <p className="text-2xl font-bold text-amber-700">{userStats.blocked}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <div className="flex items-center">
                                                <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                                    <svg className="w-6 h-6 text-purple-700 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                    </svg>
                                                </div>
                                                <div className="ml-4">
                                                    <p className="text-sm font-medium text-slate-600">Grupos</p>
                                                    <p className="text-2xl font-bold text-purple-800 dark:text-purple-300">{userStats.groups}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Filtros e busca */}
                                    <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                        <div className="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                                            <div className="flex items-center space-x-4">
                                                <div className="relative">
                                                    <svg className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                    </svg>
                                                    <input 
                                                        type="text" 
                                                        placeholder="Buscar usuários..." 
                                                        value={userFilters.search}
                                                        onChange={(e) => setUserFilters(prev => ({ ...prev, search: e.target.value }))}
                                                        className="pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                    />
                                                </div>
                                                <select 
                                                    value={userFilters.status}
                                                    onChange={(e) => setUserFilters(prev => ({ ...prev, status: e.target.value }))}
                                                    className="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                >
                                                    <option value="">Todos os status</option>
                                                    <option value="ativo">Ativo</option>
                                                    <option value="inativo">Inativo</option>
                                                    <option value="bloqueado">Bloqueado</option>
                                                </select>
                                                <select 
                                                    value={userFilters.group}
                                                    onChange={(e) => setUserFilters(prev => ({ ...prev, group: e.target.value }))}
                                                    className="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                >
                                                    <option value="">Todos os grupos</option>
                                                    <option value="admin">Administradores</option>
                                                    <option value="medico">Médicos</option>
                                                    <option value="paciente">Pacientes</option>
                                                    <option value="recepcao">Recepção</option>
                                                </select>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <button 
                                                    onClick={() => loadAdminUsers()}
                                                    className="px-4 py-2 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
                                                >
                                                    🔄 Atualizar
                                                </button>
                                                <button 
                                                    onClick={() => {
                                                        const csvData = adminUsers.map(user => ({
                                                            Nome: user.nome,
                                                            Email: user.email,
                                                            CPF: user.cpf,
                                                            Status: user.ativo ? 'Ativo' : 'Inativo',
                                                            'Último Acesso': user.ultimo_login || 'Nunca'
                                                        }));
                                                        const csv = csvData.map(row => Object.values(row).join(',')).join('\n');
                                                        const header = Object.keys(csvData[0] || {}).join(',') + '\n';
                                                        const blob = new Blob([header + csv], { type: 'text/csv' });
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = `usuarios_${new Date().toISOString().split('T')[0]}.csv`;
                                                        a.click();
                                                        URL.revokeObjectURL(url);
                                                        addToast('Lista de usuários exportada com sucesso', 'success');
                                                    }}
                                                    className="px-4 py-2 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
                                                >
                                                    📊 Exportar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Tabela de usuários */}
                                    <div className="bg-card rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full divide-y divide-slate-200">
                                                <thead className="bg-slate-50">
                                                    <tr>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Usuário</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Grupo</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Último acesso</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-card divide-y divide-slate-200">
                                                    {adminUsers.length === 0 ? (
                                                        <tr>
                                                            <td colSpan={6} className="px-6 py-8 text-center text-slate-500">
                                                                {loading ? (
                                                                    <div className="flex items-center justify-center">
                                                                        <div className="loading-spinner w-6 h-6 border-2 border-slate-300 border-t-blue-600 rounded-full mr-3"></div>
                                                                        Carregando usuários...
                                                                    </div>
                                                                ) : (
                                                                    'Nenhum usuário encontrado'
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ) : (
                                                        adminUsers.map((user, index) => {
                                                            const initials = user.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                                                            const isBlocked = user.bloqueado_ate && new Date(user.bloqueado_ate) > new Date();
                                                            const statusColor = isBlocked ? 'amber' : user.ativo ? 'green' : 'red';
                                                            const statusText = isBlocked ? 'Bloqueado' : user.ativo ? 'Ativo' : 'Inativo';
                                                            const groupColor = user.grupo === 'admin' ? 'red' : user.grupo === 'medico' ? 'blue' : user.grupo === 'recepcao' ? 'orange' : 'purple';
                                                            const groupText = user.grupo === 'admin' ? 'Admin' : user.grupo === 'medico' ? 'Médico' : user.grupo === 'recepcao' ? 'Recepção' : 'Paciente';
                                                            
                                                            return (
                                                                <tr key={user.id} className="hover:bg-slate-50">
                                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                                        <div className="flex items-center">
                                                                            <div className={`w-10 h-10 bg-${groupColor}-500 rounded-full flex items-center justify-center`}>
                                                                                <span className="text-white font-medium text-sm">{initials}</span>
                                                                            </div>
                                                                            <div className="ml-4">
                                                                                <div className="text-sm font-medium text-slate-900">{user.nome}</div>
                                                                                <div className="text-sm text-slate-500">ID: {user.id} • CPF: {user.cpf}</div>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-900">{user.email}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                                        <span className={`px-2 py-1 text-xs font-medium bg-${groupColor}-100 text-${groupColor}-800 rounded-full`}>
                                                                            {groupText}
                                                                        </span>
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                                        <span className={`px-2 py-1 text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800 rounded-full`}>
                                                                            {statusText}
                                                                        </span>
                                                                        {user.tentativas_login > 0 && (
                                                                            <div className="text-xs text-amber-600 mt-1">
                                                                                Tentativas: {user.tentativas_login}/5
                                                                            </div>
                                                                        )}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                                                                        {user.ultimo_login ? new Date(user.ultimo_login).toLocaleString('pt-BR') : 'Nunca'}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                                                        <button 
                                                                            onClick={() => openEditUserModal(user)}
                                                                            className="text-primary hover:text-primary/80 transition-colors"
                                                                        >
                                                                            ✏️ Editar
                                                                        </button>
                                                                        {isBlocked ? (
                                                                            <button 
                                                                                onClick={() => unlockUser(user.id)}
                                                                                className="text-green-700 dark:text-green-400 hover:text-green-800 transition-colors"
                                                                                disabled={loading}
                                                                            >
                                                                                🔓 Desbloquear
                                                                            </button>
                                                                        ) : (
                                                                            <button 
                                                                                onClick={() => toggleUserStatus(user.id, !user.ativo)}
                                                                                className={`${user.ativo ? 'text-red-600 hover:text-red-800' : 'text-green-700 dark:text-green-400 hover:text-green-800'} transition-colors`}
                                                                                disabled={loading}
                                                                            >
                                                                                {user.ativo ? '🚫 Desativar' : '✅ Ativar'}
                                                                            </button>
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="px-6 py-3 border-t border-slate-200 flex items-center justify-between">
                                            <div className="text-sm text-slate-500">
                                                Mostrando {Math.min((userPagination.page - 1) * userPagination.limit + 1, userPagination.total)}-{Math.min(userPagination.page * userPagination.limit, userPagination.total)} de {userPagination.total} usuários
                                            </div>
                                            <div className="flex space-x-2">
                                                <button 
                                                    onClick={() => {
                                                        if (userPagination.page > 1) {
                                                            setUserPagination(prev => ({ ...prev, page: prev.page - 1 }));
                                                        }
                                                    }}
                                                    disabled={userPagination.page <= 1}
                                                    className="px-3 py-1 text-sm text-slate-600 border border-slate-300 rounded hover:bg-slate-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    ← Anterior
                                                </button>
                                                {Array.from({ length: Math.min(5, userPagination.totalPages) }, (_, i) => {
                                                    const startPage = Math.max(1, userPagination.page - 2);
                                                    const pageNum = startPage + i;
                                                    if (pageNum > userPagination.totalPages) return null;
                                                    return (
                                                        <button 
                                                            key={pageNum}
                                                            onClick={() => setUserPagination(prev => ({ ...prev, page: pageNum }))}
                                                            className={`px-3 py-1 text-sm rounded transition-colors ${
                                                                pageNum === userPagination.page 
                                                                    ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                                                    : 'text-slate-600 border border-slate-300 hover:bg-slate-50'
                                                            }`}
                                                        >
                                                            {pageNum}
                                                        </button>
                                                    );
                                                })}
                                                <button 
                                                    onClick={() => {
                                                        if (userPagination.page < userPagination.totalPages) {
                                                            setUserPagination(prev => ({ ...prev, page: prev.page + 1 }));
                                                        }
                                                    }}
                                                    disabled={userPagination.page >= userPagination.totalPages}
                                                    className="px-3 py-1 text-sm text-slate-600 border border-slate-300 rounded hover:bg-slate-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    Próximo →
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* PÁGINA: MARCA & VISUAL (WHITELABEL) */}
                            {currentPage === 'admin-branding' && (
                                <div className="space-y-8">
                                    <div className="flex justify-between items-center">
                                        <h1 className="text-3xl font-bold text-slate-900">Configuração de Marca & Visual</h1>
                                        <button 
                                            onClick={() => saveHospitalSettingsHTML()}
                                            className="bg-torre-digital hover:bg-torre-digital-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center"
                                        >
                                            {loading ? (
                                                <div className="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                            ) : (
                                                '💾 '
                                            )}
                                            Salvar Alterações
                                        </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        {/* Configurações de marca */}
                                        <div className="space-y-6">
                                            <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                                <h3 className="text-lg font-semibold text-slate-900 mb-4">Informações da Instituição</h3>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Nome da Instituição</label>
                                                        <input 
                                                            type="text" 
                                                            value={hospitalSettings.name}
                                                            onChange={(e) => setHospitalSettings(prev => ({ ...prev, name: e.target.value }))}
                                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Logo da Instituição</label>
                                                        <div className="flex items-center space-x-4">
                                                            <div className="w-16 h-16 bg-card border-2 border-slate-300 rounded-lg flex items-center justify-center p-2">
                                                                <img 
                                                                    src="./logos/logo 2.png" 
                                                                    alt="Logo Atual CTC" 
                                                                    className="w-full h-full object-contain"
                                                                />
                                                            </div>
                                                            <div>
                                                                <div>
                                                                    <input 
                                                                        type="file" 
                                                                        id="logoUpload" 
                                                                        accept="image/*" 
                                                                        style={{ display: 'none' }} 
                                                                        onChange={(e) => {
                                                                            const file = e.target.files[0];
                                                                            if (file) handleLogoUpload(file);
                                                                        }}
                                                                    />
                                                                    <button 
                                                                        onClick={() => document.getElementById('logoUpload').click()}
                                                                        disabled={loading}
                                                                        className="bg-torre-digital hover:bg-torre-digital-700 text-white px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                                                                    >
                                                                        {loading ? (
                                                                            <div className="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                                        ) : (
                                                                            '📁 '
                                                                        )}
                                                                        Escolher Logo
                                                                    </button>
                                                                </div>
                                                                <p className="text-xs text-slate-500 mt-1">PNG, JPG até 2MB. Recomendado: 200x200px</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Biblioteca de Logos CTC */}
                                            <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                                <h3 className="text-lg font-semibold text-slate-900 mb-4">Biblioteca de Logos CTC</h3>
                                                <p className="text-sm text-slate-600 mb-4">Logos oficiais disponíveis para uso no sistema</p>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    {/* Logo Principal */}
                                                    <div className="border border-slate-200 rounded-lg p-4 bg-slate-50">
                                                        <img 
                                                            src="./logos/logo 2.png" 
                                                            alt="Logo CTC Principal" 
                                                            className="h-12 w-auto mx-auto mb-2"
                                                        />
                                                        <div className="text-center text-xs text-slate-600">Logo Principal</div>
                                                    </div>

                                                    {/* Logo Símbolo */}
                                                    <div className="border border-slate-200 rounded-lg p-4 bg-slate-50">
                                                        <img 
                                                            src="./logos/Imagem1.png" 
                                                            alt="Símbolo CTC" 
                                                            className="h-12 w-auto mx-auto mb-2"
                                                        />
                                                        <div className="text-center text-xs text-slate-600">Símbolo</div>
                                                    </div>

                                                    {/* Logo Completo */}
                                                    <div className="border border-slate-200 rounded-lg p-4 bg-slate-50">
                                                        <img 
                                                            src="./logos/logo 3.png" 
                                                            alt="Logo CTC Completo" 
                                                            className="h-12 w-auto mx-auto mb-2"
                                                        />
                                                        <div className="text-center text-xs text-slate-600">Logo com Slogan</div>
                                                    </div>

                                                    {/* Logo Negativo */}
                                                    <div className="border border-slate-200 rounded-lg p-4 bg-slate-800">
                                                        <img 
                                                            src="./logos/logo negativo 1.png" 
                                                            alt="Logo CTC Negativo" 
                                                            className="h-12 w-auto mx-auto mb-2"
                                                        />
                                                        <div className="text-center text-xs text-white">Logo Negativo</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Paleta CTC */}
                                            <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                                <h3 className="text-lg font-semibold text-slate-900 mb-4">Paleta Cromática CTC</h3>
                                                <p className="text-sm text-slate-600 mb-4">Cores institucionais definidas no manual da marca</p>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    {/* Azul CTC */}
                                                    <div className="border border-slate-200 rounded-lg p-3">
                                                        <div className="flex items-center space-x-3 mb-2">
                                                            <div className="w-8 h-8 bg-ctc-blue rounded-lg border border-slate-200"></div>
                                                            <div>
                                                                <div className="font-medium text-sm">Azul CTC</div>
                                                                <div className="text-xs text-slate-500">#004497</div>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => setHospitalSettings(prev => ({ ...prev, primaryColor: '#004497' }))}
                                                            className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition-colors"
                                                        >
                                                            Aplicar como Primária
                                                        </button>
                                                    </div>

                                                    {/* Torre Digital */}
                                                    <div className="border border-slate-200 rounded-lg p-3">
                                                        <div className="flex items-center space-x-3 mb-2">
                                                            <div className="w-8 h-8 bg-torre-digital rounded-lg border border-slate-200"></div>
                                                            <div>
                                                                <div className="font-medium text-sm">Portal de Exames CTC</div>
                                                                <div className="text-xs text-slate-500">#cc0066</div>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => setHospitalSettings(prev => ({ ...prev, secondaryColor: '#cc0066' }))}
                                                            className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition-colors"
                                                        >
                                                            Aplicar como Secundária
                                                        </button>
                                                    </div>

                                                    {/* Vermelho CTC */}
                                                    <div className="border border-slate-200 rounded-lg p-3">
                                                        <div className="flex items-center space-x-3 mb-2">
                                                            <div className="w-8 h-8 bg-ctc-red rounded-lg border border-slate-200"></div>
                                                            <div>
                                                                <div className="font-medium text-sm">Vermelho CTC</div>
                                                                <div className="text-xs text-slate-500">#ff3c3c</div>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => setHospitalSettings(prev => ({ ...prev, accentColor: '#ff3c3c' }))}
                                                            className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition-colors"
                                                        >
                                                            Aplicar como Destaque
                                                        </button>
                                                    </div>

                                                    {/* Torre Health */}
                                                    <div className="border border-slate-200 rounded-lg p-3">
                                                        <div className="flex items-center space-x-3 mb-2">
                                                            <div className="w-8 h-8 bg-torre-health rounded-lg border border-slate-200"></div>
                                                            <div>
                                                                <div className="font-medium text-sm">Torre Health</div>
                                                                <div className="text-xs text-slate-500">#00cdcd</div>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => setHospitalSettings(prev => ({ ...prev, accentColor: '#00cdcd' }))}
                                                            className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition-colors"
                                                        >
                                                            Aplicar como Destaque
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                                <h3 className="text-lg font-semibold text-slate-900 mb-4">Personalização de Cores</h3>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Cor Primária</label>
                                                        <div className="flex items-center space-x-3">
                                                            <input 
                                                                type="color" 
                                                                value={hospitalSettings.primaryColor}
                                                                onChange={(e) => setHospitalSettings(prev => ({ ...prev, primaryColor: e.target.value }))}
                                                                className="w-12 h-12 border border-slate-300 rounded-lg cursor-pointer"
                                                            />
                                                            <input 
                                                                type="text" 
                                                                value={hospitalSettings.primaryColor}
                                                                onChange={(e) => setHospitalSettings(prev => ({ ...prev, primaryColor: e.target.value }))}
                                                                className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Cor Secundária</label>
                                                        <div className="flex items-center space-x-3">
                                                            <input 
                                                                type="color" 
                                                                value={hospitalSettings.secondaryColor}
                                                                onChange={(e) => setHospitalSettings(prev => ({ ...prev, secondaryColor: e.target.value }))}
                                                                className="w-12 h-12 border border-slate-300 rounded-lg cursor-pointer"
                                                            />
                                                            <input 
                                                                type="text" 
                                                                value={hospitalSettings.secondaryColor}
                                                                onChange={(e) => setHospitalSettings(prev => ({ ...prev, secondaryColor: e.target.value }))}
                                                                className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Cor de Destaque</label>
                                                        <div className="flex items-center space-x-3">
                                                            <input 
                                                                type="color" 
                                                                defaultValue={hospitalSettings.accentColor}
                                                                className="w-12 h-12 border border-slate-300 rounded-lg cursor-pointer"
                                                            />
                                                            <input 
                                                                type="text" 
                                                                defaultValue={hospitalSettings.accentColor}
                                                                className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Preview */}
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4">Preview da Interface</h3>
                                            <div className="border border-slate-200 rounded-lg p-4 bg-slate-50">
                                                <div className="space-y-4">
                                                    <div className="flex items-center justify-between p-3 bg-card rounded-lg shadow-sm">
                                                        <div className="flex items-center space-x-3">
                                                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                                                <span className="text-white text-sm font-bold">H</span>
                                                            </div>
                                                            <span className="font-semibold text-slate-900">{hospitalSettings.name}</span>
                                                        </div>
                                                        <div className="w-8 h-8 bg-slate-200 rounded-full"></div>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div className="bg-blue-600 text-white p-3 rounded-lg text-center text-sm font-medium">
                                                            Botão Primário
                                                        </div>
                                                        <div className="bg-slate-100 text-slate-700 p-3 rounded-lg text-center text-sm font-medium border">
                                                            Botão Secundário
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="bg-card p-3 rounded-lg border border-slate-200">
                                                        <div className="flex items-center space-x-2 mb-2">
                                                            <div className="w-3 h-3 bg-blue-600 rounded-full"></div>
                                                            <span className="text-sm font-medium">Card de Exame</span>
                                                        </div>
                                                        <p className="text-xs text-slate-600">Exemplo de como ficará a interface com suas cores</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                                <div className="flex items-start space-x-3">
                                                    <svg className="w-5 h-5 text-primary mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    <div>
                                                        <p className="text-sm font-medium text-blue-900">Dica de Personalização</p>
                                                        <p className="text-sm text-blue-800 dark:text-blue-300 mt-1">
                                                            As cores serão aplicadas automaticamente em toda a interface. 
                                                            Teste diferentes combinações para encontrar a identidade visual ideal.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {currentPage === 'admin-lgpd' && (
                                <div className="space-y-8">
                                    <div className="flex justify-between items-center">
                                        <h1 className="text-3xl font-bold text-slate-900">Termos LGPD & Privacidade</h1>
                                        <div className="flex space-x-3">
                                            <button 
                                                onClick={() => setLgpdPreviewMode(!lgpdPreviewMode)}
                                                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                    lgpdPreviewMode 
                                                        ? 'bg-gray-600 hover:bg-gray-700 text-white' 
                                                        : 'bg-torre-digital hover:bg-torre-digital-700 text-white'
                                                }`}
                                            >
                                                {lgpdPreviewMode ? '✏️ Editar' : '👁️ Pré-visualizar'}
                                            </button>
                                            <button 
                                                onClick={() => saveLGPDTerms()}
                                                className="bg-torre-itsm hover:bg-torre-itsm-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                                            >
                                                💾 Salvar Termos
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 gap-8">
                                        {/* Editor/Pré-visualização de Termos */}
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200">
                                            <div className="px-6 py-4 border-b border-border">
                                                <h3 className="text-lg font-semibold text-slate-900">
                                                    {lgpdPreviewMode ? 'Pré-visualização dos Termos' : 'Editor de Termos LGPD'}
                                                </h3>
                                                <p className="text-sm text-slate-600 mt-1">
                                                    {lgpdPreviewMode 
                                                        ? 'Visualize como os termos aparecerão para os pacientes'
                                                        : 'Use Markdown para formatar o conteúdo dos termos'
                                                    }
                                                </p>
                                            </div>
                                            
                                            <div className="p-6">
                                                {!lgpdPreviewMode ? (
                                                    <div className="space-y-4">
                                                        <div className="flex justify-between items-center">
                                                            <label className="block text-sm font-medium text-card-foreground">
                                                                Conteúdo dos Termos (Markdown)
                                                            </label>
                                                            <div className="flex space-x-2 text-xs text-muted-foreground">
                                                                <span>Suporte: **negrito**, *itálico*, # títulos, - listas</span>
                                                            </div>
                                                        </div>
                                                        <textarea
                                                            value={lgpdTermsContent}
                                                            onChange={(e) => setLgpdTermsContent(e.target.value)}
                                                            rows={20}
                                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                                            placeholder="# Termos de Uso e Política de Privacidade&#10;&#10;## 1. Coleta de Dados&#10;&#10;Coletamos os seguintes dados pessoais:&#10;&#10;- **Dados de identificação**: nome, CPF, RG&#10;- **Dados de contato**: email, telefone, endereço&#10;- **Dados de saúde**: informações médicas e resultados de exames&#10;&#10;## 2. Finalidade do Tratamento&#10;&#10;Os dados são utilizados para:&#10;&#10;- Prestação de serviços médicos&#10;- Comunicação com pacientes&#10;- Cumprimento de obrigações legais&#10;&#10;..."
                                                        />
                                                    </div>
                                                ) : (
                                                    <div className="prose max-w-none">
                                                        <div 
                                                            className="border border-border rounded-lg p-6 bg-secondary min-h-96"
                                                            dangerouslySetInnerHTML={{ 
                                                                __html: renderMarkdown(lgpdTermsContent) 
                                                            }}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Configurações dos Termos */}
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200">
                                            <div className="px-6 py-4 border-b border-border">
                                                <h3 className="text-lg font-semibold text-slate-900">Configurações dos Termos</h3>
                                                <p className="text-sm text-slate-600 mt-1">
                                                    Configure quando e como os termos serão apresentados aos usuários
                                                </p>
                                            </div>
                                            
                                            <div className="p-6 space-y-6">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <div>
                                                        <label className="block text-sm font-medium text-card-foreground mb-2">
                                                            Versão dos Termos
                                                        </label>
                                                        <input
                                                            type="text"
                                                            value={lgpdTermsVersion}
                                                            onChange={(e) => setLgpdTermsVersion(e.target.value)}
                                                            className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                            placeholder="Ex: v2.1"
                                                        />
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-sm font-medium text-card-foreground mb-2">
                                                            Data de Vigência
                                                        </label>
                                                        <input
                                                            type="date"
                                                            value={lgpdEffectiveDate}
                                                            onChange={(e) => setLgpdEffectiveDate(e.target.value)}
                                                            className="w-full px-3 py-2 border border-input bg-card text-card-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-4">
                                                    <div className="flex items-center">
                                                        <input
                                                            type="checkbox"
                                                            id="forceAcceptance"
                                                            checked={lgpdForceAcceptance}
                                                            onChange={(e) => setLgpdForceAcceptance(e.target.checked)}
                                                            className="h-4 w-4 text-primary border-gray-300 rounded focus:ring-blue-500"
                                                        />
                                                        <label htmlFor="forceAcceptance" className="ml-2 text-sm text-card-foreground">
                                                            Forçar aceitação dos novos termos para todos os usuários
                                                        </label>
                                                    </div>
                                                    
                                                    <div className="flex items-center">
                                                        <input
                                                            type="checkbox"
                                                            id="showOnFirstLogin"
                                                            checked={lgpdShowOnFirstLogin}
                                                            onChange={(e) => setLgpdShowOnFirstLogin(e.target.checked)}
                                                            className="h-4 w-4 text-primary border-gray-300 rounded focus:ring-blue-500"
                                                        />
                                                        <label htmlFor="showOnFirstLogin" className="ml-2 text-sm text-card-foreground">
                                                            Exibir termos obrigatoriamente no primeiro login
                                                        </label>
                                                    </div>
                                                    
                                                    <div className="flex items-center">
                                                        <input
                                                            type="checkbox"
                                                            id="allowDownload"
                                                            checked={lgpdAllowDownload}
                                                            onChange={(e) => setLgpdAllowDownload(e.target.checked)}
                                                            className="h-4 w-4 text-primary border-gray-300 rounded focus:ring-blue-500"
                                                        />
                                                        <label htmlFor="allowDownload" className="ml-2 text-sm text-card-foreground">
                                                            Permitir download dos termos em PDF
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div className="border-t pt-4">
                                                    <h4 className="text-sm font-medium text-card-foreground mb-3">Estatísticas de Aceitação</h4>
                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                        <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                                                            <div className="text-sm text-green-700 dark:text-green-400 font-medium">Usuários que Aceitaram</div>
                                                            <div className="text-2xl font-bold text-green-800">1,156</div>
                                                        </div>
                                                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                                            <div className="text-sm text-yellow-600 font-medium">Pendente de Aceitação</div>
                                                            <div className="text-2xl font-bold text-yellow-800">42</div>
                                                        </div>
                                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                            <div className="text-sm text-primary font-medium">Taxa de Aceitação</div>
                                                            <div className="text-2xl font-bold text-blue-800">96.5%</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {currentPage === 'admin-messaging' && (
                                <div className="space-y-8">
                                    <div className="flex justify-between items-center">
                                        <h1 className="text-3xl font-bold text-slate-900">APIs & Configuração de Mensageria</h1>
                                        <button 
                                            onClick={() => alert('Configurações salvas com sucesso!')}
                                            className="bg-torre-itsm hover:bg-torre-itsm-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                                        >
                                            💾 Salvar Configurações
                                        </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        {/* Configurações de Email */}
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4">📧 Configuração de Email (SMTP)</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Provedor</label>
                                                    <select
                                                        value={messagingConfig.email.provider}
                                                        onChange={(e) => setMessagingConfig(prev => ({
                                                            ...prev,
                                                            email: { ...prev.email, provider: e.target.value }
                                                        }))}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    >
                                                        <option value="smtp">SMTP Personalizado</option>
                                                        <option value="gmail">Gmail</option>
                                                        <option value="outlook">Outlook</option>
                                                        <option value="sendgrid">SendGrid</option>
                                                        <option value="mailgun">Mailgun</option>
                                                    </select>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Servidor SMTP</label>
                                                        <input
                                                            type="text"
                                                            placeholder="smtp.gmail.com"
                                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Porta</label>
                                                        <input
                                                            type="number"
                                                            placeholder="587"
                                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                                    <input
                                                        type="email"
                                                        placeholder="noreply@ctc.com.br"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Senha/Token</label>
                                                    <input
                                                        type="password"
                                                        placeholder="••••••••"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div className="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        id="emailSSL"
                                                        className="h-4 w-4 text-primary border-gray-300 rounded focus:ring-blue-500"
                                                    />
                                                    <label htmlFor="emailSSL" className="ml-2 text-sm text-slate-700">
                                                        Usar SSL/TLS
                                                    </label>
                                                </div>
                                                
                                                <button className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                                    🧪 Testar Conexão
                                                </button>
                                            </div>
                                        </div>

                                        {/* Configurações de SMS */}
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4">📱 Configuração de SMS</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Provedor</label>
                                                    <select
                                                        value={messagingConfig.sms.provider}
                                                        onChange={(e) => setMessagingConfig(prev => ({
                                                            ...prev,
                                                            sms: { ...prev.sms, provider: e.target.value }
                                                        }))}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    >
                                                        <option value="twilio">Twilio</option>
                                                        <option value="nexmo">Vonage (Nexmo)</option>
                                                        <option value="aws-sns">AWS SNS</option>
                                                        <option value="zenvia">Zenvia</option>
                                                        <option value="totalvoice">TotalVoice</option>
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Account SID</label>
                                                    <input
                                                        type="text"
                                                        placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Auth Token</label>
                                                    <input
                                                        type="password"
                                                        placeholder="••••••••••••••••••••••••••••••••"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Número Remetente</label>
                                                    <input
                                                        type="tel"
                                                        placeholder="+5511999999999"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                                    <div className="text-sm text-yellow-800">
                                                        <strong>💡 Dica:</strong> Certifique-se de que o número foi verificado no painel do provedor.
                                                    </div>
                                                </div>
                                                
                                                <button className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                                    🧪 Enviar SMS Teste
                                                </button>
                                            </div>
                                        </div>

                                        {/* Configurações de WhatsApp */}
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4">💬 Configuração de WhatsApp Business</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Provedor</label>
                                                    <select
                                                        value={messagingConfig.whatsapp.provider}
                                                        onChange={(e) => setMessagingConfig(prev => ({
                                                            ...prev,
                                                            whatsapp: { ...prev.whatsapp, provider: e.target.value }
                                                        }))}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    >
                                                        <option value="twilio">Twilio WhatsApp</option>
                                                        <option value="360dialog">360dialog</option>
                                                        <option value="maytapi">Maytapi</option>
                                                        <option value="gupshup">Gupshup</option>
                                                        <option value="meta">Meta WhatsApp Business</option>
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Phone Number ID</label>
                                                    <input
                                                        type="text"
                                                        placeholder="1234567890123456"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Access Token</label>
                                                    <input
                                                        type="password"
                                                        placeholder="••••••••••••••••••••••••••••••••"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Webhook URL</label>
                                                    <input
                                                        type="url"
                                                        placeholder="https://ctc.com.br/webhook/whatsapp"
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                                
                                                <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                                                    <div className="text-sm text-green-800">
                                                        <strong>✅ Status:</strong> Conectado e verificado
                                                    </div>
                                                </div>
                                                
                                                <button className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                                    🧪 Enviar Mensagem Teste
                                                </button>
                                            </div>
                                        </div>

                                        {/* APIs Disponíveis */}
                                        <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-6">
                                            <h3 className="text-lg font-semibold text-slate-900 mb-4">🔌 APIs Disponíveis</h3>
                                            <div className="space-y-4">
                                                <div className="border border-slate-200 rounded-lg p-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h4 className="font-medium text-slate-900">API de Exames</h4>
                                                        <span className="bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 text-xs px-2 py-1 rounded-full">Ativa</span>
                                                    </div>
                                                    <p className="text-sm text-slate-600 mb-3">Permite consultar e compartilhar exames via API REST</p>
                                                    <div className="text-xs font-mono bg-slate-100 p-2 rounded">
                                                        GET /api/v1/exams/{id}
                                                    </div>
                                                </div>

                                                <div className="border border-slate-200 rounded-lg p-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h4 className="font-medium text-slate-900">API de Usuários</h4>
                                                        <span className="bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 text-xs px-2 py-1 rounded-full">Ativa</span>
                                                    </div>
                                                    <p className="text-sm text-slate-600 mb-3">Gerenciamento de usuários e autenticação</p>
                                                    <div className="text-xs font-mono bg-slate-100 p-2 rounded">
                                                        POST /api/v1/auth/login
                                                    </div>
                                                </div>

                                                <div className="border border-slate-200 rounded-lg p-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h4 className="font-medium text-slate-900">API de Notificações</h4>
                                                        <span className="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300 text-xs px-2 py-1 rounded-full">Configurando</span>
                                                    </div>
                                                    <p className="text-sm text-slate-600 mb-3">Envio de notificações via email, SMS e WhatsApp</p>
                                                    <div className="text-xs font-mono bg-slate-100 p-2 rounded">
                                                        POST /api/v1/notifications/send
                                                    </div>
                                                </div>

                                                <button className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                                    📚 Ver Documentação da API
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Placeholder para outras páginas */}
                            {currentPage !== 'admin-dashboard' && currentPage !== 'admin-users' && currentPage !== 'admin-branding' && currentPage !== 'admin-lgpd' && currentPage !== 'admin-messaging' && (
                                <div className="bg-card rounded-xl shadow-sm border border-slate-200 p-8 text-center">
                                    <h2 className="text-2xl font-bold text-slate-900 mb-4">
                                        {currentPage === 'admin-messaging' && '📱 APIs & Configuração de Mensageria'}
                                        {currentPage === 'admin-lgpd' && '📄 Editor de Termos LGPD'}
                                        {currentPage === 'admin-reports' && '📈 Relatórios Gerenciais'}
                                    </h2>
                                    <p className="text-slate-600 mb-6">
                                        Esta seção está sendo implementada com todas as funcionalidades administrativas.
                                    </p>
                                    <div className="text-sm text-slate-500">
                                        🚧 Em desenvolvimento - Em breve disponível
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                );
            }

            // Outras páginas em desenvolvimento
            const content = (
                <div className="min-h-screen bg-secondary">
                    <Navigation />
                    <main className={`max-w-7xl mx-auto py-8 px-4 ${pageTransition ? 'opacity-50' : 'page-transition'}`}>
                        <div className="bg-card text-card-foreground rounded-xl shadow-modern border border-border card-hover p-8 text-center">
                            <h2 className="text-2xl font-bold text-card-foreground mb-4">
                                Página: {currentPage}
                            </h2>
                            <p className="text-muted-foreground mb-6">
                                Esta página será implementada em breve com todas as funcionalidades.
                            </p>
                            <button 
                                onClick={() => {
                                    setPageTransition(true);
                                    setTimeout(() => {
                                        setCurrentPage('dashboard');
                                        setPageTransition(false);
                                    }, 150);
                                }}
                                className="btn-primary px-6 py-3"
                            >
                                Voltar ao Dashboard
                            </button>
                        </div>
                    </main>
                </div>
            );

            // Modal React removido - agora usando modal HTML puro que funciona corretamente

            return (
                <>
                    {content}
                    
                    {/* Global Loading Overlay */}
                    {globalLoading && (
                        <div className="loading-overlay">
                            <div className="text-center">
                                <div className="loading-spinner mx-auto mb-4"></div>
                                <p className="text-muted-foreground">Carregando...</p>
                            </div>
                        </div>
                    )}
                    
                    
                    {/* Toast Notifications */}
                    <div className="toast">
                        {toasts.map(toast => (
                            <div 
                                key={toast.id}
                                className={`mb-2 p-4 rounded-lg shadow-lg border ${
                                    toast.type === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
                                    toast.type === 'error' ? 'bg-red-50 border-red-200 text-red-800' :
                                    toast.type === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
                                    'bg-blue-50 border-blue-200 text-blue-800'
                                } animate-in fade-in duration-300`}
                            >
                                <div className="flex items-center justify-between">
                                    <p className="text-sm font-medium">{toast.message}</p>
                                    <button 
                                        onClick={() => setToasts(prev => prev.filter(t => t.id !== toast.id))}
                                        className="ml-2 text-muted-foreground hover:text-muted-foreground"
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            );
        }

        // Initialize React app with proper loading checks
        function initializeApp() {
            const rootElement = document.getElementById('root');
            
            // Check if root element exists
            if (!rootElement) {
                console.error('Root element not found. Retrying in 100ms...');
                setTimeout(initializeApp, 100);
                return;
            }
            
            // Check if app is already rendered
            if (rootElement.hasChildNodes()) {
                console.log('App already rendered, skipping initialization');
                return;
            }
            
            // Check if ReactDOM is available
            if (typeof ReactDOM === 'undefined') {
                console.error('ReactDOM not available. Retrying in 100ms...');
                setTimeout(initializeApp, 100);
                return;
            }
            
            try {
                ReactDOM.render(<App />, rootElement);
                console.log('React app successfully initialized');
            } catch (error) {
                console.error('Error initializing React app:', error);
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already ready
            initializeApp();
        }
    </script>
    
    <!-- Groups Management Modal HTML -->
    <div id="groupsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div style="background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 70rem; width: 100%; margin: 0 1rem; max-height: 90vh; overflow-y: auto;">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: between; align-items: center;">
                    <h3 style="font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">Gestão de Grupos & Permissões</h3>
                    <button onclick="closeGroupsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">×</button>
                </div>
                
                <div style="padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h4 style="font-weight: 600; color: #111827; margin: 0;">Grupos do Sistema</h4>
                            <p style="color: #666; font-size: 0.875rem; margin: 0.25rem 0 0 0;">Gerencie grupos de usuários e suas permissões</p>
                        </div>
                        <button onclick="openCreateGroupForm()" style="background: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; font-weight: 500; cursor: pointer;">
                            + Novo Grupo
                        </button>
                    </div>
                    
                    <div id="groupsList" style="space-y: 1rem;">
                        <!-- Groups will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Group Modal HTML -->
    <div id="groupFormModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div style="background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 48rem; width: 100%; margin: 0 1rem; max-height: 90vh; overflow-y: auto;">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="groupFormTitle" style="font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">Novo Grupo</h3>
                    <button onclick="closeGroupFormModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">×</button>
                </div>
                
                <div style="padding: 1.5rem;">
                    <form id="groupForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    Nome do Grupo <span style="color: #ef4444;">*</span>
                                </label>
                                <input id="groupName" type="text" placeholder="Ex: Administradores" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    Código do Grupo <span style="color: #ef4444;">*</span>
                                </label>
                                <input id="groupCode" type="text" placeholder="Ex: admin" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                Descrição
                            </label>
                            <textarea id="groupDescription" rows="3" placeholder="Descreva as responsabilidades deste grupo..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 1rem;">
                                Permissões do Grupo
                            </label>
                            <div id="groupPermissions" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <!-- Permissions checkboxes will be populated here -->
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center;">
                                <input id="groupActive" type="checkbox" checked style="margin-right: 0.5rem;">
                                <span style="font-size: 0.875rem; color: #374151;">Grupo ativo</span>
                            </label>
                        </div>
                    </form>
                </div>
                
                <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button onclick="closeGroupFormModal()" style="padding: 0.5rem 1rem; color: #6b7280; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.5rem; font-weight: 500; cursor: pointer;">
                        Cancelar
                    </button>
                    <button id="groupSubmitBtn" onclick="submitGroupForm()" style="background: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; font-weight: 500; cursor: pointer;">
                        Criar Grupo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal HTML -->
    <div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div style="background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 48rem; width: 100%; margin: 0 1rem; max-height: 90vh; overflow-y: auto;">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h3 id="userModalTitle" style="font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">Novo Usuário</h3>
                </div>
                
                <div style="padding: 1.5rem;">
                    <form id="userForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    Nome Completo <span style="color: #ef4444;">*</span>
                                </label>
                                <input id="userName" type="text" placeholder="Digite o nome completo" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    Email <span style="color: #ef4444;">*</span>
                                </label>
                                <input id="userEmail" type="email" placeholder="usuario@email.com" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    CPF <span style="color: #ef4444;">*</span>
                                </label>
                                <input id="userCpf" type="text" placeholder="000.000.000-00" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    Telefone
                                </label>
                                <input id="userPhone" type="tel" placeholder="(11) 99999-9999" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    Data de Nascimento
                                </label>
                                <input id="userBirthDate" type="date" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                    Grupo/Função
                                </label>
                                <select id="userGroup" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                                    <option value="paciente">Paciente</option>
                                    <option value="medico">Médico</option>
                                    <option value="recepcao">Recepção</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center;">
                                <input id="userActive" type="checkbox" checked style="margin-right: 0.5rem;">
                                <span style="font-size: 0.875rem; color: #374151;">Usuário ativo (pode fazer login)</span>
                            </label>
                        </div>
                    </form>
                </div>
                
                <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button onclick="closeUserModal()" style="padding: 0.5rem 1rem; color: #6b7280; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.5rem; font-weight: 500; cursor: pointer;">
                        Cancelar
                    </button>
                    <button id="userSubmitBtn" onclick="submitUserForm()" style="background: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; font-weight: 500; cursor: pointer;">
                        Criar Usuário
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal HTML -->
    <div id="shareModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div style="background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 32rem; width: 100%; margin: 0 1rem;">
            <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <h3 style="font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">Compartilhar Exame com Médico</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0 0;">
                    Preencha os dados do médico para gerar um link de acesso seguro ao resultado do exame.
                </p>
            </div>
            
            <div style="padding: 1.5rem; background-color: #dbeafe; border-bottom: 1px solid #e5e7eb;">
                <h4 style="font-weight: 600; color: #1e3a8a; text-transform: uppercase; font-size: 0.875rem; margin: 0;">
                    EMOGRAMA
                </h4>
                <div style="font-size: 0.875rem; color: #1e40af; margin-top: 0.25rem;">
                    <p style="margin: 0;">Realizado em: 15/05/2019</p>
                    <p style="margin: 0;">Unidade: Unidade Paulista</p>
                    <p style="margin: 0;">Exam ID: <span id="shareExamId">-</span></p>
                </div>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                            CRM do Médico <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" placeholder="000000/SP" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                            Nome do Médico <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" placeholder="Dr. João Silva" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                        E-mail do Médico <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="email" placeholder="medico@hospital.com.br" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                        Mensagem (opcional)
                    </label>
                    <textarea rows="4" placeholder="Adicione uma mensagem para o médico..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 0.75rem; background-color: #fefce8; border: 1px solid #fde047; border-radius: 0.5rem;">
                    <div style="display: flex; align-items: flex-start;">
                        <svg style="width: 1.25rem; height: 1.25rem; color: #ca8a04; margin-top: 0.125rem; margin-right: 0.5rem; flex-shrink: 0;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            <p style="font-size: 0.875rem; font-weight: 500; color: #92400e; margin: 0;">Importante:</p>
                            <p style="font-size: 0.875rem; color: #a16207; margin: 0;">
                                O link de acesso será válido por 30 dias. O médico receberá um e-mail com as instruções de acesso.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button onclick="document.getElementById('shareModal').style.display = 'none'" style="padding: 0.5rem 1.5rem; color: #6b7280; background: none; border: none; font-weight: 500; cursor: pointer;">
                    Cancelar
                </button>
                <button onclick="shareExamFromModal()" style="background: #2563eb; color: white; padding: 0.5rem 1.5rem; border-radius: 0.5rem; border: none; font-weight: 500; cursor: pointer;">
                    Compartilhar Exame
                </button>
            </div>
        </div>
        </div>
    </div>

    <!-- Delegation Modal HTML -->
    <div id="delegationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div style="background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 28rem; width: 100%; margin: 0 1rem;">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0;">Nova Delegação Médica</h3>
                </div>
                
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                            CRM do Médico
                        </label>
                        <input id="delegationCrm" type="text" placeholder="123456/SP" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                            Nome do Médico
                        </label>
                        <input id="delegationName" type="text" placeholder="Dr. Maria Silva" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                            Especialidade
                        </label>
                        <input id="delegationSpecialty" type="text" placeholder="Cardiologia" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                            Período
                        </label>
                        <select id="delegationPeriod" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                            <option value="">Selecione o período</option>
                            <option value="30">30 dias</option>
                            <option value="60">60 dias</option>
                            <option value="90">90 dias</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                </div>
                
                <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button onclick="document.getElementById('delegationModal').style.display = 'none'" style="padding: 0.5rem 1rem; color: #6b7280; background: none; border: none; font-weight: 500; cursor: pointer;">
                        Cancelar
                    </button>
                    <button onclick="createDelegationFromModal()" style="background: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; font-weight: 500; cursor: pointer;">
                        Criar Delegação
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal HTML -->
    <div id="uploadModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div style="background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 28rem; width: 100%; margin: 0 1rem;">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0;">Upload de Arquivo</h3>
                </div>
                
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                            Selecione o arquivo
                        </label>
                        <input id="uploadFile" type="file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="handleFileUpload(this)" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none;">
                    </div>
                    
                    <div id="uploadProgress" style="display: none; width: 100%; background-color: #f3f4f6; border-radius: 9999px; height: 0.5rem; margin-top: 1rem;">
                        <div id="uploadProgressBar" style="background-color: #2563eb; height: 0.5rem; border-radius: 9999px; transition: width 0.3s; width: 0%;"></div>
                    </div>
                </div>
                
                <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end;">
                    <button onclick="document.getElementById('uploadModal').style.display = 'none'; document.getElementById('uploadFile').value = ''; document.getElementById('uploadProgress').style.display = 'none';" style="padding: 0.5rem 1rem; color: #6b7280; background: none; border: none; font-weight: 500; cursor: pointer;">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Função para compartilhar exame via modal HTML
        function shareExamFromModal() {
            const crm = document.querySelector('#shareModal input[placeholder="000000/SP"]').value;
            const name = document.querySelector('#shareModal input[placeholder="Dr. João Silva"]').value;
            const email = document.querySelector('#shareModal input[placeholder="medico@hospital.com.br"]').value;
            const message = document.querySelector('#shareModal textarea').value;
            const examId = document.getElementById('shareExamId').textContent;
            
            if (!crm || !name || !email) {
                alert('Por favor, preencha todos os campos obrigatórios (CRM, Nome e E-mail)');
                return;
            }
            
            // Validação básica de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Por favor, insira um e-mail válido');
                return;
            }
            
            // Busca o exame pelos dados existentes
            const exam = (window.globalExamsData || []).find(e => e.id == examId) || { 
                id: examId, 
                exam_type: 'EMOGRAMA', 
                exam_date: '2019-05-15' 
            };
            
            // Cria novo compartilhamento
            const newShare = {
                id: Date.now(),
                examId: examId,
                examType: exam.exam_type,
                examDate: exam.exam_date,
                doctorName: name,
                doctorCrm: crm,
                doctorEmail: email,
                message: message,
                sharedAt: new Date().toISOString(),
                status: 'active',
                accessCount: 0,
                expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 dias
            };
            
            // Adiciona à lista global de compartilhamentos
            if (!window.sharedExamsList) {
                window.sharedExamsList = [];
            }
            window.sharedExamsList.push(newShare);
            
            // Dispara evento para atualizar React
            window.dispatchEvent(new CustomEvent('sharedExamsUpdated', { 
                detail: { newShare } 
            }));
            
            // Enviar email de notificação de forma assíncrona
            setTimeout(async () => {
                try {
                    // Acessa a função sendShareEmail do escopo React
                    if (window.sendShareEmail) {
                        const emailResult = await window.sendShareEmail(newShare);
                        if (emailResult.success) {
                            console.log('Email enviado com sucesso:', emailResult.message);
                        } else {
                            console.error('Erro no envio do email:', emailResult.message);
                        }
                    } else {
                        console.log('Sistema de email ainda não configurado - dados salvos:', newShare);
                    }
                } catch (error) {
                    console.error('Erro ao processar envio de email:', error);
                }
            }, 100);
            
            alert(`Exame compartilhado com sucesso!\nMédico: ${name}\nE-mail: ${email}\nVálido por 30 dias\n\n📧 Email de notificação será enviado em breve.`);
            
            // Limpa o formulário e fecha o modal
            document.querySelector('#shareModal input[placeholder="000000/SP"]').value = '';
            document.querySelector('#shareModal input[placeholder="Dr. João Silva"]').value = '';
            document.querySelector('#shareModal input[placeholder="medico@hospital.com.br"]').value = '';
            document.querySelector('#shareModal textarea').value = '';
            document.getElementById('shareModal').style.display = 'none';
        }

        // Função para criar delegação via modal HTML
        function createDelegationFromModal() {
            const crm = document.getElementById('delegationCrm').value;
            const name = document.getElementById('delegationName').value;
            const specialty = document.getElementById('delegationSpecialty').value;
            const period = document.getElementById('delegationPeriod').value;
            
            if (!crm || !name || !specialty || !period) {
                alert('Por favor, preencha todos os campos');
                return;
            }
            
            // Simula criação da delegação
            alert(`Delegação criada com sucesso!\nMédico: ${name}\nCRM: ${crm}\nEspecialidade: ${specialty}\nPeríodo: ${period} dias`);
            
            // Limpa o formulário e fecha o modal
            document.getElementById('delegationCrm').value = '';
            document.getElementById('delegationName').value = '';
            document.getElementById('delegationSpecialty').value = '';
            document.getElementById('delegationPeriod').value = '';
            document.getElementById('delegationModal').style.display = 'none';
        }
        
        // Função para lidar com upload de arquivo
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Mostra a barra de progresso
            document.getElementById('uploadProgress').style.display = 'block';
            const progressBar = document.getElementById('uploadProgressBar');
            
            // Simula upload com progresso
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        alert(`Arquivo "${file.name}" enviado com sucesso!`);
                        document.getElementById('uploadModal').style.display = 'none';
                        document.getElementById('uploadFile').value = '';
                        document.getElementById('uploadProgress').style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 500);
                }
            }, 200);
        }

        // Variáveis globais para controlar edição
        let editingUserId = null;
        let editingGroupId = null;

        // Sistema de permissões completo
        const systemPermissions = {
            'users_view': { name: 'Visualizar Usuários', category: 'Usuários' },
            'users_create': { name: 'Criar Usuários', category: 'Usuários' },
            'users_edit': { name: 'Editar Usuários', category: 'Usuários' },
            'users_delete': { name: 'Excluir Usuários', category: 'Usuários' },
            'users_manage_permissions': { name: 'Gerenciar Permissões', category: 'Usuários' },
            
            'exams_view': { name: 'Visualizar Exames', category: 'Exames' },
            'exams_create': { name: 'Criar Exames', category: 'Exames' },
            'exams_edit': { name: 'Editar Exames', category: 'Exames' },
            'exams_delete': { name: 'Excluir Exames', category: 'Exames' },
            'exams_share': { name: 'Compartilhar Exames', category: 'Exames' },
            'exams_download': { name: 'Download de Exames', category: 'Exames' },
            
            'reports_view': { name: 'Visualizar Relatórios', category: 'Relatórios' },
            'reports_export': { name: 'Exportar Relatórios', category: 'Relatórios' },
            'reports_advanced': { name: 'Relatórios Avançados', category: 'Relatórios' },
            
            'system_settings': { name: 'Configurações do Sistema', category: 'Sistema' },
            'system_branding': { name: 'Configurações de Marca', category: 'Sistema' },
            'system_backup': { name: 'Backup do Sistema', category: 'Sistema' },
            'system_logs': { name: 'Logs do Sistema', category: 'Sistema' },
            
            'admin_full': { name: 'Acesso Administrativo Total', category: 'Administração' }
        };

        // Grupos padrão do sistema com permissões
        let systemGroups = [
            {
                id: 1,
                name: 'Administradores',
                code: 'admin',
                description: 'Acesso total ao sistema, incluindo configurações e gestão de usuários',
                permissions: Object.keys(systemPermissions),
                active: true,
                userCount: 2,
                color: '#dc2626'
            },
            {
                id: 2,
                name: 'Médicos',
                code: 'medico',
                description: 'Visualização de exames, criação de laudos e compartilhamento com pacientes',
                permissions: ['exams_view', 'exams_create', 'exams_edit', 'exams_share', 'exams_download', 'reports_view'],
                active: true,
                userCount: 15,
                color: '#2563eb'
            },
            {
                id: 3,
                name: 'Pacientes',
                code: 'paciente',
                description: 'Acesso aos próprios exames e resultados',
                permissions: ['exams_view', 'exams_download'],
                active: true,
                userCount: 1198,
                color: '#7c3aed'
            },
            {
                id: 4,
                name: 'Recepção',
                code: 'recepcao',
                description: 'Atendimento, cadastros e agendamentos',
                permissions: ['users_view', 'users_create', 'users_edit', 'exams_view', 'exams_create'],
                active: true,
                userCount: 8,
                color: '#ea580c'
            }
        ];

        // Função para abrir modal de usuário (novo)
        function openNewUserModal() {
            console.log('Abrindo modal para novo usuário');
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Novo Usuário';
            document.getElementById('userSubmitBtn').textContent = 'Criar Usuário';
            
            // Limpar formulário
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userCpf').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userBirthDate').value = '';
            document.getElementById('userGroup').value = 'paciente';
            document.getElementById('userActive').checked = true;
            
            document.getElementById('userModal').style.display = 'block';
        }

        // Função para abrir modal de usuário (editar)
        function openEditUserModal(userData) {
            console.log('Abrindo modal para editar usuário:', userData);
            editingUserId = userData.id;
            document.getElementById('userModalTitle').textContent = 'Editar Usuário';
            document.getElementById('userSubmitBtn').textContent = 'Salvar Alterações';
            
            // Preencher formulário
            document.getElementById('userName').value = userData.nome || '';
            document.getElementById('userEmail').value = userData.email || '';
            document.getElementById('userCpf').value = userData.cpf || '';
            document.getElementById('userPhone').value = userData.telefone || '';
            document.getElementById('userBirthDate').value = userData.data_nascimento || '';
            document.getElementById('userGroup').value = userData.grupo || 'paciente';
            document.getElementById('userActive').checked = userData.ativo !== false;
            
            document.getElementById('userModal').style.display = 'block';
        }

        // Função para fechar modal de usuário
        function closeUserModal() {
            console.log('Fechando modal de usuário');
            document.getElementById('userModal').style.display = 'none';
            editingUserId = null;
        }

        // Função para submeter formulário de usuário
        function submitUserForm() {
            console.log('Submetendo formulário de usuário');
            
            const nome = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const cpf = document.getElementById('userCpf').value;
            const telefone = document.getElementById('userPhone').value;
            const data_nascimento = document.getElementById('userBirthDate').value;
            const grupo = document.getElementById('userGroup').value;
            const ativo = document.getElementById('userActive').checked;
            
            // Validação básica
            if (!nome || !email || !cpf) {
                alert('Por favor, preencha todos os campos obrigatórios (Nome, Email e CPF)');
                return;
            }
            
            const userData = {
                id: editingUserId || Date.now(),
                nome,
                email,
                cpf,
                telefone,
                data_nascimento,
                grupo,
                ativo,
                ultimo_login: editingUserId ? null : null,
                tentativas_login: 0,
                bloqueado_ate: null,
                criado_em: editingUserId ? null : new Date().toISOString()
            };
            
            // Simular salvamento
            if (editingUserId) {
                // Disparar evento personalizado para edição
                window.dispatchEvent(new CustomEvent('userUpdated', { 
                    detail: { userData, isEdit: true } 
                }));
                alert('Usuário atualizado com sucesso!');
            } else {
                // Disparar evento personalizado para criação
                window.dispatchEvent(new CustomEvent('userCreated', { 
                    detail: { userData, isEdit: false } 
                }));
                alert('Usuário criado com sucesso!');
            }
            
            closeUserModal();
        }

        // Função para salvar configurações do hospital (HTML)
        function saveHospitalSettingsHTML() {
            console.log('Salvando configurações do hospital via HTML');
            
            // Simular salvamento
            setTimeout(() => {
                alert('Configurações salvas com sucesso!');
            }, 500);
            
            // Disparar evento para React
            window.dispatchEvent(new CustomEvent('hospitalSettingsSaved', { 
                detail: { message: 'Configurações salvas via HTML' } 
            }));
        }

        // ===== FUNÇÕES DE GERENCIAMENTO DE GRUPOS =====

        // Função para abrir modal de grupos
        function openGroupsModal() {
            console.log('Abrindo modal de grupos');
            renderGroupsList();
            document.getElementById('groupsModal').style.display = 'block';
        }

        // Função para fechar modal de grupos
        function closeGroupsModal() {
            console.log('Fechando modal de grupos');
            document.getElementById('groupsModal').style.display = 'none';
        }

        // Função para renderizar lista de grupos
        function renderGroupsList() {
            console.log('Renderizando lista de grupos');
            const groupsContainer = document.getElementById('groupsList');
            
            if (!groupsContainer) {
                console.error('Container de grupos não encontrado');
                return;
            }

            let groupsHTML = '';
            
            systemGroups.forEach(group => {
                const statusBadge = group.active ? 
                    '<span class="bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 text-xs font-semibold px-2 py-1 rounded-full">Ativo</span>' :
                    '<span class="bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300 text-xs font-semibold px-2 py-1 rounded-full">Inativo</span>';
                
                groupsHTML += `
                    <div class="border border-border rounded-lg p-4 bg-card hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${group.color}"></div>
                                <div>
                                    <h4 class="font-semibold text-card-foreground">${group.name}</h4>
                                    <p class="text-sm text-muted-foreground">${group.description}</p>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-muted-foreground">${group.userCount} usuários • ${group.permissions.length} permissões</span>
                            <div class="flex space-x-2">
                                <button 
                                    onclick="openEditGroupForm(${group.id})"
                                    class="px-3 py-1 bg-blue-100 dark:bg-blue-900/20 text-blue-800 rounded hover:bg-blue-200 transition-colors"
                                >
                                    Editar
                                </button>
                                <button 
                                    onclick="toggleGroupStatus(${group.id})"
                                    class="px-3 py-1 ${group.active ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300 hover:bg-red-200' : 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 hover:bg-green-200'} rounded transition-colors"
                                >
                                    ${group.active ? 'Desativar' : 'Ativar'}
                                </button>
                                ${group.code !== 'admin' ? `
                                    <button 
                                        onclick="deleteGroup(${group.id})"
                                        class="px-3 py-1 bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300 rounded hover:bg-red-200 transition-colors"
                                    >
                                        Excluir
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            groupsContainer.innerHTML = groupsHTML;
        }

        // Função para abrir formulário de criação de grupo
        function openCreateGroupForm() {
            console.log('Abrindo formulário para novo grupo');
            editingGroupId = null;
            document.getElementById('groupFormTitle').textContent = 'Novo Grupo';
            document.getElementById('groupSubmitBtn').textContent = 'Criar Grupo';
            
            // Limpar formulário
            document.getElementById('groupName').value = '';
            document.getElementById('groupCode').value = '';
            document.getElementById('groupDescription').value = '';
            document.getElementById('groupColor').value = '#2563eb';
            document.getElementById('groupActive').checked = true;
            
            // Renderizar permissões
            renderPermissionsList([]);
            
            document.getElementById('groupFormModal').style.display = 'block';
        }

        // Função para abrir formulário de edição de grupo
        function openEditGroupForm(groupId) {
            console.log('Abrindo formulário para editar grupo:', groupId);
            const group = systemGroups.find(g => g.id === groupId);
            
            if (!group) {
                alert('Grupo não encontrado');
                return;
            }
            
            editingGroupId = groupId;
            document.getElementById('groupFormTitle').textContent = 'Editar Grupo';
            document.getElementById('groupSubmitBtn').textContent = 'Salvar Alterações';
            
            // Preencher formulário
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupCode').value = group.code;
            document.getElementById('groupDescription').value = group.description;
            document.getElementById('groupColor').value = group.color;
            document.getElementById('groupActive').checked = group.active;
            
            // Renderizar permissões com seleções do grupo
            renderPermissionsList(group.permissions);
            
            document.getElementById('groupFormModal').style.display = 'block';
        }

        // Função para fechar formulário de grupo
        function closeGroupFormModal() {
            console.log('Fechando formulário de grupo');
            document.getElementById('groupFormModal').style.display = 'none';
            editingGroupId = null;
        }

        // Função para renderizar lista de permissões
        function renderPermissionsList(selectedPermissions = []) {
            console.log('Renderizando lista de permissões');
            const permissionsContainer = document.getElementById('groupPermissions');
            
            if (!permissionsContainer) {
                console.error('Container de permissões não encontrado');
                return;
            }

            // Agrupar permissões por categoria
            const categorizedPermissions = {};
            Object.entries(systemPermissions).forEach(([key, permission]) => {
                if (!categorizedPermissions[permission.category]) {
                    categorizedPermissions[permission.category] = [];
                }
                categorizedPermissions[permission.category].push({ key, ...permission });
            });

            let permissionsHTML = '';
            
            Object.entries(categorizedPermissions).forEach(([category, permissions]) => {
                permissionsHTML += `
                    <div class="mb-6">
                        <h4 class="font-medium text-card-foreground mb-3">${category}</h4>
                        <div class="space-y-2">
                `;
                
                permissions.forEach(permission => {
                    const isChecked = selectedPermissions.includes(permission.key);
                    permissionsHTML += `
                        <label class="flex items-center space-x-3 p-2 hover:bg-secondary rounded cursor-pointer">
                            <input 
                                type="checkbox" 
                                name="permissions[]" 
                                value="${permission.key}"
                                ${isChecked ? 'checked' : ''}
                                class="rounded border-gray-300 text-primary focus:ring-blue-500"
                            >
                            <span class="text-sm text-card-foreground">${permission.name}</span>
                        </label>
                    `;
                });
                
                permissionsHTML += `
                        </div>
                    </div>
                `;
            });
            
            permissionsContainer.innerHTML = permissionsHTML;
        }

        // Função para submeter formulário de grupo
        function submitGroupForm() {
            console.log('Submetendo formulário de grupo');
            
            const name = document.getElementById('groupName').value;
            const code = document.getElementById('groupCode').value;
            const description = document.getElementById('groupDescription').value;
            const color = document.getElementById('groupColor').value;
            const active = document.getElementById('groupActive').checked;
            
            // Coletar permissões selecionadas
            const selectedPermissions = [];
            document.querySelectorAll('input[name="permissions[]"]:checked').forEach(checkbox => {
                selectedPermissions.push(checkbox.value);
            });
            
            // Validação básica
            if (!name || !code || !description) {
                alert('Por favor, preencha todos os campos obrigatórios');
                return;
            }
            
            if (selectedPermissions.length === 0) {
                alert('Por favor, selecione pelo menos uma permissão');
                return;
            }
            
            // Verificar se código já existe (exceto para edição do mesmo grupo)
            const existingGroup = systemGroups.find(g => g.code === code && g.id !== editingGroupId);
            if (existingGroup) {
                alert('Já existe um grupo com este código');
                return;
            }
            
            const groupData = {
                id: editingGroupId || Date.now(),
                name,
                code,
                description,
                color,
                active,
                permissions: selectedPermissions,
                userCount: editingGroupId ? systemGroups.find(g => g.id === editingGroupId).userCount : 0
            };
            
            // Atualizar ou criar grupo
            if (editingGroupId) {
                const groupIndex = systemGroups.findIndex(g => g.id === editingGroupId);
                if (groupIndex !== -1) {
                    systemGroups[groupIndex] = { ...systemGroups[groupIndex], ...groupData };
                    alert('Grupo atualizado com sucesso!');
                }
            } else {
                systemGroups.push(groupData);
                alert('Grupo criado com sucesso!');
            }
            
            // Atualizar lista e fechar modal
            renderGroupsList();
            closeGroupFormModal();
            
            // Disparar evento personalizado
            window.dispatchEvent(new CustomEvent('groupUpdated', { 
                detail: { groupData, isEdit: !!editingGroupId } 
            }));
        }

        // Função para alternar status do grupo
        function toggleGroupStatus(groupId) {
            console.log('Alternando status do grupo:', groupId);
            const group = systemGroups.find(g => g.id === groupId);
            
            if (!group) {
                alert('Grupo não encontrado');
                return;
            }
            
            if (group.code === 'admin') {
                alert('O grupo de Administradores não pode ser desativado');
                return;
            }
            
            const action = group.active ? 'desativar' : 'ativar';
            if (confirm(`Tem certeza que deseja ${action} o grupo "${group.name}"?`)) {
                group.active = !group.active;
                renderGroupsList();
                alert(`Grupo ${group.active ? 'ativado' : 'desativado'} com sucesso!`);
                
                // Disparar evento personalizado
                window.dispatchEvent(new CustomEvent('groupStatusChanged', { 
                    detail: { groupId, active: group.active } 
                }));
            }
        }

        // Função para excluir grupo
        function deleteGroup(groupId) {
            console.log('Excluindo grupo:', groupId);
            const group = systemGroups.find(g => g.id === groupId);
            
            if (!group) {
                alert('Grupo não encontrado');
                return;
            }
            
            if (group.code === 'admin') {
                alert('O grupo de Administradores não pode ser excluído');
                return;
            }
            
            if (group.userCount > 0) {
                alert(`Não é possível excluir o grupo "${group.name}" pois existem ${group.userCount} usuários vinculados a ele`);
                return;
            }
            
            if (confirm(`Tem certeza que deseja excluir o grupo "${group.name}"? Esta ação não pode ser desfeita.`)) {
                const groupIndex = systemGroups.findIndex(g => g.id === groupId);
                if (groupIndex !== -1) {
                    systemGroups.splice(groupIndex, 1);
                    renderGroupsList();
                    alert('Grupo excluído com sucesso!');
                    
                    // Disparar evento personalizado
                    window.dispatchEvent(new CustomEvent('groupDeleted', { 
                        detail: { groupId } 
                    }));
                }
            }
        }

        // ===== FUNÇÕES LGPD =====

        // Função para renderizar markdown (simples)
        function renderMarkdown(markdown) {
            if (!markdown) return '';
            
            return markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-6 mb-3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-8 mb-4">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-8 mb-6">$1</h1>')
                // Bold and italic
                .replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold">$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em class="italic">$1</em>')
                // Lists
                .replace(/^- (.*$)/gim, '<li class="ml-4">• $1</li>')
                // Paragraphs
                .replace(/\n\n/g, '</p><p class="mb-4">')
                .replace(/^(?!<[hl]|<li)(.+)$/gm, '<p class="mb-4">$1</p>')
                // Clean up
                .replace(/<p class="mb-4"><\/p>/g, '')
                .replace(/<li class="ml-4">• ([^<]+)<\/p>/g, '<li class="ml-4">• $1</li>');
        }

        // Função para salvar termos LGPD
        function saveLGPDTerms() {
            console.log('Salvando termos LGPD');
            
            const termsData = {
                content: lgpdTermsContent,
                version: lgpdTermsVersion,
                effectiveDate: lgpdEffectiveDate,
                forceAcceptance: lgpdForceAcceptance,
                showOnFirstLogin: lgpdShowOnFirstLogin,
                allowDownload: lgpdAllowDownload,
                updatedAt: new Date().toISOString()
            };
            
            // Simular salvamento
            try {
                localStorage.setItem('lgpdTerms', JSON.stringify(termsData));
                alert('✅ Termos LGPD salvos com sucesso!\n\nAs alterações entrarão em vigor na próxima vez que os usuários fizerem login.');
                
                // Disparar evento personalizado
                window.dispatchEvent(new CustomEvent('lgpdTermsUpdated', { 
                    detail: termsData
                }));
                
                console.log('Termos LGPD salvos:', termsData);
            } catch (error) {
                console.error('Erro ao salvar termos LGPD:', error);
                alert('❌ Erro ao salvar os termos. Tente novamente.');
            }
        }

        // Função para carregar termos LGPD salvos
        function loadLGPDTerms() {
            try {
                const savedTerms = localStorage.getItem('lgpdTerms');
                if (savedTerms) {
                    const termsData = JSON.parse(savedTerms);
                    console.log('Termos LGPD carregados:', termsData);
                    
                    // Atualizar estados React via eventos customizados
                    window.dispatchEvent(new CustomEvent('loadLgpdTerms', { 
                        detail: termsData
                    }));
                }
            } catch (error) {
                console.error('Erro ao carregar termos LGPD:', error);
            }
        }
    </script>
</body>
</html>